<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="Content-Language" content="es" >
    <meta name="generator" content="Emacs">
    <title>Introducción al lenguaje de programación Javascript</title>
    <meta name="AUTHOR" content="Juan Julián Merelo Guervós">
    <meta name="keywords" content="Computación distribuida, computación paralela, p2p, overlay, grid, evaluación de prestaciones, javascript, nodejs">
    <meta name="description" content="Introducción rápida al lenguaje Javascript">
  <link href='http://fonts.googleapis.com/css?family=Arvo|Source+Code+Pro' rel='stylesheet' type='text/css'>
  <style type="text/css" media="all">
body { font-family: 'Arvo', serif; }

code.ejemplo {
  font-size:medium;
  white-space:pre;	
  display: block;
  padding: 2pt;
  background-color: lightYellow;
  color: darkBlue;
  border-style: double;
  border-color: #000080;
  border-width: 2pt;  font-family:  'Source Code Pro', Courier New, Courier;
  text-indent: 0%;
  margin-right: 5%;
  margin-left: 5%;
}

/* Style definition file generated by highlight 3.8, http://www.andre-simon.de/ */

/* Highlighting theme: Kwrite Editor */

body.hl	{ background-color:#e0eaee; }
pre.hl	{ color:#000000; background-color:#e0eaee; font-size:10pt; font-family:'Courier New';}
.hl.num { color:#b07e00; }
.hl.esc { color:#ff00ff; }
.hl.str { color:#bf0303; }
.hl.pps { color:#818100; }
.hl.slc { color:#838183; font-style:italic; }
.hl.com { color:#838183; font-style:italic; }
.hl.ppc { color:#008200; }
.hl.opt { color:#000000; }
.hl.lin { color:#555555; }
.hl.kwa { color:#000000; font-weight:bold; }
.hl.kwb { color:#0057ae; }
.hl.kwc { color:#000000; font-weight:bold; }
.hl.kwd { color:#010181; }

div.aclara {
padding: 10px;
margin: 10px;
background-color:lightGray;
}
  </style></head>
<body>


<h1>Introducción al lenguaje de programación JavaScript</h1>

<h2>¿JavaScript? Pero si es muy fácil</h2>

<div class='objetivos'> <ul>
	  
	  <li>Aprender qué es JavaScript</li> 

	  <li>Aprender la sintaxis de JavaScript</li> 

	  <li>Usar objetos y clases en JavaScript</li>
	  
	  <li>Realizar un pequeño ejemplo en JavaScript</li>

      </ul>
</div>  

<p>Fuera de ser solamente un lenguaje para el navegador, <a href='http://es.wikipedia.org/wiki/JavaScript'>JavaScript</a>  tiene una ventaja frente a otros lenguajes
      de programación Está <em>en todas 
      partes</em>. No hay ordenador sin navegador, ni hay navegador sin
      JavaScript. Se puede ejecutar
      hasta en el navegador Opera que viene con la Wii; desde la
      madurez de <a href='http://nodejs.org'>node.js</a>, es el único
      lenguaje que permite ejecutar aplicaciones en cliente y
      servidor, así que se ha convertido en uno de los lenguajes más
      útiles para desarrollo en Internet.</p>

<p>Esto se debe, en parte a que ha sido definido como un <a href='https://es.wikipedia.org/wiki/ECMAScript'>estándar ECMA (denominado ECMAScript)</a>  lo que da lugar a muchas implementaciones diferentes, que
      son, además, independientes del fabricante. Y, por otro lado,
      también suele usar un conjunto de objetos estándar (que no son
      estrictamente parte de un lenguaje) que se pueden
      usar para añadir funcionalidad a una aplicación. Muchas
      aplicaciones complejas, como <a
	href='http://gmail.com'>GMail</a> o <a
	href='http://drive.google.com'>Google Apps</a> dependen de
      estos objetos para crear aplicaciones en la web que se comporten
      como si se ejecutaran en un sistema operativo nativo; a estas
      aplicaciones se les ha denominado últimamente <em>Rich
    Internet Applications</em>.</p>

<p>Además, a diferencia de otros lenguajes, es muy fácil crear una
      aplicación distribuida, cliente/servidor o MVC con JavaScript. Tanto por su integración
      con el navegador (parte inseparable de la web, una arquitectura
      cliente-servidor) como por los objetos que suele tener el mismo,
      crear una aplicación cliente-servidor es casi trivial y ha dado
      lugar a un estilo de programación denominado <a href='http://es.wikipedia.org/wiki/AJAX'>AJAX</a>, que se
      verá más adelante.</p> 

<p>Para ejecutar JavaScript no hace falta más que un navegador, pero
      también hay entornos para trabajar con él de forma autónoma, tal
      como el <a
	href='https://developer.mozilla.org/en-US/docs/Mozilla/Projects/SpiderMonkey'>Mozilla SpiderMonkey</a> y el <a href='https://developer.mozilla.org/en-US/docs/Rhino'>Rhino</a>, éste último basado en
      Java; <a href='https://developer.mozilla.org/en-US/docs/Web/JavaScript/Shells'>hay
    una lista de intérpretes completa que se puede usar</a>. Conviene instalar alguno de ellos para poder ejecutar los 
      programas de ejemplo; por ejemplo, para instalar el primero
      habrá que ejecutar (desde la consola de administrador o
      superusuario):</p>
<div class='ejemplo'>bash% apt-get install js</div>
<p>(que no funcionará en las últimas versiones de ubuntu, como la 14.04) o</p>
<div class='ejemplo'>bash% apt-get install rhino</div>
<p>o </p>
<div class='ejemplo'>bash% apt-get install libmozjs-24-bin</div>
<p>que instalará Spidermonkey en el fichero <code>js24</code></p>

<p>Hay algunas diferencias entre los intérpretes, sobre todo en
  cualquier función que tenga que ver con la entrada/salida. Conviene
  consultar la página de manual del intérprete para ver cómo se hace
  específicamente en cada caso; en general, los ejemplos que se
  incluyen aquí funcionan correctamente en <code>js</code>
  o <code>rhino</code>.</p>

<p>En cuanto a los navegadores, puede que
      haga falta activar JavaScript para que lo entiendan. Por
      ejemplo, en Firefox hay que activarlo usando Edit ->
      Preferencias -> Contenido -> Activar JavaScript. Normalmente
      está activado por omisión. Por otro lado, veremos ejemplos
      principalmente de programas que se pueden usar desde el
      intérprete, y merece la pena instalarse uno. </p>

<div class='aclara'>Si usas Eclipse, puede que te venga bien el <a
	href='http://www.eclipse.org/webtools/jsdt/'>plugin
	JSDT</a>. Igual al atento lector le funciona
	correctamente. Por otro lado, el <code>emacs</code> va de lujo. NetBeans
	tiene
	también <a href='http://netbeans.org/kb/docs/ide/javascript-editor.html'>soporte
    para JavaScript</a>, simplemente seleccionando este lenguaje para
	un nuevo fichero. El editor detecta la estructura del
	fichero e incluso analiza el código indicando los problemas,
	indentando automáticamente y emparejando paréntesis y llaves. </div> 

<p>En realidad, esa integración con el navegador puede que haya
      estorbado a la aceptación de JS como un lenguaje <em>decente</em>;
      tampoco ha ayudado que la mayoría de las librerías que se hayan
      desarrollado estén relacionadas precisamente con la Web, y no
      tenga una librería decente para, pongamos por caso, acceder a
      bases de datos. Pero también ha permitido que el lenguaje siga
      siendo <em>pequeño</em>, y se haya desarrollado principalmente a base
      de añadir objetos y clases externas al mismo. En resumen, que en
      el marco de eso que se ha venido en llamar <a href='http://es.wikipedia.org/wiki/Web_2.0'>web 2.0</a> JS se
      ha convertido en adulto, y merece la pena estudiarlo como
      cualquier otro lenguaje.</p>

<p>Por último está el <a
	href='http://www.yaldex.com/JSFactory_Pro.htm'>1st JavaScript
	Editor</a>, que es de pago, pero pueden conseguirse versiones
      de evaluación gratuitas. </p> 

<p>Por lo que he probado, SpiderMonkey, Rhino y
      KJSCMD se instalan fácilmente en Ubuntu; no hay más que hacer
      <code>aptitude search javascript</code> (en ubuntu) y salen esos y alguno más. Fedora
      Core es un poco más rácano en cuanto a entornos: aunque los
      puedes instalar bajándote los fuentes y compilando, el que está
      disponible en los repositorios es uno llamado sólo <code>js</code>,
      aparentemente el SpiderMonkey. Para instalarlo, escribir <code>yum install js</code>. El Gnome Shell
      (incluido en la versión 3.0 de Gnome) incluye también un
      intérprete de JavaScript como lenguaje nativo, y con él se
      pueden desarrollar pequeños applets. Este intérprete, que está
      instalado por defecto junto con el entorno, se denomina <code>gjs</code>,
      está basado en SpiderMonkey y tiene la ventaja de que está
      integrado con todas las librerías de Gnome, de forma que se
  pueden hacer programas tales
      como <a href='https://github.com/JJ/curso-js/tree/master/code/g.js'>este,
      que crea una ventana con un botón</a>
      sin necesidad de instalar ningún  módulo adicional. Éste
  intérprete es el que usa desde <code>lg</code> (<em>looking glass</em>), una
      consola de depuración de Gnome al estilo de la consola del
      navegador que se puede ejecutar desde entorno pulsando Alt-F2 y
      escribiendo <code>lg</code>. Finalmente, Windows incluye <a href='http://stackoverflow.com/questions/686377/windows-command-line-javascript'>un programa de
    línea de órdenes denominado <code>cscript</code> y <code>wscript</code></a> que, una vez más, tiene
      ciertas diferencias con respecto al resto de los intérpretes
      (todo lo relacionado con I/O); en realidad se trata de JScript,
      otra implementación del estándar ECMAscript. </p>

  <p>También se puede instalar como cliente y servidor
  JavaScript <a href='http://nodejs.org'>node.js</a>, un procesador
  de bucles de eventos que es también intérprete en JavaScript. Y
    mucho más... </p>


<h3>Primer programa en JavaScript</h3>


<code class='ejemplo'>#!/usr/bin/js
print( 'Hola, Mundo' );</code>

<p>En realidad, el JS es bastante parecido al C, y, para el caso,
      también al Java. Este programa producirá (siempre que lo hagamos
  ejecutable con <code>chmod +x hola.js</code> previamente):
<code class='ejemplo'>jmerelo@vega:~/txt/docencia/AAP/Temario$ ./hola.js
Hola, Mundo</code></p>

<p>Podemos probar con diferentes intérpretes que tengamos
  instalados.</p>
<code class='ejemplo'>jmerelo@penny:~/code$ gjs hola.js 
Hola, Mundo
jmerelo@penny:~/code$ rhino hola.js 
Hola, Mundo
jmerelo@penny:~/code$ js hola.js 
Hola, Mundo
</code>

<p><strong>Ojo</strong>: en node.js habría que
  cambiar <code>print</code> por <code>console.log</code>, o tendremos
  un error. Con <code>kjs</code> habrá que ejecutarlo también
  directamente desde la línea de órdenes; con un fichero da un error
  y no he encontrado ningún manual específico sobre él, así que no
  aconsejo usar esa versión de JS. Por
  otro lado, <a href='https://github.com/JJ/curso-js/tree/master/code/hola-g.js'>este
    programa, <code>hola-g.js</code>, sería equivalente para el
    intérprete <code>gjs</code> que viene con Gnome</a>.</p>


<p>Para ejecutarlo desde el navegador habrá que hacer una poca más de
      historia, pero tampoco tanto. Lo vemos en <a
	href='https://github.com/JJ/curso-js/tree/master/code/hola-js.html'>este ejemplo (darle a ver fuente
	para ver el código)</a> donde se incluye el programa en JS de
      esta forma:</p>
<code class='ejemplo'>&lt;script type='text/javascript' src='hola.js'>&lt;/script></code>

<p>El problema es que, en este caso, la orden <code>print</code> se
      interpreta como impresión por impresora, y habrá que cambiarla
      por otra que signifique lo mismo, escribir en el dispositivo de
      salida que se esté <a href='https://github.com/JJ/curso-js/tree/master/code/hola-js-2.html'>usando</a>:</p>
<code class='ejemplo'>document.writeln('Hola, Mundo')</code>

<p>Lo que también se puede escribir directamente <a
	href='https://github.com/JJ/curso-js/tree/master/code/hola-js-3.html'>así</a>:</p>
<code class='ejemplo'>&lt;script  type='text/javascript'>document.writeln('Hola, Mundo')&lt;/script></code>

<p>Estos programas se pueden usar con cualquier editor de texto,
 Emacs, Sublime Text o Notepad++; también con los entornos integrados,
 que te ofrecerán ventajas adicionales como completar las variables y
  los nombres de los comandos.</p>


<h3><a name='T1:t1:control'> Estructuras de control en JavaScript </a></h3>



<p>Vistas ya las mil y una formas de escribir cosas en la pantalla,
      procedamos a temas más escabrosos, como lo que viene siendo
      hacer algo <em>realmente</em>. Por ejemplo, un bucle que cree
      una tabla HTML, como se hace en el
      siguiente <a href='https://github.com/JJ/curso-js/tree/master/code/tabla.js'>programilla</a>:</p>

<code class='ejemplo'>var tabla="table";
var celda="td";
var fila="tr";
var matriz = [1,2,3];
print( "&lt;"+tabla+">");
for (i in matriz ) {
  print( "&lt;"+fila+">");
  for ( j in matriz ) {
    print ("&lt;"+celda+">"+matriz[i]*matriz[j]+"&lt;/"+celda+">");
  }
  print ("&lt;/"+fila+">\n");
 }
print ("&lt;/"+tabla+">");
    </code>

<p>Este programa tiene dos bucles anidados, que imprimen un producto
      dentro de una tabla. La salida será tal que así (ver el fuente
      para la estructura):</p>
<table>
<tr>
<td>1</td>
<td>2</td>
<td>3</td>
</tr>

<tr>
<td>2</td>
<td>4</td>
<td>6</td>
</tr>

<tr>
<td>3</td>
<td>6</td>
<td>9</td>
</tr>

</table>

<p>El programa es menos complicado de lo que parece. Para declarar
      variables en JS se usa el genérico <code>var</code>, aunque
      también se pueden declarar tipos específicos. Para no pillarnos
      los dedos, usamos var. En realidad, tampoco hace falta:
      simplemente usando una variable aparece mágicamente. Con las
      matrices ocurre igual (es decir, se declaran y se les asigna
      valor directamente)  : <code>matriz</code> lo es, y simplemente
      se declaran sus valores entre corchetes. Ojo con los nombres de
      variables, que a diferencia de otros lenguajes, distinguen
      entre mayúsculas y minúsculas. <code>esta_variable</code> es
      diferente de <code>esta_Variable</code>.</p>

<p>JS puede usar un tipo de bucle que tienen la apariencia habitual
      (en lenguajes derivados del C), y se pueden usar igual
      que en C, pero haremos un bucle que recorra la matriz, usando un
      <em>iterador</em> <code>i</code>, que en este caso se comporta como una variable
      de bucle de las de toda la vida. Usamos el <code>+</code> para
      concatenación de cadenas, y poco más. El resto es como el C, o
      el Java. De hecho, se pueden usar los bucles clásicos con
      comparación e incremento, como se muestra en <a
	href='https://github.com/JJ/curso-js/tree/master/code/tabla1.js'><code>tabla1.js</code></a>:</p>
<code class='ejemplo'>for (i=1; i&lt;=3; i++ ) {
  print( "&lt;"+fila+">");
  for ( j=1; j&lt;=3; j++  ) {
    print ("&lt;"+celda+">"+i*j+"&lt;/"+celda+">");
  }
  print ("&lt;/"+fila+">\n");
 }
    </code>

<p>Aunque queda un poco torpe tanto &lt;>... vamos a reducir un
      poco el programa, haciéndolo <a href='https://github.com/JJ/curso-js/tree/master/code/tabla2.js'>más
	elegante </a> (aunque más largo: no se puede tener todo):</p>

<code class='ejemplo'>
var matriz = [1,2,3];
print( marca('table'));
for (i in matriz ) {
  print( marca( 'tr' ));
  for ( j in matriz ) {
    print ( celda(matriz[i]*matriz[j]));
  }
  print ( finmarca('tr'));
}
print (finmarca('table'));

function marca( m ) {
  return "&lt;"+m+">";
}

function finmarca( m ) {
  return "&lt;/"+m+">";
}

function celda( contenido ) {
  return marca("td")+contenido+finmarca("td");
}</code>

<p>La principal diferencia con respecto al anterior es el <strong>uso de
      funciones</strong>. Las funciones en JS tienen una estructura bastante
      clásica: <code>function</code> nombre-de-función (param1, param2...). Una
      vez más, se nota que JS no e un lenguaje con tipos fuertes,
      pudiendo pasar los parámetros sin tipo, y adaptándose dentro de
      la función al tipo necesario. Se pasan por valor, es decir,
      que las modificaciones al parámetro formal no se trasladan a la
      variable que se use. Además, se pueden declarar donde a
    uno le dé la gana. Para llamarlas tampoco hay que hacer nada
      especial, se usa el clásico paréntesis. La salida es exactamente
    la misma que antes. El también clásico <code>return</code> devuelve un valor.
    </p>

<p>El ámbito de las variables es el bloque donde aparecen o se
      declaran, pero hay que tener en cuenta que, a efectos de JS, una
      página web es un <em>programa</em>. Se pueden declarar variables en la
      cabecera del documento HTML, y estarán accesibles en cualquier
      otro sitio, siempre que esté mas adelante en el
      documento. También habrá que tener en cuenta, en caso de que
      esté incluido en una página web, que aunque la declaración de
      una subrutina afecte a todo el programa, puede que esa parte de
      la página no se haya cargado todavía, con lo que no estará
      disponible. Una vez más, la programación distribuida no es totalmente
      igual a la programación en otros lenguajes. </p>




<h3><a name='T1:t2:clases'> Clases y objetos en JavaScript </a></h3>


<p>JavaScript es un lenguaje basado en objetos, aunque un tanto
      peculiar; en realidad, de casi todas las características de un
      lenguaje orientado a objetos, solo tiene los objetos, e incluso
      estos son un tanto peculiares. Por eso no es exactamente <em>dirigido a objetos</em> u <em>orientado a objetos</em>. Las características las veremos en el siguiente <a
	href='https://github.com/JJ/curso-js/tree/master/code/quiniela.js'>programa</a>, que podría servir
      para hacer quinielas.</p>
<code class='ejemplo'>
var equipos= new Array('Madrid', 'Barça', 'Atleti', 'Geta', 'Betis', 'Depor', 'Sevilla', 'Graná');

   // Definición de la clase Partido
function Partido(local,visitante) {
  this.local = local;
  this.visitante=visitante;
  this.resultado=null;
}

var midsize = equipos.length/2;
var quiniela = new Array( midsize );
for ( i=0; i &lt; midsize ; i++ ) {
  var equipo1 = equipos.splice(Math.floor( equipos.length*Math.random()) , 1);
  var equipo2 = equipos.splice(Math.floor( equipos.length*Math.random()), 1);
  quiniela[i] = new Partido( equipo1, equipo2 );
 }

for ( i in quiniela ) {
        print( "Partido " + (parseInt(i)+1)+": " + quiniela[i].local + " - " + quiniela[i].visitante);
 }
    </code>

<p>Con lo primero que nos enfrentamos es con una nueva forma de
      definir una matriz o <code>Array</code>: ya que sabemos que JS es OO, pues
      usamos una forma OO de definirlo, mediante la orden <code>new</code>, que,
      como en Java y en C++, crea un nuevo objeto llamando al
      <em>constructor</em> del mismo. En este caso le pasamos directamente
      los elementos que constituyen el vector o <em>array</em>, pero
      podríamos haberle pasado el tamaño de esta forma:
<code class='ejemplo'>var myArray = new Array(33);</code>
Los objetos así creados son objetos de pleno derecho, y se puede
      acceder a sus propiedades con métodos usando también una
      sintaxis clásica: el puntito <code>.</code> tras el nombre de la
      variable. Por ejemplo, <code>myArray.length</code> devolvería el tamaño de
      la matriz</p>

<p>Pero como lo que se trata en este programa es de definir nosotros
      una clase, lo hacemos en las líneas siguientes, en la función
      <code>Partido</code>, que convencionalmente ponemos en mayúscula, para
      indicar que es un nombre de clase. En realidad, una clase en
      JS es una función dentro de la cual se le asigna un valor a la
      variable <code>this</code>, como en esta: cada uno de los elementos de la
      variable <code>this</code> será una variable de instancia. Como se ve, aquí
      no hay encapsulación ni perrito que le ladre. </p>

<p>Lo que vamos a crear es un vector de estos partidos, e irle
      asignando valores extraídos aleatoriamente. Mientras tanto,
      usamos los métodos que llevan objetos de clases estándar JS;
      igual que otros lenguajes tienen librería estándar, JS tiene
      clases estándar: <code>Array</code>, que ya hemos visto, y <code>Math</code>. Lo que
      usamos de <code>Math</code> son métodos de clase, no de instancia, tales
      como <code>Math.random</code>, que genera un número aleatorio entre 0 y
      1. También se usa un método de instancia, <code>splice</code>, que extrae
      una parte del vector de equipos; extraemos el seleccionado, para
      que no moleste mientras generamos el resto de la quiniela.</p>

<p>Y el objeto lo creamos mediante una clásica llamada: </p>
<code class='ejemplo'> quiniela[i] = new Partido( equipo1, equipo2 );</code>

<p>Más adelante usamos un bucle <code>in</code> para escribir los valores de cada
      uno de los partidos; las variables no están encapsuladas, así
      que se puede acceder a ellas directamente: <code>partido.local</code>, por
      ejemplo. Hay también un pequeño truco: el uso de <code>parseInt</code>
      dentro de <code>print</code> para que se interprete <code>i</code> como un número
      entero, no como una cadena, y, por tanto, el <code>+</code> que lo sigue
      como una suma normal y no una concatenación de cadenas. <code>i+1</code>
      daría <code>11</code>, mientras que <code>parseInt(i)+1</code> dará 2.</p>

<p>Y el resultado, aleatorio por supuesto, será algo así
      como esto :
<code class='ejemplo'>Partido 0: Graná - Atleti
Partido 1: Madrid - Depor
Partido 2: Betis - Barça
Partido 3: Sevilla - Geta</code>

<p>Añadir métodos de clase se hace más o menos de la misma forma, que
      no es muy ortodoxa, pero es la que hay. Lo veremos en <a
	href='https://github.com/JJ/curso-js/tree/master/code/quiniela2.js'>el siguiente programa</a>, del que
    sacamos el fragmento más interesante:</p>
<code class='ejemplo'>
   // Definición de la clase Partido
function Partido(local,visitante) {
  this.local = local;
  this.visitante=visitante;
  this.resultado=null;
  this.setResultado = setResultado;
  this.toString = toString;
}

function setResultado( esteResultado ) {
  if ( esteResultado == '1' || esteResultado=='x' || esteResultado=='2' ) 
    this.resultado = esteResultado;
}

function toString() {
    return "Partido " + i + ": " + this.local + " - " + this.visitante + " = "+ this.resultado;
}</code>
<p>Añadimos un par de funciones, y para que <em>pertenezcan</em> a la clase,
      hala, con un <code>this</code> por aquí y un <code>this</code> por allá,
      solucionado. Es de buen gusto llamar al método con el mismo
      nombre que la función, para no despistarse; también seguir una
      cierta convención para ponerles nombres: <code>get</code>, o <code>to</code>, o cosas
      por el estilo. Lo que no es de recibo es llamar a una función
      que cambia el valor de la variable igual que la variable, porque
      entonces nos liamos. Y como ya hemos visto antes como se llama a
    los métodos de instancia, pues listos. No se hable más.</p>



<h3>Matrices asociativas </h3>



<p>Pero hay más matrices, aparte de las lineales: JS, como muchos
      otros lenguajes, permite trabajar con <em>matrices asociativas</em>
      (también llamadas <em>diccionarios</em> o <em>hashes</em>). En una matriz
      asociativa, la clave es una cadena, en vez de un número, lo que
      le da mucha más flexibilidad a la hora de almacenar
      información. En un vector, se accede a cada uno de los elementos
      del vector a través de un índice numérico, y eso implica también
      un orden en su estructura (y, a veces, una continuidad en su
      almacenamiento, aunque no necesariamente tiene que ser así). Es
      decir, un vector lineal es un grupo de parejas (0, valor[0], 1,
      valor[1],...., n, valor[n]). De hecho, como los números suelen
      ser sucesivos, muchas veces se dan por sobreentendidos, de forma
    que para trabajar con un vector (ejecutar una operación sobre sus valores, por ejemplo)
      sólo se usan sus valores: valor[0], valor[1],..., valor[n].</p>

<p>Sin embargo, una matriz asociativa, diccionario, mapa o <a href='http://es.wikipedia.org/wiki/Tabla_hash'>Tabla_hash</a>
      (o simplemente <em>hash</em>) está compuesto por una serie de pares
      (cadena alfanumérica, valor): (cadena<sub>1</sub>, valor<sub>1</sub>,
      cadena<sub>2</sub>,valor<sub>2</sub>... cadena<sub>n</sub>,
      valor<sub>n</sub>). Los valores están asociados a su cadena
      correspondiente; de forma que se accede a los valores
      a través de la cadena alfanumérica usada para indexarlos, que
      se suele denominar <em>clave</em> (<em>key</em>). Casi todos los lenguajes
      de programación tienen alguna forma de usar estas matrices
      asociativas. Por ejemplo, en Perl:
<code class='ejemplo'>my %matrizAsociativa; # % para matrices asociativas
$matrizAsociativa{'variable'}='Valor'; # { para las claves
print $matrizAsociativa{'variable'};</code>
devolvería <code>Valor</code>. </p>

<p>Las usaremos en el <a
	href='https://github.com/JJ/curso-js/tree/master/code/liga.js'>siguiente programa</a>, que genera
      aleatoriamente diez jornadas de una liga, y asigna puntuación
      según los resultados:</p>
<code class='ejemplo'><span class="hl kwd">load</span><span class="hl opt">(</span><span class="hl str">'Partido.js'</span><span class="hl opt">);</span>

<span class="hl kwa">var</span> equipos<span class="hl opt">=</span> <span class="hl kwa">new</span> <span class="hl kwd">Array</span><span class="hl opt">(</span><span class="hl str">'Madrid'</span><span class="hl opt">,</span> <span class="hl str">'Barça'</span><span class="hl opt">,</span> <span class="hl str">'Atleti'</span><span class="hl opt">,</span> <span class="hl str">'Geta'</span><span class="hl opt">,</span> <span class="hl str">'Betis'</span><span class="hl opt">,</span> <span class="hl str">'Depor'</span><span class="hl opt">,</span> <span class="hl str">'Sevilla'</span><span class="hl opt">,</span> <span class="hl str">'Graná'</span><span class="hl opt">);</span>

<span class="hl kwa">function</span> <span class="hl kwd">jornada</span><span class="hl opt">(</span> estosEquipos <span class="hl opt">) {</span>

  <span class="hl kwa">var</span> equiposAqui <span class="hl opt">=</span> <span class="hl kwa">new</span> Array<span class="hl opt">;</span>
  equiposAqui <span class="hl opt">=</span> equiposAqui<span class="hl opt">.</span><span class="hl kwd">concat</span><span class="hl opt">(</span>estosEquipos<span class="hl opt">);</span>
  <span class="hl kwa">var</span> midsize <span class="hl opt">=</span> equiposAqui<span class="hl opt">.</span>length<span class="hl opt">/</span><span class="hl num">2</span><span class="hl opt">;</span>
  <span class="hl kwa">var</span> quiniela <span class="hl opt">=</span> <span class="hl kwa">new</span> <span class="hl kwd">Array</span><span class="hl opt">(</span> midsize <span class="hl opt">);</span>
  <span class="hl kwa">var</span> unox2 <span class="hl opt">=</span> <span class="hl kwa">new</span> <span class="hl kwd">Array</span><span class="hl opt">(</span> <span class="hl str">'1'</span><span class="hl opt">,</span><span class="hl str">'x'</span><span class="hl opt">,</span><span class="hl str">'2'</span><span class="hl opt">);</span>
  <span class="hl kwa">for</span> <span class="hl opt">(</span> <span class="hl kwa">var</span> i<span class="hl opt">=</span><span class="hl num">0</span><span class="hl opt">;</span> i <span class="hl opt">&lt;</span> midsize <span class="hl opt">;</span> i<span class="hl opt">++ ) {</span>
    <span class="hl kwa">var</span> equipo1 <span class="hl opt">=</span> equiposAqui<span class="hl opt">.</span><span class="hl kwd">splice</span><span class="hl opt">(</span>Math<span class="hl opt">.</span><span class="hl kwd">floor</span><span class="hl opt">(</span> equiposAqui<span class="hl opt">.</span>length<span class="hl opt">*</span>Math<span class="hl opt">.</span><span class="hl kwd">random</span><span class="hl opt">()) ,</span> <span class="hl num">1</span><span class="hl opt">);</span>
    <span class="hl kwa">var</span> equipo2 <span class="hl opt">=</span> equiposAqui<span class="hl opt">.</span><span class="hl kwd">splice</span><span class="hl opt">(</span>Math<span class="hl opt">.</span><span class="hl kwd">floor</span><span class="hl opt">(</span> equiposAqui<span class="hl opt">.</span>length<span class="hl opt">*</span>Math<span class="hl opt">.</span><span class="hl kwd">random</span><span class="hl opt">()),</span> <span class="hl num">1</span><span class="hl opt">);</span>
    quiniela<span class="hl kwc">[i]</span> <span class="hl opt">=</span> <span class="hl kwa">new</span> <span class="hl kwd">Partido</span><span class="hl opt">(</span> equipo1<span class="hl opt">,</span> equipo2 <span class="hl opt">);</span>
    quiniela<span class="hl kwc">[i]</span><span class="hl opt">.</span><span class="hl kwd">setResultado</span><span class="hl opt">(</span> unox2<span class="hl opt">[</span>Math<span class="hl opt">.</span><span class="hl kwd">floor</span><span class="hl opt">(</span> <span class="hl num">3</span><span class="hl opt">*</span>Math<span class="hl opt">.</span><span class="hl kwd">random</span><span class="hl opt">()) ]);</span>
  <span class="hl opt">}</span>
  <span class="hl kwa">return</span> quiniela<span class="hl opt">;</span>
<span class="hl opt">}</span>


<span class="hl kwa">var</span> quinielas <span class="hl opt">=</span> <span class="hl kwa">new</span> Array<span class="hl opt">;</span>
<span class="hl kwa">for</span> <span class="hl opt">(</span> <span class="hl kwa">var</span> i <span class="hl opt">=</span> <span class="hl num">0</span><span class="hl opt">;</span> i <span class="hl opt">&lt;</span> <span class="hl num">10</span><span class="hl opt">;</span> i <span class="hl opt">++ ) {</span>
  quinielas<span class="hl kwc">[i]</span> <span class="hl opt">=</span> <span class="hl kwd">jornada</span><span class="hl opt">(</span> equipos <span class="hl opt">);</span> 
<span class="hl opt">}</span>

<span class="hl kwa">var</span> resultados<span class="hl opt">=</span> <span class="hl kwa">new</span> Array<span class="hl opt">;</span>
<span class="hl kwa">for</span> <span class="hl opt">(</span> <span class="hl kwa">var</span> i <span class="hl kwa">in</span> equipos <span class="hl opt">) {</span>
  resultados<span class="hl opt">[</span>equipos<span class="hl kwc">[i]</span><span class="hl opt">]=</span><span class="hl num">0</span><span class="hl opt">;</span>
 <span class="hl opt">}</span>
<span class="hl kwa">for</span> <span class="hl opt">(</span> <span class="hl kwa">var</span> i <span class="hl opt">=</span> <span class="hl num">0</span><span class="hl opt">;</span> i <span class="hl opt">&lt;</span> quinielas<span class="hl opt">.</span>length<span class="hl opt">;</span> i <span class="hl opt">++ ) {</span>
  <span class="hl kwa">for</span> <span class="hl opt">(</span> <span class="hl kwa">var</span> j <span class="hl opt">=</span> <span class="hl num">0</span><span class="hl opt">;</span>j <span class="hl opt">&lt;</span> quinielas<span class="hl kwc">[i]</span><span class="hl opt">.</span>length<span class="hl opt">;</span> j <span class="hl opt">++ ) {</span>
    <span class="hl kwa">var</span> local <span class="hl opt">=</span> quinielas<span class="hl kwc">[i][j]</span><span class="hl opt">.</span>local<span class="hl opt">;</span>
    <span class="hl kwa">var</span> visitante <span class="hl opt">=</span> quinielas<span class="hl kwc">[i][j]</span><span class="hl opt">.</span>visitante<span class="hl opt">;</span>
    <span class="hl kwa">var</span> resultado <span class="hl opt">=</span> quinielas<span class="hl kwc">[i][j]</span><span class="hl opt">.</span>resultado<span class="hl opt">;</span>
    <span class="hl kwa">if</span> <span class="hl opt">(</span> resultado <span class="hl opt">==</span> <span class="hl num">1</span> <span class="hl opt">) {</span>
      resultados<span class="hl kwc">[local]</span><span class="hl opt">+=</span><span class="hl num">3</span><span class="hl opt">;</span>
    <span class="hl opt">}</span> <span class="hl kwa">else if</span> <span class="hl opt">(</span> resultado <span class="hl opt">==</span> <span class="hl str">'x'</span> <span class="hl opt">) {</span>
      resultados<span class="hl kwc">[local]</span><span class="hl opt">+=</span><span class="hl num">1</span><span class="hl opt">;</span>
      resultados<span class="hl kwc">[visitante]</span><span class="hl opt">+=</span><span class="hl num">1</span><span class="hl opt">;</span>
    <span class="hl opt">}</span> <span class="hl kwa">else</span> <span class="hl opt">{</span> <span class="hl slc">// resultado == 2</span>
      resultados<span class="hl kwc">[visitante]</span><span class="hl opt">+=</span><span class="hl num">3</span>
    <span class="hl opt">}</span>
  <span class="hl opt">}</span>
 <span class="hl opt">}</span>

<span class="hl kwa">for</span> <span class="hl opt">(</span> <span class="hl kwa">var</span> i <span class="hl kwa">in</span> resultados <span class="hl opt">) {</span>
  <span class="hl kwd">print</span><span class="hl opt">(</span> i <span class="hl opt">+</span> <span class="hl str">&quot;: &quot;</span> <span class="hl opt">+</span> resultados<span class="hl kwc">[i]</span><span class="hl opt">)</span>
 <span class="hl opt">}</span>
</code>

<p>En parte, este programa es similar a los anteriores: la parte que
      generaba cada jornada está ahora en una función, que devuelve un
      <code>array</code> de resultados, que se guardan en el array
      <code>quinielas</code>. Hemos sacado, además, la definición de la clase
      <code>Partido</code> a un fichero externo, que cargamos con <code>load</code>. Por
      otro lado, como a la función <code>jornada</code> se le pasa una referencia
      al vector con los equipos, tenemos que copiarlo a una variable
      local, definiéndola (<code>equiposAqui</code>), y concatenándole (<code>concat</code>)
      el vector que se le pasa por valor, que es igual que copiarlo,
      pero seo hace en una sola orden.</p>

<p>El truco está a partir de la definición de la
      variable <code>resultados</code>. Esta variable es una matriz asociativa
      que contendrá la puntuación de los equipos, y estará indexada
      por el nombre del equipo. Se declara igual que los demás arrays,
      y, para inicializarlo, vamos extrayendo los valores del vector
      de equipos, y usándolos como clave:
<code class='ejemplo'>resultados[equipos[i]]=0;</code>
<code>equipos[i]</code> valdrá sucesivamente Barça, Graná... y así se irán
      inicializando a 0 los valores correspondientes. Si no se
      inicializan, la primera vez que se usa una variable tiene el
      valor <code>NaN</code>, con el que no se puede hacer nada. Es así de
      arisco. </p>

<p>Más adelante se va recorriendo en un bucle doble los partidos de
      cada una de las jornadas, y asignando puntuación dependiendo del
      resultado de la quiniela. Se usa la construcción <code>if... else if
      ... else</code>, que funciona de la forma habitual, aunque también
      podríamos haber usado <code>switch</code>, como en <a
	href='https://github.com/JJ/curso-js/tree/master/code/liga2.js'>el siguiente programa</a>, que en lo
      único que cambia es en estas líneas:</p>
<code class='ejemplo'>    switch (resultado) {
    case '1':
      resultados[local]+=3;
      break;
    case 'x':
      resultados[local]+=1;
      resultados[visitante]+=1;
      break;
    default:
      resultados[visitante]+=3;
    }
  }
    </code>
<p>y que viene a ser como el anterior, pero con <code>case</code>s en vez de
      <code>if</code>s. Vamos, tres cuartos de lo mismo.</p>



<h3> Manejando Objetos </h3>



<p>En realidad, todo en JavaScript es un objeto, y especialmente los
      vectores: tanto los vectores tradicionales como las matrices
      asociativas como los objetos se representan internamente de la
      misma forma, y te puedes referir a ellos de diferentes
      maneras. Vamos a usar el depurador interactivo para verlo,
      ejecutando simplemente <code>rhino</code>, <code>rhino</code> o <code>kjs</code> en la línea de
      comandos. Una vez hecho, tecleamos las siguientes órdenes:
<code class='ejemplo'><strong>js> foo = new Array</strong>

<strong>js> foo.cero='Cero'</strong>
Cero
<strong>js> foo[1] = 'Uno'</strong>
Uno
<strong>js> foo['dos'] = 'Dos'</strong>
Dos
<strong>js> foo.dos</strong>
Dos
<strong>js> foo['cero']</strong>
Cero
<strong>js> for ( i in foo) { print(foo[i]);}</strong>
Cero
Uno
Dos</code>
Hay que teclear lo que se encuentra detrás de <code>js></code>; cada segunda
      línea es la respuesta del intérprete a nuestras órdenes. En la
      primera, creamos un vector, y le asignamos valor a tres
      elementos de formas diferentes: usando la notación de objeto
      (con el .) para el 0, la notación de vector para el 1, y la
      notación de matriz asociativa para el 2. Luego se ve que,
      independientemente de cómo se haya asignado el valor, se puede
      usar cualquier otra notación para acceder al elemento; y,
      finalmente, vemos como se puede recorrer de forma uniforme el
      array usando sus componentes mediante la orden <code>in</code>. </p>

<p>Por eso precisamente, hay que tener un poco de cuidado con estos
      arrays asociativos que se comportan un poco como les da la
      gana. Es conveniente usar para ellos <code>Object</code>, que es lo que
      son, en vez de <code>Array</code>. De hecho, si en lo anterior sustituimos
      <code>Array</code> por <code>Object</code> dará exactamente el mismo resultado. Por
      eso <a
	href='http://andrewdupont.net/2006/05/18/javascript-associative-arrays-considered-harmful/'>se consideran perniciosas los arrays asociativos en JS</a>, pero es simplemente una cuestión de convención. </p>

<p>No todo va a ser público en un objeto; también pueden tener su
      intimidad guardada en variables privadas:</p>
<code class='ejemplo'><strong>js> function Foo( bar ) { this.bar = bar; var privada = 7;}</strong>
<strong>js> var este_foo = new Foo( 'correquetepillo' );</strong>

<strong>js> print(este_foo.bar)</strong>
correquetepillo
<strong>js> print(este_foo.privada)</strong>
undefined</code>
<p>Es tan secreta, de hecho, que ni siquiera te dice que no existe:
      simplemente que su valor está indefinido. </p>

<p>El propio estándar JavaScript (ECMAScript) define una serie de
      clases que se pueden instanciar, que corresponderían a la
      librería estándar (o librería estándar de clases) en otros
      lenguajes. Una de ellas ya la hemos visto: la clase
      <code>Array</code>. Otra es la clase <code>String</code>, que se usa para manejar
      cadenas alfanuméricas, chorros de 0s y 1s. 
<code class='ejemplo'><strong>js> var cadena = new String("1");</strong>
<strong>js> print(cadena + 1)</strong>
11
      </code>
La clase <code>String</code> tiene una serie de métodos que permiten hacer lo
      habitual con las cadenas: encadenarlas, dividirlas, y buscar
      cosas. 
<code class='ejemplo'><strong>js> var nombres = "Pedro, Lucas, Juan".split(", ");</strong>
<strong>js> print(nombres[0])</strong>
Pedro</code>
En este caso, <code>split</code> es un método de la clase String, y lo estamos
      aplicando directamente sobre la cadena <code>"Pedro, Lucas, Juan"</code>,
      que, de por si, es un objeto de esa clase. <code>split</code> divide la
      cadena usando los caracteres que le pasamos, y da lugar a un
      <code>Array</code> con tantos componentes como resulte.</p>

<p>De camino, podría haber una clase para escribir y leer ficheros,
      porque con el rato que llevamos, todavía no hemos visto ninguna,
      y, además, cualquier lenguaje decente escribe y lee ficheros. Es
      más, es que muchos no hacen otra cosa, ¿no? Pues no. El estándar
      JS no define ningún tipo de rutina de E/S. Pero si usamos el
      intérprete Rhino (en vez de SpiderMonkey, que es el que hemos
      venido usando), podemos usar clases de Java directamente, lo que
      complica terriblemente el programa, pero <a
	href='https://github.com/JJ/curso-js/tree/master/code/lee_quiniela.js'>ahí está, de todas
	formas</a>:</p>
<code class='ejemplo'><span class="hl slc">// ejecutar con rhino lee_quiniela.js &lt;argumento&gt;</span>
<span class="hl kwd">load</span><span class="hl opt">(</span><span class="hl str">'Partido.js'</span><span class="hl opt">);</span>
<span class="hl kwa">var</span> FileReader <span class="hl opt">=</span> java<span class="hl opt">.</span>io<span class="hl opt">.</span>FileReader<span class="hl opt">;</span>
<span class="hl kwa">var</span> BufferedReader <span class="hl opt">=</span>java<span class="hl opt">.</span>io<span class="hl opt">.</span>BufferedReader<span class="hl opt">;</span>

<span class="hl kwa">var</span> file_name <span class="hl opt">=</span> arguments<span class="hl kwc">[0]</span><span class="hl opt">;</span>

<span class="hl kwa">var</span> f <span class="hl opt">=</span> <span class="hl kwa">new</span> <span class="hl kwd">FileReader</span><span class="hl opt">(</span>file_name<span class="hl opt">);</span>
<span class="hl kwa">var</span> br <span class="hl opt">=</span> <span class="hl kwa">new</span> <span class="hl kwd">BufferedReader</span><span class="hl opt">(</span> f <span class="hl opt">);</span>
<span class="hl kwa">var</span> resultados<span class="hl opt">=</span> <span class="hl kwa">new</span> Array<span class="hl opt">;</span>
<span class="hl kwa">var</span> line <span class="hl opt">=</span> <span class="hl kwa">new</span> String<span class="hl opt">;</span>
<span class="hl kwa">while</span> <span class="hl opt">((</span>line <span class="hl opt">=</span> br<span class="hl opt">.</span><span class="hl kwd">readLine</span><span class="hl opt">()) !=</span> <span class="hl kwa">null</span><span class="hl opt">) {</span>
  <span class="hl kwa">var</span> estaLinea <span class="hl opt">=</span> <span class="hl kwa">new</span> <span class="hl kwd">String</span><span class="hl opt">(</span> line <span class="hl opt">);</span>
  <span class="hl kwa">var</span> resultado  <span class="hl opt">=</span> estaLinea<span class="hl opt">.</span><span class="hl kwd">split</span><span class="hl opt">(</span><span class="hl str">&quot; &quot;</span><span class="hl opt">);</span>
  <span class="hl kwa">switch</span> <span class="hl opt">(</span>resultado<span class="hl kwc">[2]</span><span class="hl opt">) {</span>
    <span class="hl kwa">case</span> <span class="hl str">'1'</span><span class="hl opt">:</span>
      <span class="hl kwa">if</span> <span class="hl opt">(</span> resultados<span class="hl opt">[</span>resultado<span class="hl kwc">[0]</span><span class="hl opt">] ) {</span>
	resultados<span class="hl opt">[</span>resultado<span class="hl kwc">[0]</span><span class="hl opt">]+=</span><span class="hl num">3</span><span class="hl opt">;</span>
      <span class="hl opt">}</span> <span class="hl kwa">else</span> <span class="hl opt">{</span>
	resultados<span class="hl opt">[</span>resultado<span class="hl kwc">[0]</span><span class="hl opt">]=</span><span class="hl num">3</span><span class="hl opt">;</span>
      <span class="hl opt">}</span>
      <span class="hl kwa">break</span><span class="hl opt">;</span>
    <span class="hl kwa">case</span> <span class="hl str">'x'</span><span class="hl opt">:</span>
      <span class="hl kwa">if</span> <span class="hl opt">(</span> resultados<span class="hl opt">[</span>resultado<span class="hl kwc">[0]</span><span class="hl opt">] ) {</span>
	resultados<span class="hl opt">[</span>resultado<span class="hl kwc">[0]</span><span class="hl opt">]+=</span><span class="hl num">1</span><span class="hl opt">;</span>
      <span class="hl opt">}</span> <span class="hl kwa">else</span> <span class="hl opt">{</span>
	resultados<span class="hl opt">[</span>resultado<span class="hl kwc">[0]</span><span class="hl opt">]=</span><span class="hl num">1</span><span class="hl opt">;</span>
      <span class="hl opt">}</span>
      <span class="hl kwa">if</span> <span class="hl opt">(</span> resultados<span class="hl opt">[</span>resultado<span class="hl kwc">[1]</span><span class="hl opt">] ) {</span>
	resultados<span class="hl opt">[</span>resultado<span class="hl kwc">[1]</span><span class="hl opt">]+=</span><span class="hl num">1</span><span class="hl opt">;</span>
      <span class="hl opt">}</span> <span class="hl kwa">else</span> <span class="hl opt">{</span>
	resultados<span class="hl opt">[</span>resultado<span class="hl kwc">[1]</span><span class="hl opt">]=</span><span class="hl num">1</span><span class="hl opt">;</span>
      <span class="hl opt">}</span>
      <span class="hl kwa">break</span><span class="hl opt">;</span>
    <span class="hl kwa">default</span><span class="hl opt">:</span>
       <span class="hl kwa">if</span> <span class="hl opt">(</span> resultados<span class="hl opt">[</span>resultado<span class="hl kwc">[1]</span><span class="hl opt">] ) {</span>
	resultados<span class="hl opt">[</span>resultado<span class="hl kwc">[1]</span><span class="hl opt">]+=</span><span class="hl num">3</span><span class="hl opt">;</span>
      <span class="hl opt">}</span> <span class="hl kwa">else</span> <span class="hl opt">{</span>
	resultados<span class="hl opt">[</span>resultado<span class="hl kwc">[1]</span><span class="hl opt">]=</span><span class="hl num">3</span><span class="hl opt">;</span>
      <span class="hl opt">}</span>
      <span class="hl kwa">break</span>
  <span class="hl opt">}</span>
 <span class="hl opt">}</span>

<span class="hl kwa">for</span> <span class="hl opt">(</span> <span class="hl kwa">var</span> i <span class="hl kwa">in</span> resultados <span class="hl opt">) {</span>
  <span class="hl kwd">print</span><span class="hl opt">(</span> i <span class="hl opt">+</span> <span class="hl str">&quot;: &quot;</span> <span class="hl opt">+</span> resultados<span class="hl kwc">[i]</span><span class="hl opt">)</span>
    <span class="hl opt">}</span> </code>

<p>El programa es bastante similar al anterior, pero lee de fichero en
      vez de generar los resultados aleatoriamente. Y lo lee
      aproximadamente de la misma forma a como se haría en Java. Por
      eso hay que usar Rhino, que permite usar las clases de la
      librería estándar de Java de forma <em>nativa</em>. En este caso
      usamos dos clases: <code>FileReader</code> y <code>BufferedReader</code>, para poder
      leer de línea en línea. La única diferencia a como se haría en
      Java es que hay que pasar la línea leída de un objeto <code>String</code>
      de Java a un objeto <code>String</code> de JS, que es lo que se hace en
      <code>var estaLinea = new String( line );</code>. También sale un poco más
      largo porque, como indicamos en el programa de más arriba, los
      elementos de un <code>Array</code> hay que inicializarlos; en cada caso del
      <code>switch</code> comprobamos si están inicializados o no antes de
      sumarles; si no lo está, le asignamos el valor
      directamente. </p>

<p>En realidad, las primeras líneas lo único que hacen es declarar un
      <em>alias</em> para las clases de Java. En JS una variable puede
      contener cualquier cosa, incluso una clase. Así acortamos el
      nombre, y parecen más de javascrí. </p>

<p>La otra diferencia es también cómo se ejecuta el fichero: 
<code class='ejemplo'>rhino lee_quiniela.js quiniela.datos</code>
para ejecutarlo sobre el <a href='https://github.com/JJ/curso-js/tree/master/code/quiniela.datos'>fichero
	<code>quiniela.datos</code></a>, que dará el resultado siguiente:
<code class='ejemplo'>Elche: 1
Atleti: 3
Cai: 1
Athleti: 6
Bar~a: 1
Madrid: 2
H~rcules: 1</code>
Queda con esto más o menos claro que para ir donde nadie ha ido antes
      con JS, hay que meterse un poco en Java. Pero no siempre. Tenéis
alguna información más
en <a href='http://www.mozilla.org/rhino/ScriptingJava.html'>este
  tutorial de Mozilla</a>, que te explica como importar espacios de
nombres completos e incluso como implementar interfaces de Java. </p>

<p>Aunque no lo parezca, JS es todavía un lenguaje joven, al que le
      faltan gran cantidad de librerías básicas, y, especialmente, una
      forma centralizada de empaquetar, probar y distribuir esas
      librerías, como <a href='http://www.cpan.org'>CPAN</a> para Perl o
      GEMs para Ruby. Hay algo por el estilo, <a
	href='http://openjsan.org'>llamado OpenJSAN</a>, de JS Archive
      Network. Para instalarlo hace falta Perl, y sólo hay unas pocas
      librerías todavía. Algunas muy  útiles, pero siguen siendo unas
      pocas. Otras, como la amplia <a
	href='http://code.google.com/p/jslibs/'>JSlib</a>, sólo va en
      Windows. En todo caso, a estas alturas parece un proyecto muerto. </p>

<p>La que si es popular es <a
	href='http://prototypejs.org/'>Prototype</a>, una librería
      que se usa principalmente en conjunción con RoR y AJAX, pero
      resulta que necesita ejecutarse dentro del navegador, porque usa
    objetos del mismo (como <code>document</code>, por ejemplo). Así que la
	dejaremos para más adelante.</p> 





<h3> Objetos para el camino: JSON </h3>


<p>Lo interesante de los objetos en JS es que hay una forma muy fácil
      de <em>serializarlos</em> (es decir, convertirlos en texto u otro
      formato de forma que se puedan intercambiar fácilmente con otros
      programas a través de la red); a este formato se le denomina
      <a href='http://es.wikipedia.org/wiki/JSON'>JSON</a> (JavaScript Object Notation). Y como en realidad,
      tal como se ha visto en el apartado anterior, todo es un objeto
      en JS, se puede usar esta notación para asignar valores
      prácticamente a cualquier cosa. Vamos a usar una vez más el
      intérprete en modo interactivo para ver un ejemplo:</p>
<code class='ejemplo'><strong>js> var objeto = { Madrid : 25, Atleti: 33, Ponferradina: 44 };</strong>
<strong>js> for (i in objeto) { print( i + " : "+ objeto[i] )};</strong>
Madrid : 25
Atleti : 33
Ponferradina : 44
</code>

<p>Más fácil no puede ser. Se le asigna valor a un objeto con el formato
      clave : valor (con coma al final), de la misma forma que se
      haría a un array asociativo. Además, se pueden crear objetos
      sobre la marcha y asignárselos a una variable cuyo valor se cree
  también sobre la marcha:</p>
<code class='ejemplo'><strong>js> eval("var objeto2 = { Madrid : 25, Atleti: 33, Ponferradina: 44 }");</strong>
<strong>js> for (i in objeto2) { print( i + " : "+ objeto[i] )};</strong>
Madrid : 25
Atleti : 33
Ponferradina : 44</code>
<p>donde usamos <code>eval</code>, que interpreta una expresión en JavaScript como
      si del propio intérprete se tratara. Las expresiones se pueden
  anidar, para dar lugar a objetos más complejos</p>
<code class='ejemplo'><strong>js> eval("var objeto2 = { Madrid : 25, Atleti: 33, Ponferradina: { casa: 33, fuera: 44} }");</strong>
<strong>js> for (i in objeto2) { print( i + " : "+ objeto2[i] )};</strong>
Madrid : 25
Atleti : 33
Ponferradina : [object Object]</code>
<p>Que parece más raro de la cuenta, pero que, con un poco de código, se
      podría también imprimir.</p>

<p>Y JSON, precisamente, es uno de los formatos de intercambio, el más
      simple, el que se usa en AJAX, y un modo de acceder también a
      servicios web como <em>geonames</em>. Lo hacemos en <a href='https://github.com/JJ/curso-js/tree/master/code/json-geonames.html'>el
	siguiente ejemplo: <code>json-geonames.html</code></a>, del que extraemos
    el <a href='https://github.com/JJ/curso-js/tree/master/code/geonames_call.js'>código en JS (fichero <code>geonames_call.js</code>)</a></p>
<code class='ejemplo'><span class="hl slc">// this function will be called by our JSON callback</span>
<span class="hl slc">// the parameter jData will contain an array with geonames objects</span>
<span class="hl kwa">function</span> <span class="hl kwd">getLocation</span><span class="hl opt">(</span>jData<span class="hl opt">) {</span>
  <span class="hl kwa">if</span> <span class="hl opt">(</span>jData <span class="hl opt">==</span> <span class="hl kwa">null</span><span class="hl opt">) {</span>
    <span class="hl slc">// There was a problem parsing search results</span>
    <span class="hl kwa">return</span><span class="hl opt">;</span>
  <span class="hl opt">}</span>

  <span class="hl kwa">var</span> html <span class="hl opt">=</span> <span class="hl str">'&lt;ul&gt;'</span><span class="hl opt">;</span>
  <span class="hl kwa">var</span> geonames <span class="hl opt">=</span> jData<span class="hl opt">.</span>geonames<span class="hl opt">;</span>
  <span class="hl kwa">for</span> <span class="hl opt">(</span>i<span class="hl opt">=</span><span class="hl num">0</span><span class="hl opt">;</span>i<span class="hl opt">&lt;</span> geonames<span class="hl opt">.</span>length<span class="hl opt">;</span>i<span class="hl opt">++) {</span>
     <span class="hl kwa">var</span> name <span class="hl opt">=</span> geonames<span class="hl kwc">[i]</span><span class="hl opt">;</span>
     <span class="hl slc">// we create a simple html list with the geonames objects</span>
     <span class="hl slc">// the link will call the center() javascript method with lat/lng as parameter</span>
     html <span class="hl opt">=</span> html<span class="hl opt">+</span><span class="hl str">&quot;&lt;li&gt;&lt;em&gt;&quot;</span><span class="hl opt">+</span>name<span class="hl opt">.</span>name<span class="hl opt">+</span> <span class="hl str">&quot;&lt;/em&gt; - Latitud: &quot;</span> <span class="hl opt">+</span> name<span class="hl opt">.</span>lat <span class="hl opt">+</span><span class="hl str">', longitud: '</span> <span class="hl opt">+</span> name<span class="hl opt">.</span>lng<span class="hl opt">+</span> <span class="hl str">&quot;&lt;/li&gt;&quot;</span><span class="hl opt">;</span>
  <span class="hl opt">}</span>
  html<span class="hl opt">+=</span><span class="hl str">&quot;&lt;/ul&gt;&quot;</span><span class="hl opt">;</span>
  document<span class="hl opt">.</span><span class="hl kwd">getElementById</span><span class="hl opt">(</span><span class="hl str">'resultDiv'</span><span class="hl opt">).</span>innerHTML <span class="hl opt">=</span> html<span class="hl opt">;</span>
<span class="hl opt">}</span>

<span class="hl slc">// calls the geonames JSON webservice with the search term</span>
<span class="hl kwa">function</span> <span class="hl kwd">search</span><span class="hl opt">() {</span>
  request <span class="hl opt">=</span> <span class="hl str">'http://ws.geonames.org/searchJSON?country=ES&amp;q='</span> <span class="hl opt">+</span>  <span class="hl kwd">encodeURIComponent</span><span class="hl opt">(</span>document<span class="hl opt">.</span><span class="hl kwd">getElementById</span><span class="hl opt">(</span><span class="hl str">'q'</span><span class="hl opt">).</span>value<span class="hl opt">)  +</span> <span class="hl str">'&amp;maxRows=10&amp;callback=getLocation'</span><span class="hl opt">;</span>

  <span class="hl slc">// Create a new script object</span>
  <span class="hl slc">// Implementación en jsr_class.js</span>
  aObj <span class="hl opt">=</span> <span class="hl kwa">new</span> <span class="hl kwd">JSONscriptRequest</span><span class="hl opt">(</span>request<span class="hl opt">);</span>
  <span class="hl slc">// Build the script tag</span>
  aObj<span class="hl opt">.</span><span class="hl kwd">buildScriptTag</span><span class="hl opt">();</span>
  <span class="hl slc">// Execute (add) the script tag</span>
  aObj<span class="hl opt">.</span><span class="hl kwd">addScriptTag</span><span class="hl opt">();</span>
<span class="hl opt">}</span></code>

<p>Este ejemplo es un poco complicado, sobre todo, por el mecanismo
      que usa para hacer la llamada, y que está contenido en el
      fichero <a href='https://github.com/JJ/curso-js/tree/master/code/jsr_class.js'><code>jsr_class.js</code>, que
	contiene la clase <code>JSONscriptRequest</code></a>, que será la que
      usemos para construir la llamada. La mecánica es la siguiente:
      cada vez que se introduce un nombre de un pueblo o ciudad de
      España, se genera un evento, y se llama a la función
      <code>search</code>. Esta función  construye una petición, dentro de la
      cual está incluido <code>callback=getLocation</code>. El truco
      es que esa petición genera un <em>callback</em> tal que cuando se
      recibe la respuesta se llama a la función <code>getLocation</code>
      (definida más arriba).</p>

<p>Esa función recibe como variable en <code>jData</code> el resultado que, al
      estar en formato JSON, ya está, de hecho, en el formato de un
      objeto en JS. Por eso, en el bucle dentro de la función
      <code>getLocation</code> se trabaja directamente con los datos obtenidos
  sin necesidad de hacer ningún tipo de parsing.</p>


<h3> Funciones como objetos </h3>


<p>Las funciones son objetos de pleno derecho en JavaScript. Se puede
  crear una función como  cualquier otro objeto, y de hecho ya hemos visto algo
  parecido cuando hemos definido una clase (que es simplemente un tipo
  de función). Como tales objetos, podemos pasarlas como parámetros y
  modificarlas de diferentes formas; algo así hemos visto ya cuando
  hemos definido objetos también, en los que se asignan los nombres de
  funciones a métodos de una clase simplemente usando su nombre (en realidad, un puntero a función). Las
  diferentes formas de definir funciones se explican 
  en <a href='http://stackoverflow.com/questions/1140089/how-does-an-anonymous-function-in-javascript-work'>
    este post de StackOverflow (un recurso imprescindible, por otro lado).</a></p>

<p>Vamos a verlo a verlo a continuación, usando nuestra conocida
  quiniela; usaremos una función para imprimir el resultado de la
  quiniela, de forma que se pueda ver la salida de varias formas
  diferentes. En <a href='https://github.com/JJ/curso-js/tree/master/code/Nuevo_partido.js'>el siguiente
    módulo hacemos uso de esta funcionalidad</a>: </p>

<code class='ejemplo'>// Definición de la clase Partido
<span class="hl kwa">function</span> <span class="hl kwd">Nuevo_partido</span><span class="hl opt">(</span>local<span class="hl opt">,</span>visitante<span class="hl opt">) {</span>
    <span class="hl kwa">this</span><span class="hl opt">.</span>local <span class="hl opt">=</span> local<span class="hl opt">;</span>
    <span class="hl kwa">this</span><span class="hl opt">.</span>visitante<span class="hl opt">=</span>visitante<span class="hl opt">;</span>
    <span class="hl kwa">this</span><span class="hl opt">.</span>resultado<span class="hl opt">=</span><span class="hl kwa">null</span><span class="hl opt">;</span>
    <span class="hl kwa">this</span><span class="hl opt">.</span>setResultado <span class="hl opt">=</span> setResultado<span class="hl opt">;</span>
    <span class="hl kwa">this</span><span class="hl opt">.</span>toString <span class="hl opt">=</span> toString<span class="hl opt">;</span>
    <span class="hl kwa">this</span><span class="hl opt">.</span>set_to_string <span class="hl opt">=</span> set_to_string<span class="hl opt">;</span>
    <span class="hl kwa">this</span><span class="hl opt">.</span>impresor <span class="hl opt">=</span> _toString<span class="hl opt">;</span>
<span class="hl opt">}</span>

<span class="hl kwa">function</span> <span class="hl kwd">setResultado</span><span class="hl opt">(</span> esteResultado <span class="hl opt">) {</span>
    <span class="hl kwa">if</span> <span class="hl opt">(</span> esteResultado <span class="hl opt">==</span> <span class="hl str">'1'</span> || esteResultado<span class="hl opt">==</span><span class="hl str">'x'</span> || esteResultado<span class="hl opt">==</span><span class="hl str">'2'</span> <span class="hl opt">)</span> 
	<span class="hl kwa">this</span><span class="hl opt">.</span>resultado <span class="hl opt">=</span> esteResultado<span class="hl opt">;</span>
<span class="hl opt">}</span>

<span class="hl kwa">function</span> <span class="hl kwd">toString</span><span class="hl opt">() {</span>
    <span class="hl kwa">return this</span><span class="hl opt">.</span><span class="hl kwd">impresor</span><span class="hl opt">(</span><span class="hl kwa">this</span><span class="hl opt">.</span>local<span class="hl opt">,</span> <span class="hl kwa">this</span><span class="hl opt">.</span>visitante<span class="hl opt">,</span> <span class="hl kwa">this</span><span class="hl opt">.</span>resultado<span class="hl opt">);</span>
<span class="hl opt">}</span>

<span class="hl kwa">function</span> <span class="hl kwd">_toString</span><span class="hl opt">(</span> local<span class="hl opt">,</span> visitante <span class="hl opt">) {</span>
    <span class="hl kwa">return</span> <span class="hl str">&quot;: &quot;</span> <span class="hl opt">+</span> local <span class="hl opt">+</span> <span class="hl str">&quot; - &quot;</span> <span class="hl opt">+</span> visitante <span class="hl opt">+</span> <span class="hl str">&quot; = &quot;</span><span class="hl opt">+</span> resultado<span class="hl opt">;</span>
<span class="hl opt">}</span>

<span class="hl kwa">function</span> <span class="hl kwd">set_to_string</span> <span class="hl opt">(</span> impresor <span class="hl opt">) {</span>
    <span class="hl kwa">this</span><span class="hl opt">.</span>impresor <span class="hl opt">=</span> impresor<span class="hl opt">;</span>
<span class="hl opt">}</span>
</code>

<p>En esta clase la principal diferencia es que usamos el método
  <code>impresor</code> como una variable al cual le podemos asignar diferentes
  valores, incluso desde fuera. De esta forma se puede modificar el
  comportamiento de un objeto: asignamos un comportamiento por
  omisión, pero si es necesario podemos cambiar <em>desde fuera</em>
  el comportamiento de esa clase simplemente asignándole un valor
  nuevo. De hecho, esto es lo que vamos a hacer en el <a href='https://github.com/JJ/curso-js/tree/master/code/liga3.js'>programa
    siguiente (<code>liga3.js</code>)</a>: </p>


<code class='ejemplo'>#<span class="hl opt">!/</span>usr<span class="hl opt">/</span>bin<span class="hl opt">/</span>js

<span class="hl kwd">load</span><span class="hl opt">(</span><span class="hl str">'Nuevo_partido.js'</span><span class="hl opt">);</span>

<span class="hl kwa">var</span> equipos<span class="hl opt">=</span> <span class="hl kwa">new</span> <span class="hl kwd">Array</span><span class="hl opt">(</span><span class="hl str">'Madrid'</span><span class="hl opt">,</span> <span class="hl str">'Barça'</span><span class="hl opt">,</span> <span class="hl str">'Atleti'</span><span class="hl opt">,</span> <span class="hl str">'Geta'</span><span class="hl opt">,</span> <span class="hl str">'Betis'</span><span class="hl opt">,</span> <span class="hl str">'Depor'</span><span class="hl opt">,</span> <span class="hl str">'Sevilla'</span><span class="hl opt">,</span> <span class="hl str">'Graná'</span><span class="hl opt">);</span>

<span class="hl kwa">function</span> <span class="hl kwd">jornada</span><span class="hl opt">(</span> estosEquipos <span class="hl opt">) {</span>
    <span class="hl kwa">var</span> equiposAqui <span class="hl opt">=</span> <span class="hl kwa">new</span> Array<span class="hl opt">;</span>
    <span class="hl kwa">var</span> imprime <span class="hl opt">=</span> <span class="hl kwa">function</span><span class="hl opt">(</span> local<span class="hl opt">,</span> visitante<span class="hl opt">,</span> resultado <span class="hl opt">) {</span> 
	<span class="hl kwd">print</span><span class="hl opt">(</span><span class="hl str">&quot;Impimiendo</span> <span class="hl esc">\n</span><span class="hl str">&quot;</span><span class="hl opt">);</span>
	<span class="hl kwa">return</span>  <span class="hl str">&quot;- &quot;</span> <span class="hl opt">+</span> local <span class="hl opt">+</span> <span class="hl str">&quot; vs. &quot;</span> <span class="hl opt">+</span> visitante <span class="hl opt">+</span> <span class="hl str">&quot; resultado  &quot;</span><span class="hl opt">+</span> resultado<span class="hl opt">;</span>
    <span class="hl opt">};</span>
    equiposAqui <span class="hl opt">=</span> equiposAqui<span class="hl opt">.</span><span class="hl kwd">concat</span><span class="hl opt">(</span>estosEquipos<span class="hl opt">);</span>
    <span class="hl kwa">var</span> midsize <span class="hl opt">=</span> equiposAqui<span class="hl opt">.</span>length<span class="hl opt">/</span><span class="hl num">2</span><span class="hl opt">;</span>
    <span class="hl kwa">var</span> quiniela <span class="hl opt">=</span> <span class="hl kwa">new</span> <span class="hl kwd">Array</span><span class="hl opt">(</span> midsize <span class="hl opt">);</span>
    <span class="hl kwa">var</span> unox2 <span class="hl opt">=</span> <span class="hl kwa">new</span> <span class="hl kwd">Array</span><span class="hl opt">(</span> <span class="hl str">'1'</span><span class="hl opt">,</span><span class="hl str">'x'</span><span class="hl opt">,</span><span class="hl str">'2'</span><span class="hl opt">);</span>
    <span class="hl kwa">for</span> <span class="hl opt">(</span> <span class="hl kwa">var</span> i<span class="hl opt">=</span><span class="hl num">0</span><span class="hl opt">;</span> i <span class="hl opt">&lt;</span> midsize <span class="hl opt">;</span> i<span class="hl opt">++ ) {</span>
	<span class="hl kwa">var</span> equipo1 <span class="hl opt">=</span> equiposAqui<span class="hl opt">.</span><span class="hl kwd">splice</span><span class="hl opt">(</span>Math<span class="hl opt">.</span><span class="hl kwd">floor</span><span class="hl opt">(</span> equiposAqui<span class="hl opt">.</span>length<span class="hl opt">*</span>Math<span class="hl opt">.</span><span class="hl kwd">random</span><span class="hl opt">()) ,</span> <span class="hl num">1</span><span class="hl opt">);</span>
	<span class="hl kwa">var</span> equipo2 <span class="hl opt">=</span> equiposAqui<span class="hl opt">.</span><span class="hl kwd">splice</span><span class="hl opt">(</span>Math<span class="hl opt">.</span><span class="hl kwd">floor</span><span class="hl opt">(</span> equiposAqui<span class="hl opt">.</span>length<span class="hl opt">*</span>Math<span class="hl opt">.</span><span class="hl kwd">random</span><span class="hl opt">()),</span> <span class="hl num">1</span><span class="hl opt">);</span>
	quiniela<span class="hl kwc">[i]</span> <span class="hl opt">=</span> <span class="hl kwa">new</span> <span class="hl kwd">Nuevo_partido</span><span class="hl opt">(</span> equipo1<span class="hl opt">,</span> equipo2 <span class="hl opt">);</span>
	quiniela<span class="hl kwc">[i]</span><span class="hl opt">.</span><span class="hl kwd">setResultado</span><span class="hl opt">(</span> unox2<span class="hl opt">[</span>Math<span class="hl opt">.</span><span class="hl kwd">floor</span><span class="hl opt">(</span> <span class="hl num">3</span><span class="hl opt">*</span>Math<span class="hl opt">.</span><span class="hl kwd">random</span><span class="hl opt">()) ]);</span>
	quiniela<span class="hl kwc">[i]</span><span class="hl opt">.</span><span class="hl kwd">set_to_string</span><span class="hl opt">(</span> imprime <span class="hl opt">);</span>
    <span class="hl opt">}</span>
    <span class="hl kwa">return</span> quiniela<span class="hl opt">;</span>
<span class="hl opt">}</span>

<span class="hl kwa">var</span> quinielas <span class="hl opt">=</span> <span class="hl kwa">new</span> Array<span class="hl opt">;</span>
<span class="hl kwa">for</span> <span class="hl opt">(</span> <span class="hl kwa">var</span> i <span class="hl opt">=</span> <span class="hl num">0</span><span class="hl opt">;</span> i <span class="hl opt">&lt;</span> <span class="hl num">10</span><span class="hl opt">;</span> i <span class="hl opt">++ ) {</span>
  quinielas<span class="hl kwc">[i]</span> <span class="hl opt">=</span> <span class="hl kwd">jornada</span><span class="hl opt">(</span> equipos <span class="hl opt">);</span> 
<span class="hl opt">}</span>

<span class="hl kwa">var</span> resultados<span class="hl opt">=</span> <span class="hl kwa">new</span> Array<span class="hl opt">;</span>
<span class="hl kwa">for</span> <span class="hl opt">(</span> <span class="hl kwa">var</span> i <span class="hl kwa">in</span> equipos <span class="hl opt">) {</span>
  resultados<span class="hl opt">[</span>equipos<span class="hl kwc">[i]</span><span class="hl opt">]=</span><span class="hl num">0</span><span class="hl opt">;</span>
<span class="hl opt">}</span>

<span class="hl kwa">for</span> <span class="hl opt">(</span> <span class="hl kwa">var</span> i <span class="hl opt">=</span> <span class="hl num">0</span><span class="hl opt">;</span> i <span class="hl opt">&lt;</span> quinielas<span class="hl opt">.</span>length<span class="hl opt">;</span> i <span class="hl opt">++ ) {</span>
    <span class="hl kwa">for</span> <span class="hl opt">(</span> <span class="hl kwa">var</span> j <span class="hl opt">=</span> <span class="hl num">0</span><span class="hl opt">;</span>j <span class="hl opt">&lt;</span> quinielas<span class="hl kwc">[i]</span><span class="hl opt">.</span>length<span class="hl opt">;</span> j <span class="hl opt">++ ) {</span>
      <span class="hl kwa">var</span> local <span class="hl opt">=</span> quinielas<span class="hl kwc">[i][j]</span><span class="hl opt">.</span>local<span class="hl opt">;</span>
      <span class="hl kwa">var</span> visitante <span class="hl opt">=</span> quinielas<span class="hl kwc">[i][j]</span><span class="hl opt">.</span>visitante<span class="hl opt">;</span>
      <span class="hl kwa">var</span> resultado <span class="hl opt">=</span> quinielas<span class="hl kwc">[i][j]</span><span class="hl opt">.</span>resultado<span class="hl opt">;</span>
      <span class="hl kwa">switch</span> <span class="hl opt">(</span>resultado<span class="hl opt">) {</span>
    <span class="hl kwa">case</span> <span class="hl str">'1'</span><span class="hl opt">:</span>
	resultados<span class="hl kwc">[local]</span><span class="hl opt">+=</span><span class="hl num">3</span><span class="hl opt">;</span>
	<span class="hl kwa">break</span><span class="hl opt">;</span>
    <span class="hl kwa">case</span> <span class="hl str">'x'</span><span class="hl opt">:</span>
	resultados<span class="hl kwc">[local]</span><span class="hl opt">+=</span><span class="hl num">1</span><span class="hl opt">;</span>
	resultados<span class="hl kwc">[visitante]</span><span class="hl opt">+=</span><span class="hl num">1</span><span class="hl opt">;</span>
	<span class="hl kwa">break</span><span class="hl opt">;</span>
    <span class="hl kwa">default</span><span class="hl opt">:</span>
	resultados<span class="hl kwc">[visitante]</span><span class="hl opt">+=</span><span class="hl num">3</span><span class="hl opt">;</span>
    <span class="hl opt">}</span>
  <span class="hl opt">}</span>
<span class="hl opt">}</span>

<span class="hl kwa">for</span> <span class="hl opt">(</span> <span class="hl kwa">var</span> i <span class="hl kwa">in</span> resultados <span class="hl opt">) {</span>
  <span class="hl kwd">print</span><span class="hl opt">(</span> i <span class="hl opt">+</span> <span class="hl str">&quot;: &quot;</span> <span class="hl opt">+</span> resultados<span class="hl kwc">[i]</span><span class="hl opt">)</span>
<span class="hl opt">}</span></code>

<p>Como en todos los scripts, habrá que tener en cuenta que la primera
  línea, <code>#!/usr/bin/js</code>, tendrá que sustituirse por el
  intérprete de JavaScript que usemos
  (<code>rhino</code>, <code>gjs</code>, <code>node</code> o el que
  sea; en este último caso es probable que la línea
  sea <code>/usr/bin/local/node</code>). La parte nueva de este programa está en en la línea 9, donde se
  define la variable <code>imprime</code>. Se define una función <em>sin
    nombre</em> (lo que se suele denominar un <em>closure</em> o
  función anónima) a la que podemos acceder mediante la variable que
  le hemos asignado. Lo importante de esta sintaxis es que las
  funciones son variables de pleno derecho, que podemos usar como
  parámetros de otras funciones; esto se usará de forma extensiva
  cuando veamos jQuery y node.js.</p>




<h3><a name='T1:t1:common'> CommonJS, una infraestructura común para carga de módulos </a> </h3>



<p>Uno de los problemas de JS es que, al haber sido desarrollado
  principalmente para trabajar en el navegador, carece de una serie de
  librerías comunes para trabajar en el servidor o en aplicaciones de
  escritorio. <a href='http://www.commonjs.org'>CommonJS</a> es un intento
  de dar tal infraestructura. Principalmente se trata de proveer una
  serie de especificaciones para hacer cosas comunes, desde o más
  simple, que es crear un módulo o librería hasta cosas más complejas:
  interacción con consola o con línea de órdenes. </p>

<p>Por lo pronto la especificación que ha tenido más éxito es la de
  módulos, que <a href='http://dailyjs.com/2010/10/18/modules/'>se
  resume en este artículo</a>; se trata de que un módulo escrito para
  un intérprete (Rhino, por ejemplo) pueda funcionar en otro (tal como
  node.js). Vamos a ver cómo adaptaríamos alguna de las cosas hechas a
  este estándar, por ejemplo, cambiando esto sobre la clase
  Nuevo_partido.js creada anteriormente (la
  llamamos <a href='https://github.com/JJ/curso-js/tree/master/codeUn_Partido.js'>Un_Partido</a>).</p> 
<code class='ejemplo'>exports<span class="hl opt">.</span>Un_Partido <span class="hl opt">=</span> <span class="hl kwa">function</span> <span class="hl opt">(</span>local<span class="hl opt">,</span>visitante<span class="hl opt">,</span>resultado<span class="hl opt">) {</span>
    <span class="hl kwa">this</span><span class="hl opt">.</span>local <span class="hl opt">=</span> local<span class="hl opt">;</span>
    <span class="hl kwa">this</span><span class="hl opt">.</span>visitante<span class="hl opt">=</span>visitante<span class="hl opt">;</span>
    <span class="hl kwa">this</span><span class="hl opt">.</span>resultado<span class="hl opt">=</span>resultado<span class="hl opt">;</span>
    <span class="hl kwa">this</span><span class="hl opt">.</span>setResultado <span class="hl opt">=</span> setResultado<span class="hl opt">;</span>
    <span class="hl kwa">this</span><span class="hl opt">.</span>toString <span class="hl opt">=</span> toString<span class="hl opt">;</span>
    <span class="hl kwa">this</span><span class="hl opt">.</span>set_to_string <span class="hl opt">=</span> set_to_string<span class="hl opt">;</span>
    <span class="hl kwa">this</span><span class="hl opt">.</span>impresor <span class="hl opt">=</span> _toString<span class="hl opt">;</span>
<span class="hl opt">}</span>
</code>

<p>El único cambio ha sido que en vez de definir la función
  directamente, se define como un atributo de <code>exports</code>. El resto, al
  ser atributos de ese objeto, no hace falta que lo definamos de la
  misma forma. Al llamarlo también habrá un pequeño cambio. Mientras
  que antes teníamos que hacer un eval sobre lo cargado, ahora basta
  con (<a href='https://github.com/JJ/curso-js/tree/master/codeusa_partido.js'>programa
  usa_partido.js</a>):</p>
<code class='ejemplo'><span class="hl kwa">var</span> un_partido <span class="hl opt">=</span> <span class="hl kwd">require</span><span class="hl opt">(</span><span class="hl str">'./Un_Partido.js'</span><span class="hl opt">);</span>

<span class="hl kwa">var</span> este_partido <span class="hl opt">=</span> <span class="hl kwa">new</span> un_partido<span class="hl opt">.</span><span class="hl kwd">Un_Partido</span><span class="hl opt">(</span> <span class="hl str">'este'</span><span class="hl opt">,</span><span class="hl str">'otro'</span><span class="hl opt">,</span><span class="hl str">'1'</span><span class="hl opt">);</span>
console<span class="hl opt">.</span><span class="hl kwd">log</span><span class="hl opt">(</span><span class="hl str">'Resultado '</span> <span class="hl opt">+</span> este_partido<span class="hl opt">.</span><span class="hl kwd">toString</span><span class="hl opt">());</span>
</code>
<p>Este módulo ya se comporta como el resto de los módulos de Node,
  haciendo falta usar sólo require (con el camino completo) para
  cargarlo. Ahora, con require lo que definimos es un objeto, y las
  funciones son atributos de ese objeto; por lo que a la hora de
  declarar nuevos objetos de esa clase tendremos que hacerlo
  con <code>new un_partido.Un_Partido</code>. A partir de ahí el
  objeto generado se comporta exactamente igual que cualquier otro
  objeto, como podemos ver usando console. 


<p>A diferencia de casi todos los lenguajes de scripting, no hay un
  modo estándar de instalar módulos JavaScript, aunque algunos
  intérpretes (notablemente Node.js, del que hablaremos luego) sí lo
  tienen. De hecho, ni siquiera common.js es universal, existiendo
  otras convenciones que le hacen la competencia tales
  como <a href='http://requirejs.org/'>require.js</a>. La principal
  ventaja de common.js es su aceptación por parte de node.js,
  precisamente y su uso en NPM, por eso cabe suponer que el resto
  empezarán, más o menos, a usarlo. En todo
  caso, <a href='http://requirejs.org/docs/commonjs.html'>son
    enfoques diferentes</a>, uno se concentra en la forma de cargar
  el módulo mientras que otro se concentra en la forma de
  empaquetarlo. </p>

<h3> Para finalizar</h3>

<p>Cualquiera de los recursos que listo ahí abajo pueden resultar
      útiles para ampliar información sobre JavaScript. Quizás también
      pueda ser interesante usar alguna librería que facilite su uso
      como <a href='http://mochi.github.com/mochikit/'>Mochikit</a> o <a
	href='http://www.prototypejs.org/'>Prototype</a>. También el
      <a href='http://code.google.com/webtoolkit/'>Google Web
	Toolkit</a> permite desarrollar en AJAX programando sólo en
      Java, aunque pueda que el JS generado necesite algún retoque
      adicional. </p>

<h3><a name='T1:t1:agra'> Agradecimientos </a> </h3>

<p>Agradezco a los <a
	href='http://barrapunto.com/comments.pl?sid=69179'>comentaristas</a>
	de <a href='http://barrapunto.com/comments.pl?sid=68032'>los
	diferentes anuncios</a>
	que <a href='http://barrapunto.com/comments.pl?sid=67899'>publiqué
	en Barrapunto</a> sus comentarios y sugerencias. También a
	Javier Espigares por la lectura y comentarios sobre las
	versiones previas de este tema y el anterior.</p>  

<h3><a name='T1:t1:biblio'> Bibliografía </a> <a href='#T1:t1:biblio' style='font-size:small'>#</a></h3>



<p>Hay dos libros fundamentales para aprender JS, aunque están muy
      enfocados a JS en el navegador:<a
	href='http://bencore.ugr.es/iii/encore/record/C|Rb2011082|Sjavascript+definitive+guide|Orightresult|X2?lang=spi&suite=pearl'> <em>JavaScript: The Definitive
    Guide</em>, el libro del rinoceronte</a>, editado por O'Reilly, que
      está <a href='http://proquest.safaribooksonline.com/9781449393854?uicode=goliat'>disponible
    como recurso electrónico en la UGR</a> y <a href='http://bencore.ugr.es/iii/encore/record/C|Rb1987808|Sjavascript+bible|Orightresult|X5?lang=spi&suite=pearl'>	<em>JavaScript Bible, de Danny Goodman</em>, un tocho considerable</a>,
	en el que hay de todo, y que viene con un útil CD con
	ejemplos. También está como  <a
					href='http://proquest.safaribooksonline.com/?uiCode=goliat&xmlId=9780470526910'>recurso
      electrónico</a>. Hay <a href='http://bencore.ugr.es/iii/encore/search/C|Sjavascript|Orightresult|U1?lang=spi&suite=pearl'>muchos
      más recursos, algunos de ellos disponibles de forma electrónica</a>.</p>

<p>Como recursos adicionales, <a
	href='
	https://developer.mozilla.org/en-US/docs/JavaScript/About_JavaScript?redirectlocale=en-US&redirectslug=About_JavaScript'>las
	páginas de JavaScript en Mozilla.org</a>,
	el <a href='http://www.ecma-international.org/publications/standards/Ecma-262.htm'>estándar
	completo</a>, y
	el <a href='http://geneura.ugr.es/~victor/cursillos/javascript/js_intro.html'>curso
	de JavaScript de Víctor Rivas Santos</a>. </p> 


<h2 name='jquery'>JavaScript en el navegador y JQuery</h2>



<div class='objetivos'> <ul>
	  
	  <li>Trabajar con JavaScript en el navegador</li>
	  <li>Usar librerías populares de JavaScript en ese contexto</li>

      </ul>
</div>  

<h3><a name='TJ:t1:DOM'> El modelo de objetos </a></h3>


  <p>Ya no es tan difícil encontrar un enfoque como el de este curso,
      centrado en JS como lenguaje y no como un chisme más dentro del
      navegador. Eventualmente, habrá que tratar con esto, así que
      este momento es tan bueno como cualquier otro. En realidad, la
      mayor diferencia entre JS-sin-navegador y JS-con-navegador es el
      bagaje de objetos con el que tiene que trabajar y también el
      modelo que se va a usar para entrada y salida: la propia
      <em>página</em> en la que está inserto el programa.</p>

<p>En general, lo que hace un navegador es analizar el HTML que le
      envía el servidor y convertirlo en un árbol, el <a href='http://es.wikipedia.org/wiki/DOM'>DOM</a> o <em>document
      object model</em>. Todo lo que hay en el documento es una hoja o un
      nudo dentro de ese árbol. Lo importante es que los programas JS,
      aparte de ser hojas dentro de ese árbol, también actúan sobre
      ese árbol, añadiendo o quitando hojas, o simplemente alterando
      sus propiedades. El DOM está definido como un <a
	href='http://www.w3.org/DOM/'>estándar del W3</a>, pero eso no
      quita que haya problemas de compatibilidad entre los diferentes
      navegadores. Por ejemplo, <a
	href='https://developer.mozilla.org/en/docs/Gecko_DOM_Reference'>Mozilla</a> tiene su modelo de objetos, que usa en sus navegadores, los más bonitos del mundo mundial. </p>

<p>Para empezar, vamos a ver qué pinta tiene el DOM de un documento
      cualquiera. Por ejemplo, usemos esta misma página, que para eso
      está ya en HTML. En Firefox, se ve el DOM completo con la
      combinación de teclas Ctrl+Shift+I. Para ésta página, saldría
      algo así:
<img src='imagenes/AAP-DOM.png' alt='DOM de una página' >
La estructura es la que cabe esperar: hay un nodo raíz, etiquetado
      como <code>document</code>, del que descienden las dos partes del documento
      HTML: <code>HEAD</code> y <code>BODY</code>. Y de ahí, pues el resto.</p>

<p>Todos las herramientas relacionadas con la página web, como el CSS,
      trabajan y tienen en cuenta esta estructura DOM del documento. Y
      cuando un programa JS se ejecuta dentro de un documento, puede
      alterar su estructura. Veámoslo, por ejemplo, en el <a
	href='https://github.com/JJ/curso-js/blob/master/code/docwrite.html'><code>docwrite.html</code></a>:</p>
<code class='ejemplo'><span class="hl kwa">&lt;!DOCTYPE</span> HTML PUBLIC <span class="hl str">&quot;-//W3C//DTD HTML 4.01 Transitional//EN&quot;</span><span class="hl kwa">&gt;</span>
<span class="hl kwa">&lt;html&gt;</span>
  <span class="hl kwa">&lt;head&gt;</span>
    <span class="hl kwa">&lt;title&gt;</span>Prueba document.write<span class="hl kwa">&lt;/title&gt;</span>
<span class="hl kwa">&lt;script</span> type='application/javascript'<span class="hl kwa">&gt;</span>
      function setColor( color ) {
      document.getElementById('color').style.background =color;
      }
<span class="hl kwa">&lt;/script&gt;</span>
  <span class="hl kwa">&lt;/head&gt;</span>

  <span class="hl kwa">&lt;body&gt;</span>
    <span class="hl kwa">&lt;h1&gt;</span>Prueba document.write<span class="hl kwa">&lt;/h1&gt;</span>

<span class="hl kwa">&lt;p&gt;&lt;input</span> type='text' name='color' value='Color (in inglis)' onChange='setColor(value)' <span class="hl kwa">/&gt;&lt;/p&gt;</span>

<span class="hl kwa">&lt;div</span> id='color'<span class="hl kwa">&gt;</span><span class="hl kwd">&amp;nbsp;&amp;nbsp;</span><span class="hl kwa">&lt;/div&gt;</span>
    <span class="hl kwa">&lt;hr&gt;</span>
    <span class="hl kwa">&lt;address&gt;&lt;a</span> <span class="hl kwb">href</span>=<span class="hl str">&quot;mailto:jmerelo&#64;localhost.localdomain&quot;</span><span class="hl kwa">&gt;</span>Juan J. Merelo<span class="hl kwa">&lt;/a&gt;&lt;/address&gt;</span>
<span class="hl com">&lt;!-- Created: Wed Feb 21 18:45:35 CET 2007 --&gt;</span>
<span class="hl com">&lt;!-- hhmts start --&gt;</span>
Last modified: Sun Feb <span class="hl num">25 18</span>:<span class="hl num">57</span>:<span class="hl num">52</span> CET <span class="hl num">2007</span>
<span class="hl com">&lt;!-- hhmts end --&gt;</span>
  <span class="hl kwa">&lt;/body&gt;</span>
<span class="hl kwa">&lt;/html&gt;</span>

</code>

<p>que crearía un DOM con el aspecto siguiente:
<img src='imagenes/nuevonodo.png' alt='Creación de un nodo en el DOM
	con JS'>
Como se ve, el nodo <code>P</code> sigue al nodo <code>script</code>, es decir, que el nodo
      se crea en el DOM justamente siguiendo al nodo que incluye el
      script. En realidad, se crean tantos nodos como a uno le
      interese, pero de esta forma sólo se pueden colocar en el sitio
      donde está el script. Así que habrá que imaginar otra forma de
      hacerlo.</p>

<p>Navegar por el modelo de objetos no es excesivamente complicado,
      gracias a las funciones <code>getElementsBy*</code>, que escogen elementos
      del DOM de acuerdo con alguna
      característica. <code>getElementsByTagName</code> escoge elementos por el
      nombre de la etiqueta, mientras que <code>getElementById</code> usa el
      atributo <code>id</code>; nótese la diferencia entre <code>Elements</code> y
      <code>Element</code>; en el primer caso se devuelve un <code>Array</code> y en el
      segundo uno solo, porque la Id es única. Cuando se trabaja con
      un documento, habrá que 
      usar de forma sabia los atributos y clases de forma que sea
      fácil escoger y trabajar con los elementos de un tipo
      determinado, o con un elemento en concreto. Por ejemplo,
      <code>getElementByTagName('h2')</code> devolverá un array con
      todos los elementos que tengan esa etiqueta, y
      <code>getElementById('ej.t1.3')</code> devolverá el tercer
      bloque de ejercicios de este tema, como veremos en el ejemplo
      siguiente (que está incluido en la misma página):</p>

<code class='ejemplo'>Bloque  <input type="text" name="bloque"
				     value="1" onChange='putBloque(value)'></code>
<div id='resultado1'>&nbsp;</div>
<script type='application/javascript'>function putBloque(value) {
	  var ejs = document.getElementsByTagName('h2');
	  document.getElementById('resultado1').innerHTML=ejs[value].textContent;
}</script>
<code class='ejemplo'><span class="kwa">function</span> <span class="kwd">putBloque</span><span class="sym">(</span><span class="kwc">value</span><span class="sym">) {</span>
	  <span class="kwa">var</span> ejs <span class="sym">=</span> <span class="kwc">document</span><span class="sym">.</span><span class="kwc">getElementById</span><span class="sym">(</span><span class="str">'ej.T1.'</span><span class="sym">+</span><span class="kwc">value</span><span class="sym">);</span>
	  <span class="kwc">document</span><span class="sym">.</span><span class="kwc">getElementById</span><span class="sym">(</span><span class="str">'resultado1'</span><span class="sym">).</span><span class="kwc">innerHTML</span><span class="sym">=</span>ejs<span class="sym">.</span>textContent<span class="sym">;</span>
<span class="sym">}</span>
<!--HTML generated by highlight 2.4.8, http://www.andre-simon.de/-->
      </code>

<p>Un par de líneas sólo de JS: una para buscar el elemento (la
      primera) y la segunda para extraer su contenido (<code>textContent</code>)
      e introducirlo en otro, el elemento <code>resultado1</code> que teníamos
      preparado al efecto. <code>innerHTML</code> es el HTML interno de un
      elemento: al asignarle un valor, efectivamente, sustituimos
      parte del contenido de la página dinámicamente. ¿No es una
      maravilla? </p>



<h3><a name='TJ:t1:greasemonkey'> Usando GreaseMonkey </a></h3>

<p>No se sabe porqué los temas de JS tienen tanta relación con los
      primates, pero el hecho es que <a
	href='http://greasespot.com'>GreaseMonkey</a>
  (o <a href='http://tampermonkey.net/'>TamperMonkey</a>, su
      equivalente en Chrome, Chromium y Opera Next, que tiene
      una <em>capa de compatibilidad</em> que permite ejecutar estos scripts) es un <em>plugin</em>
      para los navegadores <a href='http://mozilla.org'>Mozilla</a>
      que permite instalar en el navegador programillas JS específicos
      de una página o grupo de páginas. Para trabajar con él, lo
      primero que hay que hacer es instalarlo
      (Herramientas->Complementos en Firefox y
      Herramientas->Extensiones en Chrome y Chromium) y reiniciar el
      navegador.</p>

<p>Una vez hecho eso, Grease/TamperMonkey reconoce los scripts con la
      extensión <code>.user.js</code> como propios (es decir, los abre
      cuando se descargan desde una web o se abre el fichero),  los instala, y
      permite gestionarlos, activarlos, y desactivarlos, desde un
      icono con un monito en la barra inferior del navegador. O sea,
      que una vez que se vea el monito, podemos cargar <a
	href='https://github.com/JJ/curso-js/blob/master/code/aap-nav.user.js'>este programa
	(<code>aap-nav.user.js</code>)</a> que lo usa:</p>
<code class='ejemplo'>// ==UserScript==
// @name                AAP-Nav
// @namespace           http://geneura.org/projects/greasemonkey
// @description         Navegación por las secciones de AAP
// @include             http://geneura.ugr.es/~jmerelo/asignaturas/*
// ==/UserScript==

GM_log('Entrando AAP-Nav');
var h2 = document.getElementsByTagName('h2');
var a_nodes = new Array;
var anchors = new Array;
for ( var secs = 0; secs < h2.length; secs ++ ) {
  var thisA = h2[secs].getElementsByTagName('a');
  a_nodes[secs] = thisA[0];
  anchors[secs] = thisA[0].getAttribute('name');
  GM_log('Anchor ' + secs + " " + anchors[secs]);
}



for ( var secs = 0; secs < h2.length; secs ++ ) {
  var span = document.createElement('span');
  span.setAttribute('style','background:lightblue');
  if ( secs > 0 ) {
    var ahref = document.createElement('a');
    ahref.setAttribute('href','#'+anchors[secs-1]);
    var txt=document.createTextNode('^');
    ahref.appendChild(txt);
    span.appendChild(ahref);
  }
  if ( secs < h2.length -1  ) {
    span.appendChild(document.createTextNode(' | '));
    var ahref = document.createElement('a');
    ahref.setAttribute('href','#'+anchors[secs+1]);
    var txt=document.createTextNode('v');
    ahref.appendChild(txt);
    span.appendChild(ahref);
  }
  a_nodes[secs].parentNode.insertBefore(span,a_nodes[secs]);
}
</code>

<p>Este programa añade unas flechitas de navegación a una página que
  incluya cabeceras <code>h2</code> de forma que se pueda pasar de cada sección a
      la anterior a la siguiente (de ahí lo de aap-nav). Tiene dos
      partes: la primera parte halla las etiquetas de navegación, y la
      segunda las inserta. Tres partes, de hecho, si incluimos las
      declaraciones del principio, que son para uso y disfrute del
      propio GreaseMonkey. Las dos primeras son terminológicas: cómo
      se llama, y qué espacio de nombres usa. Esto es para distinguir
      scripts con el mismo nombre de diferentes fuentes. La tercera,
      una descripción, aparece en los directorios correspondientes y
      cuando gestionamos los scripts.</p>

<p>El cuarto apartado es el más importante. Es un patrón de las
      páginas en las que va a funcionar el script. Éste no tendría
      sentido fuera de las páginas de la asignatura en la que estaban
      incluidos originalmente estos apuntes, así
      que incluimos en el mismo simplemente a las que hay en ese
      directorio. Cuando el navegador cargue alguna página con ese
      patrón, GM lo detectará y cargará el script; para que trabaje
      sobre otro conjunto de páginas habrá que poner el patrón correspondiente.</p>

<p>El programa en sí hace uso de los elementos explicados en la
      sección anterior: extrae del documento los títulos de capítulo
      (h2) y de ahí los <em>anchor</em> (<code>a name</code>) y sus
      atributos, metiendo todo lo metible en un bucle. Hace falta
      tenerlos todos en un array, por eso se usa un segundo bucle para
      insertar en la página los elementos de navegación.</p>

<p>Este segundo bucle crea elementos a tutiplén, usando
      <code>createElement</code> (para crear un elemento), <code>setAttribute</code> (para
      poner su atributo) y <code>createTextNode</code> (para meter texto dentro
      de los elementos). Luego, a modo de injerto, se van metiendo los
      elementos unos dentro de otros usando <code>appendChild</code>. Y,
      finalmente, se insertan los elementos creados en el documento en
      la penúltima línea:</p>
<div
      class='ejemplo'>a_nodes[secs].parentNode.insertBefore(span,a_nodes[secs]);</div>
<p>que navega desde el <em>ancla</em> hasta su padre (<code>parentNode</code>) e
      inserta antes del mismo (<code>insertBefore</code>) el <code>span</code> que hemos
      creado previamente. El resultado, si todo ha ido bien, deberías
      verlo en este mismo tutorial.</p>

<p>Además, hace uso de algunas funciones propias de GM:
      <code>GM_log</code>, que escribe en la consola de
      JavaScript. Muy útil para depurarlo, inútil en producción; pero
      si abres la consola de JS verás los mensajes que ha usado.</p>

<p>Para usarlo con TamperMonkey, hay que
  marcar <a href='http://tampermonkey.net/#features'>las opciones de
    compatibilidad con GreaseMonkey y Firefox</a>, aunque también trata de
    detectar las opciones necesarias automáticamente.</p>



<h3><a name='TJ:tj:wins'> Trabajando con otras ventanas </a></h3>



<p>Una de las características específicas del DOM es la posibilidad de
  trabajar con otras ventanas, creando contenido y presentándolo en
  las mismas. Para eso se usa el objeto <code>window</code>; lo interesante de
  este elemento eso que está incluido en el propio DOM, por lo que se
  puede usar desde JavaScript como hacemos en el siguiente
  programa. No es que sea aconsejable, por cierto; debe usarse sólo
  en caso de que sea imprescindible (a veces se usa para
  autenticación, por ejemplo, o para no crear elementos nuevos en el
  interfaz). Por ejemplo, se hace así
  en <a href='https://github.com/JJ/curso-js/blob/master/code/windowopen.html'>este programa</a></p>
<code class='ejemplo'><span class="hl kwa">&lt;!DOCTYPE</span> HTML PUBLIC <span class="hl str">&quot;-//W3C//DTD HTML 4.01 Transitional//EN&quot;</span> <span class="hl str">&quot;http://www.w3.org/TR/html4/loose.dtd&quot;</span><span class="hl kwa">&gt;</span>
<span class="hl kwa">&lt;html&gt;</span>
<span class="hl kwa">&lt;head&gt;</span>
<span class="hl kwa">&lt;meta</span> <span class="hl kwb">http-equiv</span>=<span class="hl str">&quot;Content-Type&quot;</span> <span class="hl kwb">content</span>=<span class="hl str">&quot;text/html; charset=iso-8859-15&quot;</span><span class="hl kwa">&gt;</span>
<span class="hl kwa">&lt;title&gt;</span>Probando window.open<span class="hl kwa">&lt;/title&gt;</span>
<span class="hl kwa">&lt;script</span> type='application/javascript'<span class="hl kwa">&gt;</span>
var contenido = <span class="hl str">&quot;&lt;html&gt;&lt;head&gt;&lt;title&gt;Mi ventanita&lt;/title&gt;&lt;/head&gt;&lt;body&gt;&lt;h1&gt;Mi ventanita&lt;/h1&gt;&lt;/body&gt;&lt;/html&quot;</span>;
newwindow=window.open();
newdocument=newwindow.document;
newdocument.write(contenido);
<span class="hl kwa">&lt;/script&gt;</span>
</code>
<p>En este caso, se crea una nueva página estática usando <code>write</code>
  sobre el documento que hemos creado. No es que sea demasiado útil
  (se podría usar el URL directamente pasándoselo como parámetro a
  <code>open</code>) pero demuestra las posibilidades del mismo, que también se
  pueden ver
  en <a href='http://www.htmlgoodies.com/beyond/javascript/javascript-dynamic-document-creation-in-new-windows.html'>este mini-tutorial</a>.</p>


<h3><a name='TJ:tj:selectores'> Selectores </a></h3>


<p>Las hojas de estilo <a href='http://es.wikipedia.org/wiki/CSS'>CSS</a> son una especificación de la
  apariencia de elementos tanto HTML como XML que permiten asignar
  parámetros de presentación específico a cada elemento o a grupos de
  ellos. No es el objetivo de este manual enseñarlas, pero su
  utilidad va más allá de la mera apariencia, permitiendo designar
  (usando IDs) y agrupar (usando <em>clases</em>) elementos o grupos de los
  mismos. Cuando hemos hablado anteriormente de seleccionar un solo
  elemento por la id, estamos usando un tipo de selector básico; sin
  embargo, si queremos trabajar con selectores más generales (como
  haremos más adelante) es conveniente que se aprenda la sintaxis de
  CSS que es la que se usa de forma más general.</p>

<p>La <a href='http://www.w3.org/TR/CSS2/selector.html'>sintaxis más
    general está especificada por la W3</a> y se puede observar en
    cualquier hoja de estilo. De esta,
    extraemos <a href='http://net.tutsplus.com/tutorials/html-css-techniques/the-30-css-selectors-you-must-memorize/'>los
    30 selectores que se deben memorizar</a>, principalmente <code>#</code> que
    se refiere a un id específico (por ejemplo, <code>#ej.1.1</code>
    seleccionaría un div declarado como <code>div id='ej1.1.1'</code>
    y <code>.</code> que se refiere a una clase; <code>.ej</code> por ejemplo seleccionaría
  todos los div declarados así: <code>div class='ej'</code>.</p>

<h3><a name='TJ:tj:eventos'> Eventos </a> </h3>



<p>Para entender bien el uso de JavaScript en el navegador es
  conveniente introducir el concepto de eventos. Se trata simplemente
  de señales generadas por el mismo, o bien registradas por el usuario
  (es decir, introducidas por el usuario cuando suceda algo
  determinado). El navegador, por ejemplo, genera un evento cuando el
  ratón entra o sale de un elemento, cuando se carga la página, o
  cuando se pulsa el ratón sobre un elemento
  activo. He <a href='http://www.koderguru.com/tutorials/javascript/javascriptevents.php'>la
  lista de todos los eventos y de los elementos a los que
  afectan</a>. Los eventos permiten por un lado trabajar con un patrón
  de programación reactiva, en la que se reacciona a lo que va
  sucediendo en el navegador y, a la vez, un cierto grado de
  concurrencia porque cada evento sucede en una hebra
  diferente. También se trabaja de forma asíncrona, porque en muchos
  casos no se llevarán a cabo de forma secuencial sino cuando se
  cumplan ciertas condiciones.</p>

<P>La forma más simple de trabajar con eventos es usar los atributos
  de un elemento HTML para activarlos, como <a href='#'
  onClick='alert("Esto es un evento activado")'>aquí mismo</a>. El
  atributo <code>onClick</code> tiene como valor directamente una llamada a una
  función en JS que se activa cuando se pulsa el botón sobre este tipo
  de elemento.</p>

<p>Hay <a href='http://101.lv/learn/JSweek/ch5.htm'>una docena
    de eventos</a>, pero no todos se usan con la misma asiduidad. Uno que
    se usa habitualmente es el evento <code>load</code>, que ejecuta algo sólo
    cuando se ha cargado la página completa. El comienzo de ejecución
    de cualquier elemento de JS conviene, como buena práctica, que se
    haga tras el evento onLoad, porque si no se ha terminado de cargar
    puede que el DOM no esté completo o que no lo estén las
    definiciones de algunos elementos que el programa JS pueda
    necesitar. El evento <code>load</code> sólo se activa desde el elemento
  <code>body</code>, como en <a href='https://github.com/JJ/curso-js/blob/master/code/onload.html'>este ejemplo</a></p>

<code class='ejemplo'><span class="hl kwa">&lt;!DOCTYPE</span> HTML PUBLIC <span class="hl str">&quot;-//W3C//DTD HTML 4.01 Transitional//EN&quot;</span> <span class="hl str">&quot;http://www.w3.org/TR/html4/loose.dtd&quot;</span><span class="hl kwa">&gt;</span>
<span class="hl kwa">&lt;html&gt;</span>
<span class="hl kwa">&lt;head&gt;</span>
<span class="hl kwa">&lt;meta</span> <span class="hl kwb">http-equiv</span>=<span class="hl str">&quot;Content-Type&quot;</span> <span class="hl kwb">content</span>=<span class="hl str">&quot;text/html; charset=iso-8859-15&quot;</span><span class="hl kwa">&gt;</span>
<span class="hl kwa">&lt;title&gt;</span>Probando onLoad<span class="hl kwa">&lt;/title&gt;</span>
<span class="hl kwa">&lt;/head&gt;</span>

<span class="hl kwa">&lt;body</span> onLoad='alert(<span class="hl str">&quot;Ahora está todo cargado&quot;</span>)'<span class="hl kwa">&gt;</span>
<span class="hl kwa">&lt;h1&gt;</span>Esta es una página que no tiene gran cosa<span class="hl kwa">&lt;/h1&gt;</span>

<span class="hl kwa">&lt;p&gt;</span>Pero podría
tenerla.<span class="hl kwa">&lt;/p&gt;</span></code>

<p>El uso de evento está hacia el final del código, donde usamos
  <code>alert</code> que se activa tras el evento <code>load</code>, es decir, cuando se
  carga la página</p>


<h3><a name='TJ:tj:jq'> JQuery: Introducción </a> <a href='#TJ:tj:jq' style='font-size:small'>#</a></h3>


  <p><a href='http://jquery.com'>JQuery</a> es una librería en
  JavaScript que está diseñada principalmente para simplificar la
  creación de programas y permitir crear interfaces ricos de
  usuario. <a href='http://es.wikipedia.org/wiki/JQuery'>JQuery</a> se ha popularizado desde su creación en el
  año 2006 hasta el punto que se calcula que se usa en más de la mitad
  de los sitios más populares. Por supuesto, es software libre con una
    <a href='http://en.wikipedia.org/wiki/MIT_License'>licencia
    MIT</a>. Ha sido aceptada también e integrada por casi todas las
    grandes empresas que crean herramientas de desarrollo de software
    e incluso Google aloja directamente una copia de JQuery que se
    puede usar desde cualquier programa.</P>

  <p>A vista de pájaro, JQuery introduce un objeto, <code>$</code>,
    que permite acceder a todas sus funciones. Podemos empezar con la
    función <code>ready</code> en el <a href='https://github.com/JJ/curso-js/blob/master/code/ready.html'>siguiente
    programa</a>:</p>
<code class='ejemplo'><span class="hl kwa">&lt;html&gt;</span>
<span class="hl kwa">&lt;head&gt;</span>
<span class="hl kwa">&lt;meta</span> <span class="hl kwb">http-equiv</span>=<span class="hl str">&quot;Content-Type&quot;</span> <span class="hl kwb">content</span>=<span class="hl str">&quot;text/html; charset=iso-8859-15&quot;</span><span class="hl kwa">&gt;</span>
<span class="hl kwa">&lt;script</span> <span class="hl kwb">src</span>=<span class="hl str">&quot;http://ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js&quot;</span><span class="hl kwa">&gt;&lt;/script&gt;</span>
<span class="hl kwa">&lt;title&gt;</span>Probando ready de jQuery<span class="hl kwa">&lt;/title&gt;</span>
<span class="hl kwa">&lt;/head&gt;</span>

<span class="hl kwa">&lt;body&gt;</span>
<span class="hl kwa">&lt;h1&gt;</span>Esta es una página que no tiene gran cosa<span class="hl kwa">&lt;/h1&gt;</span>

<span class="hl kwa">&lt;p&gt;</span>Pero podría tenerla.<span class="hl kwa">&lt;/p&gt;</span>
<span class="hl kwa">&lt;script</span> type='text/javascript'<span class="hl kwa">&gt;</span>
$(document).ready(function() {
    alert('Ahora estamos listos');
});
<span class="hl kwa">&lt;/script&gt;</span></code>

<p>En este caso, usamos como se ha indicado antes la copia de JQuery
  proporcionada por Google, que, como cualquier otra librería JS, debe
  ser incluida en nuestra página para ser usada. Por otro lado, la
  única función que usamos de JQuery está tras el párrafo: cuando el
  documento está <em>listo</em> (<code>ready</code>), lanzamos un <code>alert</code>. Este script
  funciona exactamente igual que como el que habíamos visto
  anteriormente.</p>

  <p>De hecho, se
  puede <a href='https://github.com/JJ/curso-js/blob/master/code/ready-simple.html'>simplificar</a> e incluso
  ahorrar la orden para pasar directamente a la función que queremos
    que se active cuando se cargue la página.</p>


<p>JQuery también simplifica el uso de selectores para extraer
  elementos del DOM, usando la misma sintaxis que hemos visto
  arriba: <code>$("selector")</code> permite extraer una serie de
  elementos que cumplan esa sintaxis que, como hemos visto más arriba,
  es la misma que se usa en las CSS. Lo vemos en
  el <a href='https://github.com/JJ/curso-js/blob/master/code/selectores.html'>siguiente ejemplo</a></p>

<code class='ejemplo'><span class="hl kwa">&lt;script</span> type='text/javascript'<span class="hl kwa">&gt;</span>
$(function() {
    var hachedoses ='';
    $(<span class="hl str">&quot;h2&quot;</span>).each( function() {
        hachedoses += this.textContent + <span class="hl str">&quot; - &quot;</span>;
    } );
    alert(hachedoses);
    $(<span class="hl str">&quot;#cambiando&quot;</span>).html( hachedoses ); 
});
<span class="hl kwa">&lt;/script&gt;</span>
<span class="hl kwa">&lt;h2&gt;</span>Este es un H2<span class="hl kwa">&lt;/h2&gt;</span>

<span class="hl kwa">&lt;h2&gt;</span>Este es otro H2<span class="hl kwa">&lt;/h2&gt;</span>

<span class="hl kwa">&lt;H2&gt;</span>Y este, lo adivinaste, otro<span class="hl kwa">&lt;/H2&gt;</span>

<span class="hl kwa">&lt;div</span> id='cambiando'
style='border:dashed'<span class="hl
				  kwa">&gt;&lt;/div&gt;</span></code>

<p>En este ejemplo, primero se recorren los elementos <code>h2</code> pero en vez
  de hacerse a partir de un bucle se usa directamente el objeto
  generado por el selector y que aplica a cada uno de ellos una
  función anónima; en este caso la función concatena a <code>hachedoses</code> el
  contenido en texto del elemento. Usamos el <code>alert</code> principalmente
  para que se vea el contenido del <code>div</code> definido más abajo vacío y
  posteriormente con el contenido que se le añade en la última línea
  del script, que usa como selector el equivalente a un elemento con
  el id <code>#cambiando</code>. </p>


<h2 name='nodejs'>Introducción a node.js</h2>


<div class="objetivos"> <ul>

	  <li>Conocer node.js y saber sus conceptos fundamentales.</li> 

	  <li>Aprender los conceptos básicos de los servicios web basados en 
<a href='#REST'>REST</a>, la representación de datos usada y cómo implementarlos en node.js</li> 
	  <li>Realizar prototipos rápidos de cliente y servidor de servicio web usando node.js</li>

      </ul>
</div>  


<h3> Node.js, un intérprete asíncrono para JS</h3>



<p>La aceptación de JS como un lenguaje de programación procede del hecho
  de su incorporación en diferentes herramientas de propósito general, 
  sobre todo a partir de haberlo desgajado del navegador en e
  introducido en
  herramientas como las que hemos comentado anteriormente. Una de tales
  herramientas es <a href="http://nodejs.org/">Node.js</a>, un marco
  para programación de eventos asíncrono que usa como base JS. Se puede usar
  directamente como intérprete de JS (tal como hemos
  hecho <a href="http://geneura.ugr.es/%7Ejmerelo/tutoriales/servicios-web">en este otro tutorial</a>), salvo por el hecho de que
  está preparado para trabajar de forma asíncrona, por lo que un
  patrón habitual de comportamiento, que es asignar la salida de una
  orden a una variable, se convierte aquí en la creación de un
  <em>callback</em>, es decir, de una función a la que se llama una vez que se
  complete la acción que se ha solicitado. No es que sea algo extraño
  dentro del mundo JS, puesto que es la misma forma de trabajar que
  tiene <a href="#jquery">JQuery</a>.</p>

<p>En todo caso, node.js incluye una serie de bibliotecas básicas que convierten JS en un lenguaje de propósito
  general, algo que le falta a otros intérpretes como Rhino, que
  necesita usar librerías de Java para poder hacer cosas básicas como
  abrir ficheros. Empecemos pues, por el principio: instalar node.js,
  lo que se puede hacer en Linux fácilmente con <code>sudo apt-get
    install nodejs</code>, desde los repositorios, o
  <a href="http://nodejs.org/download/">descargándoselo desde su
  web</a>. Conviene usar este último método, porque es un lenguaje en
  evolución constante, de forma que los repositorios de Linux van
  siempre un poco por detrás. </p>

<div class='aclara'><p>No hace falta instalar node.js para empezar a
  usarlo. Algunos PaaS como <a href='http://heroku.com'>Heroku</a> te
  proporcionan tanto una serie de herramientas para prototipar y
  publicar aplicaciones basadas en node.js como una línea de órdenes
    de la que usarla directamente.</p>

<p>Por otro lado, otra opción conveniente
  es <a href='https://gist.github.com/isaacs/579814'>instalar <code>nave</code></a>,
  un entorno virtual que permite trabajar simultáneamente con
  diferentes versiones de node y, sobre todo, tener la última versión,
  más allá de la que proporcione la distribución. </p>

  <p>Como última opción de instalación en una máquina <em>limpia</em> que use Linux (lo que
  debería ser obvio, Windows automáticamente ensucia la máquina en la
  que se instala) se pueden
    seguir <a href='https://gist.github.com/JJ/8459799'>estas
  instrucciones</a> para instalar los prerrequisitos y la última
    versión de node.</p>

<p>Para terminar, hay algunos sitios en Internet que permiten
  ejecutar, directamente desde el navegador, un terminal sobre una
  máquina virtual; algunos incluyen node.js ya instalado de serie. Por
  ejemplo, <a href='http://koding.com/R/jjmerelo'>Koding</a> permite
  abrir un <a href='https://koding.com/Terminal' title='tendrás que
	      estar conectado para que esto funcione'>terminal</a>
  donde, además, puedes dejar ejecutándose tus programas y acceder a
  ellos desde fuera.</p>

<p>En este tutorial aconsejamos trabajar con Linux; por lo que será
  conveniente o bien que te instales cualquier tipo de distribución o
  tengas acceso a una máquina virtual en tu propio ordenador o en la
  nube, como la que proporciona <a href='http://koding.com/R/jjmerelo'>koding.com</a></p>
</div>


<p>Seguimos haciendo nuestro primer programa, 
  un <a href="https://github.com/JJ/curso-js/blob/master/code/guenas.js">programa simple (guenas.js)</a>
  en <code>node.js</code> y ejecutémoslo. </p>
<code class="ejemplo">#<span class="hl sym">!/</span>usr<span class="hl sym">/</span>bin<span class="hl sym">/</span>node

<span class="hl kwa">var</span> saludo <span class="hl sym">=</span> <span class="hl kwa">new</span> Object<span class="hl sym">;</span>
saludo<span class="hl sym">.</span>hola <span class="hl sym">=</span> <span class="hl str">'mundo'</span><span class="hl sym">;</span>
console<span class="hl sym">.</span><span class="hl kwd">log</span><span class="hl sym">(</span> saludo <span class="hl sym">);</span>
</code>
<p>La primera línea es exclusivamente para sistemas Linux (que son,
  por otro lado, los únicos serios para desarrollo de software); en ella
  habrá que poner el camino completo al intérprete de node; este es
  una opción, como <code>/usr/local/bin/node</code>
  u <code>/usr/bin/env node</code> en el caso de usar <code>nave</code>; con ella y
  haciendo ejecutable el fichero con <code>chmod +x node.js</code>
  podemos ejecutarlo y obtener el siguiente resultado</p>
<code class="ejemplo">jmerelo@penny:~/servicios-web/ejemplos$  <span class="user">./guenas.js </span>
{ hola: 'mundo' }
</code>
<p>En otro entorno (o si no se quiere hacer al fichero ejecutable),
  con escribir</p>
<code class="ejemplo">jmerelo@penny:~/servicios-web/ejemplos$  <span class="user">node guenas.js </span></code>
<p>es suficiente. En cualquier caso, la salida será la misma. Y la
  explicación también: definimos un objeto <code>saludo</code> en la primera
  línea, y en la segunda le asignamos el valor <code>mundo</code> a la variable
  de instancia <code>hola</code>, o visto de otro modo, el valor <code>mundo</code> a la
  clave <code>hola</code>. <code>console.log</code> imprime la cadena en la salida,
  escribiendo directamente (y además en JSON) el valor de la
  misma. <code>console</code> es un objeto que forma parte de
  la <a href='http://nodejs.org/api/stdio.html '>librería estándar de
    entrada salida de node</a>. Equivale a la <em>consola</em> o el
  terminal, permitiendo enviar información a la misma
  con <code>log</code> y con otras órdenes como <code>error</code>; la
  diferencia es que en el primer caso se escribe en salida estándar y
  en el segundo en salida de error estándar (no se capturaría en una
  redirección de salida, por ejemplo). <code>console.log</code> puede
  usar
  también <a href='http://nodejs.org/api/stdio.html#stdio_console_log_data'>formatos
    como la orden <code>printf</code> de C</a>, es decir,</p>
    <code class='ejemplo'>console.log('Respuesta: %s', saludo.hola
    )</code>
<p>como hacemos
  en <a href='https://github.com/JJ/curso-js/blob/master/code/guenas-nave.js'>este
    programa</a>. El objeto <code>console</code> existe en la mayoría
  de los navegadores modernos y especialmente en Chrome/Chromium, pero
  el resultado saldrá por la <em>consola</em> del navegador que forma
  parte de las herramientas del mismo; se le denomina <em>herramientas
    de desarrollador</em> o <em>consola de JavaScript</em>.
</p>


<p>Sin embargo, node.js no es un intérprete habitual, tiene una forma
  particular de hacer las cosas: asíncronamente. Veremos, por ejemplo,
  como <a href="http://docs.nodejitsu.com/articles/file-system/how-to-read-files-in-nodejs">leer un fichero</a>, el de las quinielas que 
  hemos usado hasta ahora.</p> 

<code class="ejemplo">#<span class="hl sym">!/</span>usr<span class="hl sym">/</span>local<span class="hl sym">/</span>bin<span class="hl sym">/</span>node

var fs <span class="hl sym">=</span> <span class="hl kwd">require</span><span class="hl sym">(</span><span class="hl str">'fs'</span><span class="hl sym">);</span>
fs<span class="hl sym">.</span><span class="hl kwd">readFile</span><span class="hl sym">(</span><span class="hl str">'quiniela.datos'</span><span class="hl sym">,</span> <span class="hl str">'utf8'</span><span class="hl sym">,</span> 
	    <span class="hl kwa">function</span><span class="hl sym">(</span>err<span class="hl sym">,</span>datos<span class="hl sym">) {</span>
		<span class="hl kwa">if</span> <span class="hl sym">(</span>err<span class="hl sym">) {</span>
		    <span class="hl kwa">return</span> console<span class="hl sym">.</span><span class="hl kwd">log</span><span class="hl sym">(</span>err<span class="hl sym">);</span>
		<span class="hl sym">};</span>
		<span class="hl kwa">var</span> filas <span class="hl sym">=</span> datos<span class="hl sym">.</span><span class="hl kwd">split</span><span class="hl sym">(</span><span class="hl str">"</span><span class="hl esc">\n</span><span class="hl str">"</span><span class="hl sym">);</span>
		<span class="hl kwa">for</span> <span class="hl sym">(</span> <span class="hl kwa">var</span> f <span class="hl kwa">in</span> filas <span class="hl sym">) {</span>
		    <span class="hl kwa">var</span> cachos <span class="hl sym">=</span> filas<span class="hl sym">[</span>f<span class="hl sym">].</span><span class="hl kwd">split</span><span class="hl sym">(</span><span class="hl str">" "</span><span class="hl sym">);</span>
		    <span class="hl kwa">var</span> partido <span class="hl sym">= {</span> <span class="hl str">'local'</span><span class="hl sym">:</span> cachos<span class="hl sym">[</span><span class="hl num">0</span><span class="hl sym">],</span>
				    <span class="hl str">'visitante'</span><span class="hl sym">:</span> cachos<span class="hl sym">[</span><span class="hl num">1</span><span class="hl sym">],</span>
				    <span class="hl str">'resultado'</span><span class="hl sym">:</span> cachos<span class="hl sym">[</span><span class="hl num">2</span><span class="hl sym">] };</span>
		    console<span class="hl sym">.</span><span class="hl kwd">log</span><span class="hl sym">(</span> partido <span class="hl sym">);</span>
		<span class="hl sym">}</span>
	    <span class="hl sym">});</span></code>

<p>En este <a href="https://github.com/JJ/curso-js/blob/master/code/lee-quiniela.js">programa</a> (que actúa
  sobre <a href="https://github.com/JJ/curso-js/blob/master/code/quiniela.datos">este fichero de datos</a>) se usa el intérprete node.js, lo que se ve en la
  primera línea, que no hace falta en Windows (aunque se tendrá que
  ejecutar desde línea de órdenes poniendo explícitamente node
  fichero.js).  En la segunda vemos que se carga una librería usando 
  <code>require</code>, el <a href="T1:t1:common">mecanismo
  común</a> para cargar un módulo y evaluarlo, que,
  además, crea un objeto que se puede usar; lo usamos más adelante
  para leer un fichero. <a href="http://nodejs.org/api/fs.html"><code>fs</code> se refiere a <em>filesystem</em></a>, o
  sistema de ficheros, y es el módulo que contiene una serie de
  funciones para interaccionar con el mismo. </p>

<p>La siguiente línea es la que usa un modo de actuación propio de
  node.js. Como ya se ha indicado (varias veces), node funciona de
  forma asíncrona. En general, el patrón de las funciones en node, en
  vez de ser
<code class="ejemplo">haz_a();
haz_b();</code>
que ejecutaría <code>haz_a</code>, y, tras terminar, ejecutaría <code>haz_b</code>, es
<code class="ejemplo">haz_a(parametros, haz_b);
haz_c()</code>
que viene a decir ejecuta <code>haz_a</code> sobre unos <code>parametros</code> y, cuando
veas que has terminado, llama a la función <code>haz_b</code>; fijaros que se
trata de un puntero a función, no una llamada a la misma (no lleva paréntesis). Pero dependiendo
de lo que tarde <code>haz_a</code>, <code>haz_c</code> podría ejecutarse antes que
<code>haz_b</code>. En general, la secuencia de las líneas no tiene por qué ser
la secuencia de ejecución de las funciones, eso es precisamente lo que
significa la asincronía. Eso no quiere decir que no se pueda usar como
cualquier otro lenguaje, sólo que hay que tener cuidado y usar
patrones de programación específicos. Y, por otro
lado, permite responder muy rápidamente a eventos sin bloquear la
operación; cada evento inicia una hebra y se van procesando en
paralelo.</p>

<p>Vamos a la orden específica: efectivamente, con <code>readFile</code> leemos
  el fichero. Los dos primeros 
  argumentos son el nombre del fichero y, a continuación, la
  codificación, que es obligatorio usar (bueno, más o
  menos: <a href='http://nodejs.org/api/fs.html#fs_fs_readfile_filename_options_callback'>si
  no se da la codificación, te devuelve un buffer, no el contenido del
    fichero</a>).
 Y continuación el <em>callback</em>
  del que hemos hablado: una función que se ejecuta cuando se
  termine; se trata de una función anónima tal como las que hemos
  visto en apartados anteriores. El hecho de que se ejecute asíncronamente quiere decir que
  fs.readFile se ejecuta y se deja el evento generado; si hubiera una
  orden a continuación se ejecutaría inmediatamente. Esto le permite a
  <code>node.js</code> leer las cosas con mucha eficiencia, y hacer una serie de
  operaciones que no se pueden hacer fácilmente con otros
  lenguajes.</p>

<p>Concentrémonos en la función. Tiene dos argumentos: <code>err</code> y
  <code>datos</code>. Si hay un error, estará en la primera variable (que
  comprobamos) y si no, el resultado irá a la segunda variable. Es
  decir, cuando se ejecute la acción, se llamará a la función con dos
  argumentos, uno de los cuales será <code>null</code>. Vemos también que se usa
  <code>console.log</code> para escribir en la consola; <code>console</code> es un objeto
  que equivaldría al <code>document</code> del DOM, salvo que no tiene ningún
  tipo de estructura; tiene la ventaja de que si se escribe una
  estructura de datos compleja, la "desplegará". </p>

<p>El resto del programa es más o menos habitual; usamos la clase que
  hemos definido anteriormente para genera un objeto de cada tipo e
  imprimirlo usando <code>console.log</code>. El resultado será más o menos
  así:</p>
<code class="ejemplo">{ local: 'Madrid', visitante: 'Barça', resultado: 'x' }
{ local: 'Atleti', visitante: 'Barça', resultado: '1' }
{ local: 'Athleti', visitante: 'Recre', resultado: '1' }
{ local: 'Depor', visitante: 'Athleti', resultado: '2' }
{ local: 'Elche', visitante: 'Hércules', resultado: 'x' }
{ local: 'Cai', visitante: 'Madrid', resultado: 'x' }
  { local: 'Graná', visitante: 'Recre', resultado: '1' }</code>
<p>Es decir, los datos leídos en formato JSON.</p>






<h3><code>npm</code>, instalación de módulos en Node</h3>



<p><code>fs</code> es sólo el principio de una serie de módulos muy
  interesante; de hecho, es un módulo que se instala por omisión. Hay un módulo para crear servidores web, pero lo
  veremos más adelante (sólo para tener una idea se puede
  visitar <a href="http://nodetuts.com/">nodetuts</a>). En
  el <a href="http://nodejs.org/docs/latest/api/index.html">sitio de
    descarga de nodejs</a> vienen
    también todos los módulos disponibles, que permiten trabajar con el
  sistema operativo y cosas más avanzadas como una interfaz
  criptográfica. Pero si se quieren instalar más módulos, una de las
  características más interesantes de node es que tiene su propio
  gestor de paquetes, <code>npm</code>. Hay que <a href="http://npmjs.org/">seguir
      las instrucciones para instalarlo</a> y una vez hecho tener en
  cuenta que los módulos se instalan por omisión en el directorio
  superior al que uno está
  trabajando. La <a href="https://npmjs.org/">lista
  de todos los paquetes está en línea, y contiene módulos para la
      mayoría de los servicios web y aplicaciones actuales.</a>


</p><p>Instalemos por ejemplo <a href="https://github.com/mikeal/request"><code>request</code></a>, una de las librerías más
  populares, que actúa como cliente de <a href='#HTTP'>HTTP</a>. Una vez instalado npm, se
  escribe (en el directorio donde lo vayamos a usar, en
  general; la política de módulos de Node es tener los módulos
  instalados junto con la aplicación que los usa, en vez de en un
  sitio centralizado) <code>npm install request</code>. Esta orden, si
  la conexión a Internet está disponible, descargará e instalará el
  módulo en el directorio desde la que la llamemos. Si se ejecuta por
  primera vez, creará un directorio <code>node_modules</code>, dentro del cual
  habrá un directorio <code>request</code>. </p>

<p>Con <code>request</code> podemos codificar todo tipo de peticiones <a href='#REST'>REST</a>. A un
  nivel muy básico se puede usar de la forma siguiente, en el programa
  <a href="https://github.com/JJ/curso-js/blob/master/code/github-get.js"><code>github-get.js</code></a>,
  que pide información sobre un usuario en GitHub:</p>

<code class='ejemplo'>#<span class="hl opt">!/</span>usr<span class="hl opt">/</span>bin<span class="hl opt">/</span>node

<span class="hl kwa">var</span> https <span class="hl opt">=</span> <span class="hl kwd">require</span><span class="hl opt">(</span><span class="hl str">'https'</span><span class="hl opt">);</span>

<span class="hl kwa">var</span> user <span class="hl opt">=</span>process<span class="hl opt">.</span>argv<span class="hl kwc">[2]</span>?process<span class="hl opt">.</span>argv<span class="hl kwc">[2]</span><span class="hl opt">:</span><span class="hl str">'JJ'</span><span class="hl opt">;</span>

<span class="hl kwa">var</span> options <span class="hl opt">= {</span>
    host<span class="hl opt">:</span> <span class="hl str">'api.github.com'</span><span class="hl opt">,</span>
    path<span class="hl opt">:</span> <span class="hl str">'/users/'</span><span class="hl opt">+</span>user<span class="hl opt">,</span>
    method<span class="hl opt">:</span> <span class="hl str">'GET'</span>
<span class="hl opt">};</span>

<span class="hl kwa">var</span> req <span class="hl opt">=</span> https<span class="hl opt">.</span><span class="hl kwd">get</span><span class="hl opt">(</span>options,</span> <span class="hl kwa">function</span><span class="hl opt">(</span>res<span class="hl opt">) {</span>
			   res<span class="hl opt">.</span><span class="hl kwd">setEncoding</span><span class="hl opt">(</span><span class="hl str">'utf8'</span><span class="hl opt">);</span>
			   res<span class="hl opt">.</span><span class="hl kwd">on</span><span class="hl opt">(</span><span class="hl str">'data'</span><span class="hl opt">,</span> <span class="hl kwa">function</span> <span class="hl opt">(</span>datos_JSON<span class="hl opt">) {</span>
				      <span class="hl kwa">var</span> datos<span class="hl opt">=</span>JSON<span class="hl opt">.</span><span class="hl kwd">parse</span><span class="hl opt">(</span>datos_JSON<span class="hl opt">);</span>
				      console<span class="hl opt">.</span><span class="hl kwd">log</span><span class="hl opt">(</span><span class="hl str">'Login: '</span> <span class="hl opt">+</span> datos<span class="hl opt">.</span>login<span class="hl opt">+</span> <span class="hl str">&quot;</span><span class="hl esc">\n</span><span class="hl str">Nombre: &quot;</span> <span class="hl opt">+</span> datos<span class="hl opt">.</span>name <span class="hl opt">+</span> <span class="hl str">&quot;</span><span class="hl esc">\n</span><span class="hl str">&quot;</span><span class="hl opt">);</span>
				  <span class="hl opt">});</span>
		       <span class="hl opt">});</span>
req<span class="hl opt">.</span><span class="hl kwd">end</span><span class="hl opt">();</span>
</code>

<P>Usamos la librería recién instalada para descargarnos información
  de un usuario de <a href='https://GitHub.com'>GitHub</a>, usando la
  librería llamada $JSON$, que se instala con Node. La forma de
  petición es la asíncrona habitual en Node: se hace la petición y se
  le pasa la función a la que hay que llamar cuando se reciba la
  respuesta, como en el caso anterior de apertura de un fichero. A la
  función se la llama con tres parámetros: o bien <code>err</code>, en caso de
  que se produzca un error, o bien <code>response</code> y <code>body</code> en caso de que
  la respuesta sea correcta. <code>body</code> contendrá el texto de la
  respuesta, que habrá que decodificar (o imprimir tal cual, en caso
  de que se trate de HTML); <code>response</code> es una estructura de datos
  compleja, que podemos imprimir con <code>console.log</code> (y saldrá un montón
  de cosas, incluyendo la versión de <a href='#HTTP'>HTTP</a>, las cabeceras, y mucha
  información más), pero que contiene,
  entre otras cosas, el estado de la petición, con un código del
  protocolo <a href='#HTTP'>HTTP</a>.  En el programa anterior se comprobaba sólo si había
  error o no; ahora demás comprobamos que el código devuelto es el
  correcto, es decir, 200. Si hubiera un código 400, o 500, o incluso
  un 201, tendríamos que interpretar la respuesta de otra forma.</p>


<h3>Usando un servidor web</h3>


<p>Para enviar respuestas a una petición web hay que
  hacerlo desde un servidor. La  tendencia moderna es hacerlo desde un
  entorno integrado, sin embargo los servidores web multifunción
  permiten tanto ofrecer páginas web estáticas como webs dinámicas, y
  además hacerlo desde una variedad de lenguajes de programación; por
  eso conviene conocer, al menos, cómo instalar un servidor web simple
  y hacer programas que funcionen desde él con facilidad. </p>

  <p>El clásico <a href="http://httpd.apache.org/">Apache</a> sigue
  usándose extensivamente, aunque últimamente se están empezando a
  usar otras opciones como el <a href="http://nginx.org/">nginx</a>, un
  servidor web de altas prestaciones que se puede instalar, además, en
  todo tipo de plataformas (aunque este último no puede ejecutar, de
  forma directa, los <a href='#CGI'>CGIs</a> de los que hablamos en este apartado). Tanto uno como otro están disponibles en
    los repositorios de las distribuciones Linux más comunes. </p>

  <p>Un servidor web se instala como un servicio (es decir, un
  programa que se queda ejecutándose en memoria permanentemente) y <em>escucha</em> un
  puerto TCP/IP, normalmente el 80; este puerto, en Linux, está
  reservado (como todos hasta el 999) al superusuario, así que hay que
  ejecutarlo con esos privilegios. Una vez instalado se pueden servir
  tanto páginas estáticas (habrá que consultar en la documentación
  para ver cuál es el directorio configurado para hacerlo) como
  dinámicas (una vez más, también hay que consultar cuál es el
  directorio por omisión). Las páginas estáticas se sirven (más o
  menos) tal cual, y las dinámicas se generan a partir de la ejecución
  de un programa desde el servidor, con los privilegios del mismo o
  los que tenga configurados. Esto lo veremos más adelante, pero la
  idea principal es que los recursos accesibles al servidor web están
  en una serie de directorios cuyo valor lo calcula el servidor a
    partir del URL que se le solicita.</p>

<p>Para servir contenidos desde un programa, la forma habitual es
  copiar el programa con la extensión .cgi al directorio que se haya
  configurado para ello. De la forma más simple posible un CGI escrito
  en node.js podría ser el siguiente:</p> 

<code class="ejemplo"><span class="hl slc">#!/usr/bin/node</span>

<span class="hl kwc">//</span>cabecera
console<span class="hl opt">.</span><span class="hl kwd">log</span><span class="hl opt">(</span><span class="hl str">'Content-Type: text/plain; charset=UTF-8'</span><span class="hl opt">);</span>

<span class="hl kwc">//</span>contenido
var una_variable<span class="hl opt">=[</span><span class="hl str">'uno'</span><span class="hl opt">,</span><span class="hl str">'dos'</span><span class="hl opt">,{</span> tres<span class="hl opt">:</span> <span class="hl str">'tres'</span><span class="hl opt">}];</span>
console<span class="hl opt">.</span><span class="hl kwd">log</span><span class="hl opt">(</span><span class="hl str">''</span><span class="hl opt">);</span>
console<span class="hl opt">.</span><span class="hl kwd">log</span><span class="hl opt">(</span>una_variable<span class="hl opt">);</span></code>

<p>Para ejecutarlo no hay más que copiarlo a un directorio determinado
  con permisos de ejecución para otros (<code>chmod +x
    hola-js.cgi</code>).La primera envía una cabecera al cliente que
  le indica el tipo que se usa; la segunda parte es la que
  efectivamente envía el contenido, en este caso una variable en JSON
  (recordad que console.log escribe en salida estándar, y convierte
  las estructuras de datos a JSON).</p> 

<p>Node, por su naturaleza asíncrona, realmente no es el mejor sistema para
  trabajar con JavaScript en un servidor que incluya otros
  lenguajes. Sin embargo, se puede usar JavaScript de muchas maneras
  diferentes: <a href="http://www.silkjs.net/">SilkJS</a>, por ejemplo, es
  un intérprete de JS que incluye también un servidor web;
  o <a href='http://code.google.com/p/teajs/'>TeaJS</a> es un sistema
  para crear <a href='#CGI'>CGIs</a> basado en el intérprete rápido de JS de Google. Por
  no introducir más herramientas, no los vamos a ver aquí, pero
  conviene tener en cuenta que existen este tipo de soluciones que
  pueden convivir en un servidor como Apache o NGINX con otros
  lenguajes como Ruby o Perl.</p>

<h3>node.js como servidor</h3>


<p>Crear un servidor web con node.js es tan simple que viene
  directamente en <a href="http://nodejs.org/">la página principal del
  mismo</a></p>
<code class="ejemplo"><span class="hl kwa">var</span> http<span class="hl sym">=</span><span class="hl kwd">require</span><span class="hl sym">(</span><span class="hl str">'http'</span><span class="hl sym">);</span>
http<span class="hl sym">.</span><span class="hl kwd">createServer</span><span class="hl sym">(</span><span class="hl kwa">function</span> <span class="hl sym">(</span>req<span class="hl sym">,</span> res<span class="hl sym">) {</span>
  res<span class="hl sym">.</span><span class="hl kwd">writeHead</span><span class="hl sym">(</span><span class="hl num">200</span><span class="hl sym">, {</span><span class="hl str">'Content-Type'</span><span class="hl sym">:</span> <span class="hl str">'text/plain'</span><span class="hl sym">});</span>
  res<span class="hl sym">.</span><span class="hl kwd">end</span><span class="hl sym">(</span><span class="hl str">'Ahí estamos</span><span class="hl esc">\n</span><span class="hl str">'</span><span class="hl sym">);</span>
<span class="hl sym">}).</span><span class="hl kwd">listen</span><span class="hl sym">(</span><span class="hl num">8080</span><span class="hl sym">,</span> <span class="hl str">'127.0.0.1'</span><span class="hl sym">);</span>
console<span class="hl sym">.</span><span class="hl kwd">log</span><span class="hl sym">(</span><span class="hl str">'Server running at http://127.0.0.1:8080/'</span><span class="hl sym">);</span>
</code>
  <p>Este <a href="https://github.com/JJ/curso-js/blob/master/code/servidor.js">programa</a> simplemente escribirá "Ahí estamos" en el navegador
  cuando se solicite el URL. Nada complicado, pero tampoco lo es el
  programa: se usa un <a href="http://nodejs.org/api/http.html">módulo
  <code>http</code></a> que es estándar en Node en la primera línea del programa; se crea
  un servidor con <code>createServer</code>. Esta orden recibe como parámetro la
  función a la que hay que llamar cada vez que se reciba una petición.
  Cuando se recibe una petición, se llama a una función
  que escribe primero la cabecera <a href='#HTTP'>HTTP</a> (<code>writeHead</code>) y termina (<code>end</code>) el
  servicio de la misma escribiendo el contenido que nos aparecerá en
  el navegador.</p>

<p><code>http.createServer</code> crea un objeto y lo devuelve; en este caso, no
  lo asignamos a ninguna variable, sino que sobre el mismo objeto
  (anónimo) le decimos con <code>listen</code> en qué puerto (8080) y dirección (la
  del propio ordenador, <em>there's no place like 127.0.0.1</em>) va a
  escuchar el servidor. Es una orden que se 
  ejecuta de forma asíncrona, con lo que lo que crea es un <em>callback</em>
  que se llamará cada vez que se llame a ese URL. Sólo los puertos por
  encima de 1024 están accesibles al usuario, así que tendréis que
  usar un número en ese rango (como 8080 o 12121, todos por debajo de
  65535). El mensaje se
  escribe en pantalla de forma síncrona, es decir que a partir de que
  se escriba ese mensaje sabremos que podemos usar el servidor.</p>

<p>Evidentemente, si queremos crear un servidor que haga <em>algo</em>
  tendremos que usar las peticiones que se reciban para dar una
  respuesta variable. En el <a href="https://github.com/JJ/curso-js/blob/master/code/servidor-var.js"></a>
<code class="ejemplo"><span class="hl kwa">var</span> http<span class="hl opt">=</span><span class="hl kwd">require</span><span class="hl opt">(</span><span class="hl str">'http'</span><span class="hl opt">);</span> 
http<span class="hl opt">.</span><span class="hl kwd">createServer</span><span class="hl opt">(</span><span class="hl kwa">function</span> <span class="hl opt">(</span>req<span class="hl opt">,</span> res<span class="hl opt">) {</span>
    res<span class="hl opt">.</span><span class="hl kwd">writeHead</span><span class="hl opt">(</span><span class="hl num">200</span><span class="hl opt">, {</span><span class="hl str">'Content-Type'</span><span class="hl opt">:</span> <span class="hl str">'text/plain'</span><span class="hl opt">});</span> 
    res<span class="hl opt">.</span><span class="hl kwd">end</span><span class="hl opt">(</span><span class="hl str">'Ahí estamos '</span> <span class="hl opt">+</span> req<span class="hl opt">.</span>url<span class="hl opt">);</span> 
<span class="hl opt">}).</span><span class="hl kwd">listen</span><span class="hl opt">(</span><span class="hl num">8081</span><span class="hl opt">,</span> <span class="hl str">'127.0.0.1'</span><span class="hl opt">);</span> 
console<span class="hl opt">.</span><span class="hl kwd">log</span><span class="hl opt">(</span><span class="hl str">'Servidor ejecutándose en http://127.0.0.1:8081/'</span><span class="hl opt">);</span></code>
</p><p>La principal diferencia entre este programa y el anterior es,
  aparte del puerto usado (8081 en vez de 8080) la línea en la que
  escribe algo, y en la que usa la variable <code>req</code>, un <a href="http://nodejs.org/api/http.html#http_event_request">objeto</a> que
  contiene información sobre la petición, y entre otras cosas el URL
  (una vez eliminada la parte del servidor) que se ha usado; este URL
  es el que se escribe a continuación de "Ahí estamos", tal cual. </p>

<p>En general, para programar un servicio web habrá que trabajar con
  esa petición (que será la que reciba la orden del <a href='#API'>API</a>) y actuar
  según la misma, y teniendo en cuenta también la orden <a href='#HTTP'>HTTP</a> que se
  use (PUT, GET o la que sea). Esto lo veremos un poco más adelante.</p>


<p>A partir de ahí se puede construir un mínimo interfaz <a href='#REST'>REST</a> para
  responder a una serie de peticiones. La idea básica es que las
  funciones a las que tendremos que llamar estarán identificadas por
  el URL que se use para pedirlas. Por ejemplo, el
  programa <a href="https://github.com/JJ/curso-js/blob/master/code/rest-minimo.js">rest-minimo.js</a></p>

<code class="ejemplo"><span class="hl kwa">var</span> http<span class="hl opt">=</span><span class="hl kwd">require</span><span class="hl opt">(</span><span class="hl str">'http'</span><span class="hl opt">);</span> 
<span class="hl kwa">var</span> puerto<span class="hl opt">=</span>process<span class="hl opt">.</span>argv<span class="hl kwc">[2]</span>?process<span class="hl opt">.</span>argv<span class="hl kwc">[2]</span><span class="hl opt">:</span><span class="hl num">8080</span><span class="hl opt">;</span>
http<span class="hl opt">.</span><span class="hl kwd">createServer</span><span class="hl opt">(</span><span class="hl kwa">function</span> <span class="hl opt">(</span>req<span class="hl opt">,</span> res<span class="hl opt">) {</span> 
    res<span class="hl opt">.</span><span class="hl kwd">writeHead</span><span class="hl opt">(</span><span class="hl num">200</span><span class="hl opt">, {</span><span class="hl str">'Content-Type'</span><span class="hl opt">:</span> <span class="hl str">'text/plain'</span><span class="hl opt">});</span> 
    <span class="hl kwa">var</span> split_url<span class="hl opt">=</span>req<span class="hl opt">.</span>url<span class="hl opt">.</span><span class="hl kwd">split</span><span class="hl opt">(</span><span class="hl str">"/"</span><span class="hl opt">);</span> 
    <span class="hl kwa">if</span> <span class="hl opt">(</span> split_url<span class="hl kwc">[1]</span> <span class="hl opt">==</span> <span class="hl str">''</span> <span class="hl opt">) {</span> 
	res<span class="hl opt">.</span><span class="hl kwd">end</span><span class="hl opt">(</span><span class="hl str">'Portada'</span><span class="hl opt">);</span> 
    <span class="hl opt">}</span> <span class="hl kwa">else if</span> <span class="hl opt">(</span> split_url<span class="hl kwc">[1]</span> <span class="hl opt">==</span> <span class="hl str">'proc'</span> <span class="hl opt">) {</span> 
	res<span class="hl opt">.</span><span class="hl kwd">end</span><span class="hl opt">(</span><span class="hl str">'No es la portada'</span><span class="hl opt">);</span> 
    <span class="hl opt">}</span> <span class="hl kwa">else</span> <span class="hl opt">{</span> 
	res<span class="hl opt">.</span><span class="hl kwd">end</span><span class="hl opt">(</span><span class="hl str">'No entiendo la petición'</span><span class="hl opt">);</span> 
    <span class="hl opt">}</span> 
<span class="hl opt">}).</span><span class="hl kwd">listen</span><span class="hl opt">(</span>puerto<span class="hl opt">,</span> <span class="hl str">'127.0.0.1'</span><span class="hl opt">);</span> 
console<span class="hl opt">.</span><span class="hl kwd">log</span><span class="hl opt">(</span><span class="hl str">'Server running at http://127.0.0.1:'</span><span class="hl opt">+</span>puerto<span class="hl opt">+</span><span class="hl str">'/'</span><span class="hl opt">);</span></code>

<p>En este programa procesamos, no sólo imprimimos, la variable
  <code>req</code>. Es una estructura de datos con un montón de cosas 
  (insertad un console.log si queréis verlo), pero de la que vamos a
  usar solamente el camino. La idea es que el URL lo que describe es
  un recurso, no un fichero, así que nosotros procesamos el URL
  partiéndolo en sus diferentes componentes. Si en el primer
  componente no hay nada, damos la portada; si hay, por ejemplo,
  <code>proc</code>, haríamos otra cosa diferente, y eventualmente si se trata de
  un URL desconocido devolvemos un mensaje diferente.</p>

<p>Adicionalmente, hemos introducido en este programa un puerto que se
  toma de la línea de órdenes. <code>process.argv</code> contiene información
  sobre la línea de órdenes y otras cosas; en el 2º elemento es donde
  está, precisamente, el primer argumento de la línea de órdenes. El
  puerto por omisión será 8080 (lo que se ve en la segunda línea),
  pero si se pasa algún argumento (y es un puerto válido) se usará ese
  valor.</p>


<p>Algunos sitios web como <a href="http://www.heroku.com/">Heroku</a> o
  <a href="http://nodester.com/">Nodester</a> permiten publicar de
  forma gratuita aplicaciones web hechas con node.js. Pueden ser
  bastante útiles para crear prototipos o para hacer pruebas, incluso
  para alojar prácticas de alguna asignatura o curso.</p>


<h3>Para finalizar </h3>


<p>Hay muchas más cosas que se pueden hacer con Node. Por ejemplo, un
  <a href="https://github.com/mixu/nwm">gestor de ventanas</a>. Con
  <a href="http://appjs.org/">appjs</a> puedes construir aplicaciones
  cliente-servidor con su propia ventana, igual que con el más
  veterano <a href="https://github.com/rogerwang/node-webkit">node-webkit</a>.</p>

<p>Si se quiere trabajar principalmente en el
  navegador, <a href="http://jquery.com/">jQuery</a> funciona de forma
  muy similar a node: es un entorno asíncrono para crear aplicaciones  desde el
  navegador fácilmente, sin tener que escribir demasiado código
  JavaScript. Trasladar un programa de node a JQuery, es bastante
  directo, y existen diversidad de ampliaciones (plugins) para jQuery
  que hacen la vida (todavía) más fácil.</p>

<p>Por otro lado, cualquier lenguaje de scripting como Python o Perl
  permite crear también arquitecturas cliente y servidor, sólo que no
  se pueden incluir en el navegador (o usar la experiencia que tenemos
  con el mismo). Sin embargo, especialmente cuando se trate sólo de
  consumir servicios web, pueden ser la opción más adecuada.</p>

<p>En cuanto a recurso para hacer preguntas y obtener respuestas
  interesantes, <a href="http://stackoverflow.com/">StackOverflow</a>
  es un recurso imprescindible. Recuerda que tu karma aumentará
  también cuando contestes preguntas.</p>

<h3> Agradecimientos </h3>



<p>Agradezco a los lectores
  en <a href="http://twitter.com/">Twitter</a>,
  especialmente <a href="http://twitter.com/danielribes">@danielribes</a>,
  sugerencias sobre este material. </p> 

<h3>Bibliografía</h3>



<p>Como recursos adicionales, <a href="https://developer.mozilla.org/en/About_JavaScript">las
	páginas de JavaScript en Mozilla.org</a>,
	el <a href="http://www.ecma-international.org/publications/standards/Ecma-262.htm">estándar
	completo</a>, <a href="http://eloquentjavascript.net/">Eloquent
    JavaScript</a> y el <a href="http://geneura.ugr.es/%7Evictor/cursillos/javascript/js_intro.html">curso de JavaScript de Víctor Rivas Santos</a>. </p> 

<p>Por
  último, <a href="https://www.amazon.co.uk/dp/0596517742?tag=severawebsite-21&amp;camp=2902&amp;creative=19466&amp;linkCode=as4&amp;creativeASIN=0596517742&amp;adid=0MJ7MPPRP9H7PJ2B5MPB&amp;">JavaScript:
    The good parts</a> es un manual bastante completo que menciona
  muchos trucos para trabajar con este lenguaje.</p>

<p>Específicamente de node.js, se puede empezar
    por <a href="http://stackoverflow.com/questions/2353818/how-do-i-get-started-with-node-js">esta
    pregunta en StackOverflow</a>, para seguir
    con <a href="http://www.nodehispano.com/">el 
    sitio de node.js</a> en español, que incluye enlaces
    a <a href="http://www.nodebeginner.org/index-es.html">nodebeginner</a>,
    el libro para principiantes en node.js. La traducción tiene
  algunos errores, pero es
    legible. Finalmente, <a href="http://www.opsou.com/blog/recopilacion-de-tutoriales-sobre-node-js-en-castellano/">Opsou
    nos ofrece una lista de tutoriales en español</a>. Finalmente,
    también hay <a href="https://twitter.com/nodejs_es">una cuenta de
    Twitter (no demasiado activa)</a>. También el libro inserto (o
    cualquier otro recomendado, a esta alturas hay una cantidad
    ingente de bibliografía sobre node.js). </p>

<h2>Trabajando con REST y AJAX </h2>


<div class="objetivos"> <ul>
	  
	  <li>Aprender los conceptos generales de los interfaces REST.</li>
	  
	  <li>Programar clientes y servidores para REST
	    usando diferentes lenguajes de programación</li> 

	  <li>Introducción a Ajax y otras técnicas cliente-servidor.</li> 

      </ul>
</div>  

<h3>Introducción al interfaz REST </h3>



<p> <a href="http://es.wikipedia.org/wiki/REST">REST</a> es una serie de convenciones en la interacción
  cliente-servidor sobre  el protocolo <a href='#HTTP'>HTTP</a>. En la práctica, un
  interfaz REST es un interfaz de programación de aplicaciones que
  usa, para acceder al servidor, el conjunto completo de órdenes del
  protocolo <a href='#HTTP'>HTTP</a> y confía en los mensajes informativos y de error del
  mismo. </p>

<p>Aunque se trate de un <em>hermano menor</em> de otros tipos de
  servicios web (que se verán más adelante en este curso), su
  popularidad se debe sobre todo al poco overhead que añade a las
  peticiones y a la facilidad de su uso, tanto en el cliente como el
  servidor. También se puede implementar directamente sobre servidores
  web estándar como Apache o <a href="http://es.wikipedia.org/wiki/Nginx">nginx</a> , lo que facilita su
  implantación y desarrollo. Crear un cliente para un <a href='#API'>API</a> REST es tan
  fácil como crear una cadena; de hecho, se pueden usar desde la línea
  de órdenes</p> 

<h3> El protocolo HTTP y sus múltiples posibilidades </h3>



<p>El protocolo <a href="http://es.wikipedia.org/wiki/HTTP">HTTP</a> es uno de los protocolos más infrautilizados de
      la historia. A pesar de que ofrece múltiples posibilidades y
      versiones, se usa simplemente para enviar y recibir información
      de un servidor. Para recibir información se usa la orden <code>GET</code>,
      y para enviar, la orden <code>POST</code>. Pero también hay otras
      posibilidades, <code>PUT</code> (que envía un recurso determinado al
      servidor), <code>DELETE</code> (que borra un recurso del servidor) e
      incluso <code>HEAD</code> (igual que <code>GET</code>, pero sin el cuerpo de la
      respuesta).</p>

<p>El protocolo <a href='#HTTP'>HTTP</a> gira alrededor del concepto de <em>recurso</em>: un
      recurso en un servidor está identificado por un URI, y es la
      mínima acción que un servidor puede realizar. Como
      características adicionales, la acción de algunas peticiones
      (<code>GET</code> y <code>HEAD</code>) debe ser <em>segura</em>, es decir, dejar al
      servidor en el mismo estado que antes de la petición. Otras
      acciones, como <code>PUT</code> y <code>DELETE</code>, se denominan <em>idempotentes</em>:
      el hacer varias veces la misma petición tiene el mismo efecto
      que el hacerla una sola vez. </p>

<p><a href='#HTTP'>HTTP</a> funciona puramente como cliente-servidor: se hace una
      petición, y se espera la respuesta. Lo que no quiere decir que
      no se puedan hacer peticiones concurrentes y asíncronas; sin embargo, esas
      peticiones tendrán que estar dentro del marco de una página web
      (o sea, una aplicación).</p>

<p>A las peticiones el servidor responde con una serie de <a href="http://en.wikipedia.org/wiki/List_of_HTTP_status_codes">códigos estándar</a>, que usan la misma presentación que la petición: texto puro y duro. Cuando todo va bien, la respuesta es <code>200 OK</code>; los códigos <code>2xx</code>
 corresponden, en general, a una petición hecha, y fuera de los 2xx 
existe el caos y el descontrol. En especial, un código 500 implica error
 en el servidor. Evidentemente, estos mensajes están pensados para que 
los lea un cliente en el navegador; sin embargo, cuando trabajamos 
directamente sobre este protocolo, nuestro programa deberá ser 
consciente de ellos y responder de forma adecuada como si se tratara de 
una llamada a otro procedimiento.</p>

<p>Las aplicaciones construidas alrededor del protocolo HTTP y sus
      características se suelen llamar <a href="http://en.wikipedia.org/wiki/Representational_State_Transfer">aplicaciones RESTful</a> 
(REST == REpresentational State Transfer). La idea de REST es que se
      transfiere el estado del servidor al cliente. Un recurso tiene
      una representación, que se transfiere al cliente por una
      petición; esa representación se puede cambiar con diferentes
      operaciones. Sin embargo, con esto sólo estamos especificando la
      capa más baja del servicio web; hace falta una capa de
      mensajería. Y esta capa de mensajería se suele denominar
      <a href="http://es.wikipedia.org/wiki/POX">POX</a>, o <em>Plain Old XML</em> (XML <em>de toda la vida</em>), es
      decir XML bien formado con algunas ampliaciones, pero sin ningún tipo
      de validación. En algunos casos se usa texto directamente,
      aunque también se puede usar JSON o cualquier otro tipo de
      capa.</p> 

<p>De hecho, las aplicaciones <a href="http://www.oreillynet.com/pub/wlg/3005">REST suelen
      ser más populares</a> que otros servicios web, por el simple hecho
      de que es muy fácil construir el interfaz: simplemente creando
      una cadena determinada. Eso los hace también más rápidos, aunque
      sean menos flexibles.</p>

<p>Vamos a ver un interfaz de este tipo relativamente reciente: el de
      <a href="http://twitter.com/">Twitter</a>, un sitio <em>social</em> que
      transmite a todo el que quiera escucharlo las líneas de estado
      (mensajes de menos de 200 caracteres). El <a href="https://dev.twitter.com/docs">API de Twitter</a> es
      <a href='#RESTful'>RESTful</a>, y está bastante bien diseñada. Para usarla es necesario
      darse de alta; desde la versión 1.1 del interfaz todas las
      peticiones necesitan autenticación. Así que
      usaremos <a href='http://developer.github.com/v3/'>otro
      interfaz, el de GitHub</a>, para hacer pruebas. Por ejemplo,
      esta petición te dará todas las <em>organizaciones</em> a las que
      pertenece el usuario <a href='http://github.com/JJ'>JJ</a>:</p>
<code class="ejemplo">bash$ <span class="user">curl -i https://api.github.com/users/JJ/orgs</span>
</code>

<p>Para llevar a cabo este ejemplo hay que instalar <code>curl</code>, un
  programa que en una primera aproximación es simplemente un
  descargador de páginas web pero que en segunda se puede usar como un
  completo cliente <a href='#REST'>REST</a>; en este caso <code>-i</code> te incluye las
  cabeceras en la salida, con lo que producirá algo de este
  estilo </p>
<code class='ejemplo'>HTTP/1.1 200 OK
Server: GitHub.com
Date: Fri, 25 Oct 2013 16:58:26 GMT
Content-Type: application/json; charset=utf-8
Status: 200 OK
X-RateLimit-Limit: 60
X-RateLimit-Remaining: 57
X-RateLimit-Reset: 1382723596
Cache-Control: public, max-age=60, s-maxage=60
ETag: "86e56765000470d5120c565f2d669ec5"
Vary: Accept
X-GitHub-Media-Type: github.beta
X-Content-Type-Options: nosniff
Content-Length: 1050
Access-Control-Allow-Credentials: true
Access-Control-Expose-Headers: ETag, Link, X-RateLimit-Limit, X-RateLimit-Remaining, X-RateLimit-Reset, X-OAuth-Scopes, X-Accepted-OAuth-Scopes
Access-Control-Allow-Origin: *
X-GitHub-Request-Id: 533BCE5D:1FA3:25A831A1:526AA332
Vary: Accept-Encoding

[
  {
    "login": "openkratio",
    "id": 2310256,
    "url": "https://api.github.com/orgs/openkratio",
    "repos_url": "https://api.github.com/orgs/openkratio/repos",
    "events_url": "https://api.github.com/orgs/openkratio/events",
    "members_url": "https://api.github.com/orgs/openkratio/members{/member}",
    "public_members_url": "https://api.github.com/orgs/openkratio/public_members{/member}",
    "avatar_url": "https://1.gravatar.com/avatar/da65290f54a587ec04cd35bb85d072ad?d=https%3A%2F%2Fidenticons.github.com%2F95a0686b2cd65a0d12a9cdf6ee9001ca.png&r=x"
  },
  {
    "login": "CANUBE",
    "id": 3839808,
    "url": "https://api.github.com/orgs/CANUBE",
    "repos_url": "https://api.github.com/orgs/CANUBE/repos",
    "events_url": "https://api.github.com/orgs/CANUBE/events",
    "members_url": "https://api.github.com/orgs/CANUBE/members{/member}",
    "public_members_url": "https://api.github.com/orgs/CANUBE/public_members{/member}",
    "avatar_url": "https://identicons.github.com/6fb6b5f6fdd67839b9ff438ffa975d08.png"
  }
  ]</code>

<p>Casi todos los servicios web incluyen alguna forma de
      autenticación; una de las formas de hacerlo es incluirlo en el propio
      URL, en la forma habitual: <code>usuario:clave@host</code>; en
      este caso no es necesario y en la mayoría de los <a href='#API'>API</a> REST se usa
      ya autenticación OAuth en alguna de sus formas.</p>

<p> Y lo
      único que hacemos con la respuesta es imprimirla, tal cual, pero
      lo mejor sería extraer información útil de la misma, como ocurre
      en <a href="https://github.com/JJ/curso-js/blob/13e25e97315e58a84f268349ba61b650e7a097e3/code/github-get.js">este
      programa en node.js</a>:</p>
<code class="ejemplo">#<span class="hl opt">!/</span>usr<span class="hl opt">/</span>bin<span class="hl opt">/</span>node

<span class="hl kwa">var</span> https <span class="hl opt">=</span> <span class="hl kwd">require</span><span class="hl opt">(</span><span class="hl str">'https'</span><span class="hl opt">);</span>

<span class="hl kwa">var</span> user <span class="hl opt">=</span>process<span class="hl opt">.</span>argv<span class="hl kwc">[2]</span>?process<span class="hl opt">.</span>argv<span class="hl kwc">[2]</span><span class="hl opt">:</span><span class="hl str">'JJ'</span><span class="hl opt">;</span>

<span class="hl kwa">var</span> options <span class="hl opt">= {</span>
    host<span class="hl opt">:</span> <span class="hl str">'api.github.com'</span><span class="hl opt">,</span>
    path<span class="hl opt">:</span> <span class="hl str">'/users/'</span><span class="hl opt">+</span>user<span class="hl opt">,</span>
    method<span class="hl opt">:</span> <span class="hl str">'GET'</span>
<span class="hl opt">};</span>


<span class="hl kwa">var</span> req <span class="hl opt">=</span> https<span class="hl opt">.</span><span class="hl kwd">request</span><span class="hl opt">(</span>options<span class="hl opt">,</span> <span class="hl kwa">function</span><span class="hl opt">(</span>res<span class="hl opt">) {</span>
			   res<span class="hl opt">.</span><span class="hl kwd">setEncoding</span><span class="hl opt">(</span><span class="hl str">'utf8'</span><span class="hl opt">);</span>
			   res<span class="hl opt">.</span><span class="hl kwd">on</span><span class="hl opt">(</span><span class="hl str">'data'</span><span class="hl opt">,</span> <span class="hl kwa">function</span> <span class="hl opt">(</span>datos_JSON<span class="hl opt">) {</span>
				      <span class="hl kwa">var</span> datos<span class="hl opt">=</span>JSON<span class="hl opt">.</span><span class="hl kwd">parse</span><span class="hl opt">(</span>datos_JSON<span class="hl opt">);</span>
				      console<span class="hl opt">.</span><span class="hl kwd">log</span><span class="hl opt">(</span><span class="hl str">'Login: '</span> <span class="hl opt">+</span> datos<span class="hl opt">.</span>login<span class="hl opt">+</span> <span class="hl str">&quot;</span><span class="hl esc">\n</span><span class="hl str">Nombre: &quot;</span> <span class="hl opt">+</span> datos<span class="hl opt">.</span>name <span class="hl opt">+</span> <span class="hl str">&quot;</span><span class="hl esc">\n</span><span class="hl str">&quot;</span><span class="hl opt">);</span>
				  <span class="hl opt">});</span>
		       <span class="hl opt">});</span>
req<span class="hl opt">.</span><span class="hl
					     kwd">end</span><span class="hl
									 opt">();</span></code>

<p>Este programa descarga información de un usuario en JSON y la
  procesa. Toma el usuario que se pase por la línea de órdenes, o bien
  usa <code>JJ</code> por defecto, dando un resultado así</p>
<code class='ejemplo'>jmerelo@penny:~/txt/docencia/cursos/JavaScript$  <span class='user'>node code/github-get.js</span> 
Login: JJ
Nombre: Juan Julián Merelo Guervós</code>

<p>El programa hace una petición GET al <a href='#API'>API</a> de GitHub y del objeto en
  JSON devuelto extrae (tras su conversión en un objeto JS
  con <code>JSON.parse</code> un par de variables del mismo y las
  imprime. El objeto contiene muchas más cosas que no nos
  interesan. El <a href='http://nodejs.org/api/https.html#https_https_request_options_callback'>módulo <code>https</code> </a>
  usado es muy similar al <code>http</code>, salvo por el protocolo
  usado. La petición que se está usando es la forma más general, pero
  se puede usar directamente <code>get</code> <a href='https://github.com/JJ/curso-js/blob/master/code/github-get.js'>de esta forma</a>: <code>var
  req = https.get('https://api.github.com/users/'+user,
    function(res) </code> con exactamente el mismo resultado.</p>


<p>La idea de <a href='#REST'>REST</a> desde el punto de vista del servidor es usar el URL
      para representar recursos, y las propias órdenes de HTTP para
      ejercitar acciones sobre ese recursos. En general, <code>GET</code> servirá
      para transferir la representación de un recurso del cliente al
      servidor, <code>POST</code> cambiará el estado de un recurso, <code>PUT</code> (que no
      se suele usar tan a menudo) directamente cambiaría la
      representación del recurso, mientras que <code>DELETE</code> borraría el
      recurso; a estas arquitecturas se les suele denominar
      también <em>arquitecturas orientadas al recurso</em> </p>

<p>Por eso también se suelen proponer una serie
      de <a href="http://en.wikipedia.org/wiki/Representational_State_Transfer#Guiding_principles_of_the_interface">buenas
      prácticas 
      para diseñar un interfaz REST</a>:</p>
<ul> <li>La funcionalidad está divida en recursos</li>
      <li>Se usa una sintaxis universal basada en URL</li>
      <li>Todos los recursos tienen un interfaz uniforme, con un
	conjunto bien definido de operaciones y un conjunto
	restringido de tipos de contenido. En particular, este
	interfaz esconde los detalles de la implementación. </li>
    </ul>

<p>Por ejemplo, supongamos que hay que diseñar un interfaz REST para
      una quiniela deportiva. Hay una quiniela por jornada, y cada
      jornada tiene 15 partidos. Supongamos que se conocen los
      partidos de antemano, y que sólo se pueden proponer resultados
      por parte de un usuario. Se podría diseñar el interfaz de la
      forma siguiente: </p>

<ul><li>Quiniela de una jornada: <code>http://jost.com/quiniela/jornada/[número de
	  jornada]</code></li>
<li>Un partido de una quiniela:
	<code>http://jost.com/quiniela/jornada/[número de
	  jornada]/partido/[número de partido]</code></li>
<li>Para los resultados, habría que sustituir <code>quiniela</code>
	por <code>resultados</code>. Adicionalmente, añadir
	<code>usuario/[nombre de usuario]</code>, para recuperar los
	resultados propuestos por un usuario determinado. Por ejemplo,
	Resultados:
	<code>http://jost.com/resultados/jornada/22/usuario/foobar</code></li>
    </ul>

<p>Las operaciones HTTP que se van a usar vienen determinadas por el diseño del interfaz. Por
      ejemplo, para proponer un resultado determinado habría que hacer
      una petición POST con dos parámetros: el nombre de usuario y el
      resultado propuesto. El servidor responderá con un mensaje
      estándar HTTP y un fichero XML si se ha podido hacer
      correctamente, y con un error HTTP si no.</p>

<p>El principal problema con este diseño <a href='#RESTful'>RESTful</a> es hacerlo en la
      práctica. Como se ha visto a la hora de programar <a href='#CGI'>CGIs</a>, en
      general el camino a un recurso es tortuoso, y la forma como se
      pasan los parámetros tiene un montón de &amp; e signos =. Así
      que hay que <em>limpiar</em> el URL de alguna forma. Dependiendo de la
      implementación del servidor, quizás se puede hacer directamente;
      por ejemplo, en caso de que se trate de un <code>.war</code> en
      un contenedor de servlets, ya se encarga directamente; sin
      embargo. Algunos <a href='#CGI'>CGIs</a> también permiten interpretar directamente
      el URL. Pero otra forma de hacerlo es usar <a href="http://httpd.apache.org/docs/2.2/mod/mod_rewrite.html"><code>mod_rewrite</code></a>, que permite reescribir los URLs, de forma que la petición cambia de forma antes de servirse la petición. Estos <em>cambios</em> toman la forma de directivas
del servidor; por ejemplo, en Apache podríamos usar la siguiente
      (dentro del fichero <code>httpd.conf</code> o el fichero de
      configuración de un directorio en particular, <code>.htaccess</code>:
</p><div class="ejemplo">RewriteRule ^quiniela/(\w+)/(\d+)/(\w+)/(\d+)$
	/~jmerelo/REST/quiniela.cgi?$1=$2&amp;$3=$4 [L]</div>

<p>Parece un poco complicada, pero no lo es. Para empezar, se cambiará
      la expresión regular de la izquierda por la de la derecha. La de
      la izquierda incluye palabras (\w+) y números (\d+), y en la
      expresión de la derecha aparecen, por orden, representados por
      <code>$n</code>.</p>

<p>El hecho de que sea tan complicado diseñar interfaces REST con
  recursos, como los <a href='#CGI'>CGIs</a>, que no están preparados
  para ello hace que existan marcos de aplicaciones, como los que
  veremos a continuación, en los que todo esto se hace de una forma
  mucho más simple, trabajando directamente con las rutas REST.</p> 

<h3>Interfaces REST simples con express</h3>


<p>Para diseñar interfaces REST de forma bastante simple, hay un
  <a href="http://expressjs.com/">módulo de node.js llamado
  express</a>. La idea de este módulo es reflejar en el código, de la
  forma más natural posible, el diseño del interfaz REST. </p>

<p>Pero primero hay que instalarlo. Node.js tiene un sistema de
  gestión de módulos bastante simple
  llamado <a href="http://npmjs.org/">npm</a>
  que <a href="#nodejs">hemos visto en el tema anterior</a>. Tras seguir las
  instrucciones en el sitio para instalarlo (o, en el caso de ubuntu,
  instalarlo desde Synaptic o con apt-get), vamos al directorio en el
  que vayamos a crear el programa y escribimos</p>
<code>npm install express</code>
<p>en general, no hace falta tener permiso de administrador, sólo el
  necesario para crear, leer y ejecutar ficheros en el directorio en
  el que se esté trabajando</p>

<p>Tras la instalación, el programa que hemos visto más arriba se
  transforma en el siguiente:</p>
<code class="ejemplo"><span class="hl kwa">var</span> express<span class="hl opt">=</span><span class="hl kwd">require</span><span class="hl opt">(</span><span class="hl str">'express'</span><span class="hl opt">);</span>
<span class="hl kwa">var</span> app <span class="hl opt">=</span> express<span class="hl opt">();</span>

app<span class="hl opt">.</span><span class="hl kwd">get</span><span class="hl opt">(</span><span class="hl str">'/'</span><span class="hl opt">,</span> <span class="hl kwa">function</span> <span class="hl opt">(</span>req<span class="hl opt">,</span> res<span class="hl opt">) {</span>   
	res<span class="hl opt">.</span><span class="hl kwd">send</span><span class="hl opt">(</span><span class="hl str">'Portada'</span><span class="hl opt">);</span>
<span class="hl opt">});</span>

app<span class="hl opt">.</span><span class="hl kwd">get</span><span class="hl opt">(</span><span class="hl str">'/proc'</span><span class="hl opt">,</span> <span class="hl kwa">function</span> <span class="hl opt">(</span>req<span class="hl opt">,</span> res<span class="hl opt">) {</span>   
	res<span class="hl opt">.</span><span class="hl kwd">send</span><span class="hl opt">(</span><span class="hl str">'No es la portada'</span><span class="hl opt">);</span>
<span class="hl opt">});</span>

app<span class="hl opt">.</span><span class="hl kwd">listen</span><span class="hl opt">(</span><span class="hl num">8080</span><span class="hl opt">);</span>
console<span class="hl opt">.</span><span class="hl kwd">log</span><span class="hl opt">(</span><span class="hl str">'Server running at http://127.0.0.1:8080/'</span><span class="hl opt">);</span></code>

  <p>Para empezar, <code>express</code> nos evita todas las molestias
  de tener que procesar nosotros la línea de órdenes: directamente
  escribimos una función para cada respuesta que queramos tener, lo
  que facilita mucho la programación. Las órdenes reflejan
    directamente las órdenes de <a href='#HTTP'>HTTP</a> a las que queremos responder, en
  este caso <code>get</code> y por otro lado se pone directamente la función para
  cada una de ellas. Dentro de cada función de respuesta podemos
    procesar las órdenes que queramos. </p>

<p>Por otro lado, se usa <code>send</code> en vez de <code>end</code> para enviar el
  resultado. Lo que viene a ser lo mismo, <code>s</code> más o menos,
  aunque <a href="http://expressjs.com/guide.html#http-methods">send
    es más flexible</a>, admitiendo todo tipo de datos que son
  procesados para enviar al cliente la respuesta correcta. Tampoco
  hace falta establecer explícitamente el tipo MIME que se devuelve,
  encargándose <code>send</code> del mismo. </p>

<p>Con el mismo <code>express</code> se pueden generar aplicaciones no tan
  básicas ejecutándolo de la forma siguiente:</p>
  <code class="ejemplo">node_modules/express/bin/express prueba-rest</code>
<p>Se indica el camino completo a la aplicación binaria, que sería el
  puesto. Con esto se genera un directorio prueba-rest. Cambiándoos al
  mismo y escribiendo simplemente <code>npm install</code> se instalarán las
  dependencias necesarias. La aplicación estará en el fichero
  <code>app.js</code>, lista para funcionar, pero evidentemente habrá que
  adaptarla a nuestras necesidades particulares. </p>


<p>El acceso a los parámetros de la llamada y la realización de
  diferentes actividades según el mismo se denomina enrutado. En
  express se pueden definir los parámetros de forma bastante simple,
  usando marcadores precedidos por <code>:</code>. Por ejemplo, si
  queremos tener diferentes contadores podríamos usar el <a href="https://github.com/JJ/curso-js/blob/master/code/express-count.js">programa
    siguiente</a>:</p>
<code class="ejemplo"><span class="hl kwa">var</span> express<span class="hl opt">=</span><span class="hl kwd">require</span><span class="hl opt">(</span><span class="hl str">'express'</span><span class="hl opt">);</span>
<span class="hl kwa">var</span> app <span class="hl opt">=</span> express<span class="hl opt">();</span>
<span class="hl kwa">var</span> contadores <span class="hl opt">=</span> <span class="hl kwa">new</span> Array<span class="hl opt">;</span>
<span class="hl kwa">var</span> puerto<span class="hl opt">=</span>process<span class="hl opt">.</span>argv<span class="hl kwc">[2]</span>?process<span class="hl opt">.</span>argv<span class="hl kwc">[2]</span><span class="hl opt">:</span><span class="hl num">8080</span><span class="hl opt">;</span>

app<span class="hl opt">.</span><span class="hl kwd">get</span><span class="hl opt">(</span><span class="hl str">'/'</span><span class="hl opt">,</span> <span class="hl kwa">function</span> <span class="hl opt">(</span>req<span class="hl opt">,</span> res<span class="hl opt">) {</span>   
	res<span class="hl opt">.</span><span class="hl kwd">send</span><span class="hl opt">(</span><span class="hl str">'Portada'</span><span class="hl opt">);</span>
<span class="hl opt">});</span>

app<span class="hl opt">.</span><span class="hl kwd">put</span><span class="hl opt">(</span><span class="hl str">'/contador/:id'</span><span class="hl opt">,</span> <span class="hl kwa">function</span><span class="hl opt">(</span> req<span class="hl opt">,</span>res <span class="hl opt">) {</span>
    contadores<span class="hl opt">[</span>req<span class="hl opt">.</span>params<span class="hl opt">.</span>id<span class="hl opt">] =</span> <span class="hl num">0</span><span class="hl opt">;</span>
    res<span class="hl opt">.</span><span class="hl kwd">send</span><span class="hl opt">( {</span> creado<span class="hl opt">:</span> req<span class="hl opt">.</span>params<span class="hl opt">.</span>id <span class="hl opt">} );</span>
<span class="hl opt">});</span>

app<span class="hl opt">.</span><span class="hl kwd">get</span><span class="hl opt">(</span><span class="hl str">'/contador/:id'</span><span class="hl opt">,</span> <span class="hl kwa">function</span> <span class="hl opt">(</span>req<span class="hl opt">,</span> res<span class="hl opt">) {</span>   
    res<span class="hl opt">.</span><span class="hl kwd">send</span><span class="hl opt">(</span> <span class="hl str">"{ "</span><span class="hl opt">+</span>req<span class="hl opt">.</span>params<span class="hl opt">.</span>id<span class="hl opt">+</span><span class="hl str">": "</span><span class="hl opt">+</span> contadores<span class="hl opt">[</span>req<span class="hl opt">.</span>params<span class="hl opt">.</span>id<span class="hl opt">] +</span> <span class="hl str">"}"</span>  <span class="hl opt">);</span>
<span class="hl opt">});</span>

app<span class="hl opt">.</span><span class="hl kwd">post</span><span class="hl opt">(</span><span class="hl str">'/contador/:id'</span><span class="hl opt">,</span> <span class="hl kwa">function</span> <span class="hl opt">(</span>req<span class="hl opt">,</span> res<span class="hl opt">) {</span>   
    contadores<span class="hl opt">[</span>req<span class="hl opt">.</span>params<span class="hl opt">.</span>id<span class="hl opt">]++;</span>
    res<span class="hl opt">.</span><span class="hl kwd">send</span><span class="hl opt">(</span> <span class="hl str">"{ "</span><span class="hl opt">+</span>req<span class="hl opt">.</span>params<span class="hl opt">.</span>id<span class="hl opt">+</span><span class="hl str">": "</span><span class="hl opt">+</span> contadores<span class="hl opt">[</span>req<span class="hl opt">.</span>params<span class="hl opt">.</span>id<span class="hl opt">] +</span> <span class="hl str">"}"</span>  <span class="hl opt">);</span>
<span class="hl opt">});</span>

app<span class="hl opt">.</span><span class="hl kwd">listen</span><span class="hl opt">(</span>puerto<span class="hl opt">);</span>
console<span class="hl opt">.</span><span class="hl kwd">log</span><span class="hl opt">(</span><span class="hl str">'Server running at http://127.0.0.1:'</span><span class="hl opt">+</span>puerto<span class="hl opt">+</span><span class="hl str">'/'</span><span class="hl opt">);</span>
</code>
<p>Este <a href="https://github.com/JJ/curso-js/tree/master/code/express-count.js%27">programa (express-count.js)</a> introduce otras dos órdenes REST: PUT, que, como recordamos,
  sirve para crear nuevos recurso y es idempotente (se puede usar
  varias veces con el mismo resultado), y además POST. Esa orden la vamos a usar para
  crear contadores a los que posteriormente accederemos con get. PUT
  no es una orden a la que se pueda acceder desde el navegador, así
  que para usarla necesitaremos hacer algo así desde la línea de
  órdenes:
<code>curl -X PUT http://127.0.0.1:8080/contador/primero</code>
para lo que previamente habrá que haber instalado <code>curl</code>,
  claro. Esta orden llama a PUT sobre el programa, y crea un contador
  que se llama <code>primero</code>. Una vez creado, podemos acceder a él desde
  la línea de órdenes o desde el navegador (desde el navegador se
  generan peticiones GET y POST solamente).</p>



<h3>Clientes REST</h3>


<p>Tampoco es complicado escribir con node.js un cliente REST. Se
  puede hacer mediante peticiones HTTP, pero por supuesto es más fácil
  escribir un cliente usando la
  librería <a href="https://github.com/danwrong/restler">restler</a>,
  que se instala de la misma forma que hemos visto anteriormente con
  <code>npm</code>. Una vez instalada, se puede escribir un cliente como este al
  utilísimo crea-contadores anterior. </p>

<code class="ejemplo">#<span class="hl sym">!/</span>usr<span class="hl sym">/</span>local<span class="hl sym">/</span>bin<span class="hl sym">/</span>node

<span class="hl kwa">var</span> rest <span class="hl sym">=</span> <span class="hl kwd">require</span><span class="hl sym">(</span><span class="hl str">'restler'</span><span class="hl sym">);</span>
<span class="hl kwa">var</span> url <span class="hl sym">=</span> <span class="hl str">'http://127.0.0.1:8080/contador/'</span><span class="hl sym">;</span>
process<span class="hl sym">.</span>argv<span class="hl sym">.</span><span class="hl kwd">forEach</span><span class="hl sym">(</span><span class="hl kwa">function</span> <span class="hl sym">(</span>val<span class="hl sym">,</span> index<span class="hl sym">,</span> array<span class="hl sym">) {</span>
    <span class="hl kwa">if</span> <span class="hl sym">(</span> index <span class="hl sym">&gt;</span> <span class="hl num">1</span> <span class="hl sym">) {</span>
	rest<span class="hl sym">.</span><span class="hl kwd">put</span><span class="hl sym">(</span> url <span class="hl sym">+</span> val <span class="hl sym">).</span><span class="hl kwd">on</span><span class="hl sym">(</span><span class="hl str">'complete'</span><span class="hl sym">,</span> <span class="hl kwa">function</span><span class="hl sym">(</span> data <span class="hl sym">) {</span>
	    console<span class="hl sym">.</span><span class="hl kwd">log</span><span class="hl sym">(</span> data <span class="hl sym">);</span>
	<span class="hl sym">} );</span>
    <span class="hl sym">}</span>
<span class="hl sym">});</span>
</code>

<p>El cliente es bastante simple, y lo que hace es crear tantos
  contadores como argumentos le pasamos por la línea de órdenes. Tras
  definir un par de variables (ojo con la segunda, tiene que contener
  el URL del sitio donde vamos a hacer la consulta, el número y la
  dirección puede ser otro cualquiera, lo que no variará será
  <code>contador</code> si estamos usando el programa anterior), usamos la
  variable <code>process.argv</code> que contiene los argumentos de la línea de
  órdenes.</p>

<p>Sobre ese objeto ejecutamos un bucle, <code>forEach</code> recorre los
  elementos de un objeto llamando sobre cada uno de ellos una función
  con tres argumentos: el índice y el elemento que se está recorriendo
  en ese momento, y el array completo, que en este caso no vamos a
  usar. Además, los argumentos están en realidad a partir del segundo
  elemento; los dos primeros contienen el camino a node y el camino
  completo al programa que se está ejecutando.</p>

<p>La clientela REST se usa con <code>rest.put</code>. Vamos a crear un contador
  con el nombre <code>val</code> que se envía desde la línea de órdenes, para lo
  que creamos el URL del mismo simplemente concatenando las dos
  cadenas. </p>

<p>Recordemos que node.js actúa de forma asíncrona, por lo que lo que
  hacemos con esa orden es crear un callback cuando (<em>on</em>) la
  petición se haya completado (<em>complete</em>). Ese callback
  simplemente te dice cual ha sido la respuesta y la imprime.</p>


<h3> Usando Ajax</h3>



  <p>Aunque inicialmente <a href="http://es.wikipedia.org/wiki/AJAX">AJAX</a> era un acrónimo de <em>Asynchronous
  JavaScript and XML</em>, hoy en día se ha dejado de usar como tal y
  viene a abarcar todas las tecnologías asíncronas de interacción
  cliente servidor, usando cualquier formato de serialización (aunque
  más generalmente JSON) y en el cliente (aunque generalmente se trata
  de JavaScript, pero puede ser también Dart u otro lenguaje insertado
    en el navegador, como Java).</p>


<p>Con lo visto hasta ahora ya podemos intentar hacer un programa cliente con
      otro servidor en Ajax. En algún tema anterior hemos introducido
      la J de JavaScript; también hemos visto como trabajar con JSON
      desde el servidor,
      que sería la X, y nos falta la A. A se refiere a Asíncrono, y se
      trata de que las peticiones desde el cliente (el navegador) no
      lo bloqueen mientras el servidor contesta (si lo hiciera, para
      el caso se podría generar una página nueva cada vez que se
      hiciera cualquier interacción). En la práctica, el AJAX se basa
      en una clase de JavaScript, <code>XMLHttpRequest</code>, que hace una
      petición al servidor, y crea un evento que se dispara en el
      navegador cuando se produce la respuesta. Puede haber varias
      peticiones de este estilo funcionando simultáneamente, de forma
      que el navegador se comporta, en realidad, como si se tratara de
      un interfaz de usuario. </p>

<p>Un programa AJAX, por tanto, tiene dos partes. La parte servidor
  se suele programar habitualmente para que responda a un interfaz
  REST, pero esto es simplemente una convención. Podíamos, por
  ejemplo, usar los programas que hemos visto anteriormente</p>

<p>En cuanto al cliente, hay que tener en cuenta que únicamente se
  pueden hacer peticiones al mismo dominio desde el que se ha
  descargado la página en la que se haya inserto. Es decir, sólo
  puedes hacer peticiones a <code>dominio.com</code> desde páginas que te hayas
  descargado desde <code>dominio.com</code>. Por eso es importante que el sistema
  que tenga el <a href='#API'>API</a> REST sea capaz también de servir las páginas; es lo
  que vamos a hacer en el siguiente ejemplo. Necesitaremos tres
  ficheros para ejecutar el programa. El primero es el <a href="https://github.com/JJ/curso-js/tree/master/code/count-server.js">servidor en node.js</a>: 
<code class="ejemplo"><span class="hl kwa">var</span> fs <span class="hl opt">=</span> <span class="hl kwd">require</span><span class="hl opt">(</span><span class="hl str">'fs'</span><span class="hl opt">);</span>
<span class="hl kwa">var</span> express<span class="hl opt">=</span><span class="hl kwd">require</span><span class="hl opt">(</span><span class="hl str">'express'</span><span class="hl opt">);</span>
<span class="hl kwa">var</span> app <span class="hl opt">=</span> express<span class="hl opt">();</span>
<span class="hl kwa">var</span> contadores <span class="hl opt">=</span> <span class="hl kwa">new</span> Array<span class="hl opt">;</span>
<span class="hl kwa">var</span> portada <span class="hl opt">=</span> fs<span class="hl opt">.</span><span class="hl kwd">readFileSync</span><span class="hl opt">(</span><span class="hl str">'sumar_formulario.html'</span><span class="hl opt">,</span><span class="hl str">'utf8'</span><span class="hl opt">);</span>

app<span class="hl opt">.</span><span class="hl kwd">get</span><span class="hl opt">(</span><span class="hl str">'/'</span><span class="hl opt">,</span> <span class="hl kwa">function</span> <span class="hl opt">(</span>req<span class="hl opt">,</span> res<span class="hl opt">) {</span> 
    res<span class="hl opt">.</span><span class="hl kwd">send</span><span class="hl opt">(</span>portada<span class="hl opt">);</span>
<span class="hl opt">});</span>

app<span class="hl opt">.</span><span class="hl kwd">get</span><span class="hl opt">(</span><span class="hl str">'/js/:page'</span><span class="hl opt">,</span> <span class="hl kwa">function</span> <span class="hl opt">(</span>req<span class="hl opt">,</span> res<span class="hl opt">) {</span> 
    <span class="hl kwa">var</span> js <span class="hl opt">=</span> fs<span class="hl opt">.</span><span class="hl kwd">readFileSync</span><span class="hl opt">(</span>req<span class="hl opt">.</span>params<span class="hl opt">.</span>page<span class="hl opt">);</span>
    res<span class="hl opt">.</span><span class="hl kwd">contentType</span><span class="hl opt">(</span><span class="hl str">'text/javascript'</span><span class="hl opt">);</span>
    res<span class="hl opt">.</span><span class="hl kwd">send</span><span class="hl opt">(</span>js<span class="hl opt">);</span>
<span class="hl opt">});</span>

app<span class="hl opt">.</span><span class="hl kwd">put</span><span class="hl opt">(</span><span class="hl str">'/contador/:id'</span><span class="hl opt">,</span> <span class="hl kwa">function</span><span class="hl opt">(</span> req<span class="hl opt">,</span>res <span class="hl opt">) {</span>
    contadores<span class="hl opt">[</span>req<span class="hl opt">.</span>params<span class="hl opt">.</span>id<span class="hl opt">] =</span> <span class="hl num">0</span><span class="hl opt">;</span>
    res<span class="hl opt">.</span><span class="hl kwd">send</span><span class="hl opt">(</span><span class="hl str">'Creado contador '</span><span class="hl opt">+</span> req<span class="hl opt">.</span>params<span class="hl opt">.</span>id <span class="hl opt">);</span>
<span class="hl opt">});</span>

app<span class="hl opt">.</span><span class="hl kwd">post</span><span class="hl opt">(</span><span class="hl str">'/contador/:id'</span><span class="hl opt">,</span> <span class="hl kwa">function</span> <span class="hl opt">(</span>req<span class="hl opt">,</span> res<span class="hl opt">) {</span>   
    contadores<span class="hl opt">[</span>req<span class="hl opt">.</span>params<span class="hl opt">.</span>id<span class="hl opt">]++;</span>
    res<span class="hl opt">.</span><span class="hl kwd">contentType</span><span class="hl opt">(</span><span class="hl str">'application/json'</span><span class="hl opt">);</span>
    res<span class="hl opt">.</span><span class="hl kwd">send</span><span class="hl opt">( {</span> resultado<span class="hl opt">:</span>  contadores<span class="hl opt">[</span>req<span class="hl opt">.</span>params<span class="hl opt">.</span>id<span class="hl opt">] } );</span>
    console<span class="hl opt">.</span><span class="hl kwd">log</span><span class="hl opt">( {</span> <span class="hl str">'Post'</span><span class="hl opt">:</span>  contadores<span class="hl opt">} );</span>
<span class="hl opt">});</span>

app<span class="hl opt">.</span><span class="hl kwd">get</span><span class="hl opt">(</span><span class="hl str">'/contador/:id'</span><span class="hl opt">,</span> <span class="hl kwa">function</span> <span class="hl opt">(</span>req<span class="hl opt">,</span> res<span class="hl opt">) {</span>   
    res<span class="hl opt">.</span><span class="hl kwd">contentType</span><span class="hl opt">(</span><span class="hl str">'application/json'</span><span class="hl opt">);</span>
    res<span class="hl opt">.</span><span class="hl kwd">send</span><span class="hl opt">(</span> <span class="hl str">"{ 'resultado': "</span> <span class="hl opt">+</span> contadores<span class="hl opt">[</span>req<span class="hl opt">.</span>params<span class="hl opt">.</span>id<span class="hl opt">] +</span> <span class="hl str">"}</span><span class="hl esc">\n</span><span class="hl str">"</span> <span class="hl opt">);</span>
<span class="hl opt">});</span>


app<span class="hl opt">.</span><span class="hl kwd">get</span><span class="hl opt">(</span><span class="hl str">'/suma/:id1/:id2'</span><span class="hl opt">,</span> <span class="hl kwa">function</span> <span class="hl opt">(</span>req<span class="hl opt">,</span> res<span class="hl opt">) {</span>   
    res<span class="hl opt">.</span><span class="hl kwd">send</span><span class="hl opt">( {</span> resultado<span class="hl opt">:</span> contadores<span class="hl opt">[</span>req<span class="hl opt">.</span>params<span class="hl opt">.</span>id1<span class="hl opt">] +</span>  contadores<span class="hl opt">[</span>req<span class="hl opt">.</span>params<span class="hl opt">.</span>id2<span class="hl opt">]} );</span>
<span class="hl opt">});</span>

app<span class="hl opt">.</span><span class="hl kwd">listen</span><span class="hl opt">(</span><span class="hl num">8080</span><span class="hl opt">);</span>
console<span class="hl opt">.</span><span class="hl kwd">log</span><span class="hl opt">(</span><span class="hl str">'Server running at http://127.0.0.1:8080/'</span><span class="hl opt">);</span>
</code>

</p><p>Este código es similar al que hemos usado anteriormente, salvo 
que
  respondemos a más comandos REST: GET, PUT y POST. PUT crea el
  contador, POST lo incrementa y finalmente GET obtiene el
  resultado; recordemos que GET debe ser idempotente y dejar al servidor
 en el mismo estado. Estos dos últimos, además, devuelven el resultado 
en
  JSON, y no en texto. Lo normal sería que entendieran varios formatos
  (incluyendo texto y HTML), pero por lo pronto lo dejaremos así.</p>

<p>También hay que tener en cuenta que este servidor tiene que
  servir <em>todos</em> los ficheros, no sólo el <a href='#API'>API</a> REST. Por eso se
  ha creado otro seudo-comando que lee un fichero y lo sirve como
  JS. Ojo, este tipo de órdenes son un potencial hueco de
  seguridad. Lo dejamos así por simplicidad, no porque sea la forma adecuada que debería tener una aplicación en producción.</p>

  <p>La <a href="https://github.com/JJ/curso-js/tree/master/code/sumar_formulario.html">página web</a> incluye
    lo mínimo necesario: el script JS incluido y un formulario para
    solicitar el nombre del contador que se va a incrementar. El URL
    del formulario incluye el "camino" ficticio al que responderá el
    servidor REST, que incluye <code>js</code>. Ese fichero, precisamente, es el
    que vemos aquí:</p>

<code class="ejemplo"><span class="hl kwa">function</span> <span class="hl kwd">cuenta</span><span class="hl opt">() {</span>
  request <span class="hl opt">=</span> <span class="hl kwa">new</span> <span class="hl kwd">XMLHttpRequest</span><span class="hl opt">();</span>
  <span class="hl kwa">var</span> contador<span class="hl opt">=</span>document<span class="hl opt">.</span><span class="hl kwd">getElementById</span><span class="hl opt">(</span><span class="hl str">'contador'</span><span class="hl opt">).</span>value<span class="hl opt">;</span>
  <span class="hl kwa">var</span> peticion_str <span class="hl opt">=</span> <span class="hl str">'/contador/'</span><span class="hl opt">+</span>contador<span class="hl opt">;</span>
  request<span class="hl opt">.</span><span class="hl kwd">open</span><span class="hl opt">(</span><span class="hl str">'POST'</span><span class="hl opt">,</span> peticion_str <span class="hl opt">,</span> <span class="hl kwa">true</span><span class="hl opt">);</span>
  request<span class="hl opt">.</span>onreadystatechange<span class="hl opt">=</span> escribe_resultado <span class="hl opt">;</span>
  request<span class="hl opt">.</span><span class="hl kwd">send</span><span class="hl opt">(</span><span class="hl kwa">null</span><span class="hl opt">);</span>
<span class="hl opt">}</span>

<span class="hl kwa">function</span> <span class="hl kwd">escribe_resultado</span><span class="hl opt">(){</span>
  <span class="hl kwa">if</span> <span class="hl opt">(</span> request<span class="hl opt">.</span>readyState <span class="hl opt">==</span> <span class="hl num">4</span> <span class="hl opt">) {</span>
    <span class="hl kwa">if</span> <span class="hl opt">(</span> request<span class="hl opt">.</span>status <span class="hl opt">==</span> <span class="hl num">200</span> <span class="hl opt">) {</span>
	<span class="hl kwa">var</span> json<span class="hl opt">;</span>
	<span class="hl kwd">eval</span> <span class="hl opt">(</span> <span class="hl str">'json = '</span><span class="hl opt">+</span> request<span class="hl opt">.</span>responseText <span class="hl opt">);</span>
	console<span class="hl opt">.</span><span class="hl kwd">log</span><span class="hl opt">(</span>json<span class="hl opt">);</span>
	document<span class="hl opt">.</span><span class="hl kwd">getElementById</span><span class="hl opt">(</span><span class="hl str">'Resultado'</span><span class="hl opt">).</span>innerHTML<span class="hl opt">=</span> <span class="hl str">'Resultado = '</span><span class="hl opt">+</span> 
	    json<span class="hl opt">.</span>resultado
    <span class="hl opt">}</span>
  <span class="hl opt">}</span>
<span class="hl opt">}</span>
</code>

<p>Por lo pronto vemos cómo funciona en JS "clásico", para entender un
  poco mejor el mecanismo que sigue. Luego más adelante veremos que en
  JQuery se puede hacer de forma mucho más simple. El código tiene dos
  funciones: la que hace la llamada (<code>cuenta</code>) y la que responde a la
  misma, el callback (<code>escribe_resultado</code>). La primera construye el
  URL y hace la petición POST para incrementar el contador, y con
  <code>onreadystatechange</code> establece la llamada para cuando llegue
  asíncronamente el resultado.</p>

<p>Esta segunda función recibe el JSON y usa un simple evaluador para
  extraer su resultado, previa comprobación de que efectivamente se ha
  recibido la respuesta completa y de forma efectiva; la respuesta la
  escribe en un <code>div</code>. </p>

<p>Para hacer funcionar este programa tendremos que crear previamente
  los contadores usando  cualquier otro programa</p>

<p>En realidad, es mucho más fácil hacerlo con
  JQuery. En <a href="http://codeko.com/docs/oslgr/intro_jquery/ajax2.php">esta
    web de Codeko</a> muestran como funcionan las órdenes
  básicas. El <a href="https://github.com/JJ/curso-js/tree/master/code/formulario-jquery.html">formulario
    sería bastante similar</a>, aunque hemos tenido
  que <a href="https://github.com/JJ/curso-js/tree/master/code/count-server-var.js">modificar el servidor para
    que muestre diferentes páginas principales</a>. El principal
  cambio será, obviamente, en el código usado para la solicitud Ajax,
  que usará jQuery en vez de JS
  puro. <a href="https://github.com/JJ/curso-js/tree/master/code/cuenta-jquery.js">Helo aquí</a>:</p>
<code class="ejemplo">$<span class="hl opt">(</span>document<span class="hl opt">).</span><span class="hl kwd">ready</span><span class="hl opt">(</span><span class="hl kwa">function</span><span class="hl opt">() {</span>
	$<span class="hl opt">(</span><span class="hl str">"#formulario"</span><span class="hl opt">).</span><span class="hl kwd">change</span><span class="hl opt">(</span><span class="hl kwa">function</span><span class="hl opt">(){</span>
		$<span class="hl opt">.</span><span class="hl kwd">get</span><span class="hl opt">(</span><span class="hl str">'/contador/'</span><span class="hl opt">+</span>$<span class="hl opt">(</span><span class="hl str">'#contador'</span><span class="hl opt">).</span><span class="hl kwd">val</span><span class="hl opt">(),</span> <span class="hl kwa">function</span><span class="hl opt">(</span> data<span class="hl opt">) {</span>
			  $<span class="hl opt">(</span><span class="hl str">'#Resultado'</span><span class="hl opt">).</span><span class="hl kwd">html</span><span class="hl opt">(</span><span class="hl str">'Resultado '</span><span class="hl opt">+</span> data<span class="hl opt">.</span>resultado<span class="hl opt">);</span>
		      <span class="hl opt">});</span>
	<span class="hl opt">});</span>
	<span class="hl opt">} );</span> </code>

<p>Este pequeño programa tiene todo lo compacto y críptico a lo que
  nos tiene acostumbrados jQuery. Como es habitual, se ejecuta sólo
  cuando se ha cargado la página y usa el programa para añadir
  funcionalidad, eventos, al HTML en vez de tener el propio evento
  definido en el mismo; lo clásico en JS (y jQuery) es dividir el
  código de la funcionalidad. Lo que hace es que crea un evento sobre
  el formulario tal que al cambiar llame a una función anónima.</p>

<p>Esa función, en un par de líneas, hace lo mismo que previamente con
  unas cuantas líneas en JS: hace una petición <code>get</code> (en la que usa
  también los selectores jQuery para extraer el valor, contenido en
  $val()$, del elemento del formulario) y una vez obtenido el
  resultado usa el selector del elemento correspondiente,
  <code>#Resultado</code>, para insertarlo. Adicionalmente, jQuery esconde el
  mecanismo subyacente de llamada haciéndolo independiente del
  navegador. Si XMLHttpRequest funciona, lo usa; si no, usa el
  mecanismo nativo. </p>


<h3> Más allá del Ajax </h3>

 

<p>Ajax permite trabajar con el servidor de forma asíncrona, pero
  siempre que sea el cliente el que comience la conexión.  En muchos
  casos puede que no sea la forma más eficiente de trabajar con él,
  porque se tienen que hacer peticiones de forma periódica y porque
  puede haber picos en los que se sature el mismo. Por eso hay métodos
  para que sea el servidor el que inicie, o al menos envíe información
  al cliente; a esto se le le suele llamar tecnologías <em>push</em> (desde
  el punto de vista del servidor) y <a href="http://en.wikipedia.org/wiki/Comet_%28programming%29">Comet</a> desde el punto de
  vista del cliente. </p>

<p>La idea, por tanto, es que tras el comienzo de una conexión por
  parte del cliente, sea el servidor el que continúe enviando
  información al mismo, sin cerrarla. Hay diferentes formas de
  hacerlo: mediante streaming y utilizando lo que se denomina <em>long
  polling</em> .</p>

<p>Lo anterior se suele implementar con una serie de tecnologías ad
  hoc, que tratan de evitar los modelos de seguridad del cliente de
  diferentes formas. Pero hay un estándar emergente
  denominado <a href="http://en.wikipedia.org/wiki/WebSocket">WebSocket</a>
  que es simplemente una conexión TCP bidireccional entre cliente y
  servidor, el equivalente en el navegador de un Socket
  tradicional. Actualmente no todos los navegadores admiten todos los
  tipos de conexión propuestos; se trata de un estándar en evolución
  que se ha implementado a partir de 2012.</p>

  <p>Para usarlo ya se puede probar con librerías
  como <a href="http://socket.io/#how-to-use">socket.io</a>, que
  proporcionan todas las facilidades de WebSocket mediante la conexión
    que esté disponible en el navegador.</p>


<p>Un ejemplo de como usar estas librerías está
  en <a href="http://project70.com/nodejs/node-js-comet-real-time-chat-a-great-first-project/">este
    tutorial</a> que  muestra como llevar a cabo un chat en tiempo
  real usando node.js.</p>

<h3> A dónde ir desde aquí</h3>


<p>Se puede ir a <a href="http://geneura.ugr.es/%7Ejmerelo/asignaturas/AAP/AAP-CouchDB.mhtml">aprender el uso de
    un sistema de almacenamiento de objetos llamado CouchDB</a>, pero
    el tema de diseño de sistemas con node.js y JQuery en el cliente
    puede ir mucho más allá, usando, por
    ejemplo <a href="http://sailsjs.org">marcos MVC para
    node.js como Sails.js</a>
    o <a href="http://stackoverflow.com/questions/9744798/which-nodejs-mvc-framework-currently-has-the-best-mix-of-maturity-and-ease-of-us">cualquier
    otro de los recomendados.</a></p>

<p>jQuery también admite todo tipo de plugins, y muchos de ellos se
  pueden usar
  con <a href="http://malsup.com/jquery/form/">formularios</a>
  haciendo su procesamiento mucho más rápido. Siempre hay una forma
  más simple de hacer las cosas y posiblemente hay software libre
  para solucionarlo.</p>

<h3> Bibliografía y enlaces</h3>


<p>En general, REST se considera, de forma amplia, dentro de los
  servicios Web, por eso los libros que trabajan con él, en general,
  también incluyen capítulos que tratan con REST. Sin embargo, si quieres usar un lenguaje de programación
      determinado,  te puede venir
  bien <a href="http://www.amazon.com/gp/product/0596002068?ie=UTF8&amp;tag=perltutobyjjmere&amp;link_code=as3&amp;camp=211189&amp;creative=373489&amp;creativeASIN=0596002068">Programming
  Web Services with Perl, de Ray y Kuchenko</a>. Es quizás un poco más
  prolijo en el apartado XML de la cuenta, y está un tanto atrasado,
  pero vienen todos los módulos de Perl bien detallados y
  explicados. El <a href="https://www.amazon.es/dp/B0043D2ESQ/ref=as_li_ss_til?tag=atalaya-21&amp;camp=3634&amp;creative=24822&amp;linkCode=as4&amp;creativeASIN=B0043D2ESQ&amp;adid=1V5KDS1RVBZAE2W5B2PR&amp;">RESTful
      Web Services Cookbook</a> también es bastante útil en este
  sentido. </p>


<h2>Glosario</h2>


<h3 name='API'>API</h3>

<em>Application programming interface</em>, conjunto de órdenes que se
usan para interactuar con una aplicación a través de la llamada a una
serie de funciones. En un interfaz <a href='#RESTful' >RESTful'</a>
las llamadas a funciones son URLs a las que se les puede pasar, de
forma adicional, parámetros en forma de estructuras de datos
codificadas, generalmente, en JSON o XML y que se recibirán por
entrada estándar al modo <a href='#CGI'>CGI</a>.

<h3 name='CGI'>CGI</h3>

En el contexto de la web, <a href='http://www.w3.org/CGI/'>CGI</a>
significa <em>Common Gateway Interface</em>, o interfaz de enlace
común; es un método para ejecutar programas desde un servidor web que
consiste en codificar las entradas al programa en entrada estándar
(como si los leyera desde teclado) y en variables de entorno (como si
desde la línea de comandos definiéramos una serie de variables) y
entregar la salida por entrada estándar. El servidor web ejecuta el
programa, definiendo variables de entorno y proporcionándole la
entrada, y recibe la salida que envía al quien ha solicitado el URL.

<h3 name='HTTP'>HTTP</h3>

<a href='http://es.wikipedia.org/wiki/Http'>HTTP o Hypertext Transfer
  Protocol, protocolo de transferencia hipertexto</a>, es el protocolo
  usado en toda la web y que rige la forma como se solicitan recursos
  a un servidor web, cómo se sirven y cómo se indican errores
  sucedidos en el mismo. Durante mucho tiempo, el servidor web por
excelencia ha sido <a href='http://httpd.apache.org'>Apache</a>, pero
  hoy en día es muy habitual la creación de aplicaciones en torno a
  servidores HTTP integrados, como en node.js o en entornos MVC como
  Django. 


<h3 name='PaaS'>PaaS</h3>

<a href='http://es.wikipedia.org/wiki/PaaS#Plataforma_como_servicio'>Platform
  as a Service, o Plataforma como Servicio</a>, es un producto que
  integra una máquina virtual provisionada con una serie de
  aplicaciones de tal forma que sólo hay que subir el código que usa
  esa aplicación. Básicamente se trata de usar servicios en la nube
  sin necesidad de instalar y configurar los programas
  necesarios. Estos PaaS pueden ir desde lo más básico, una simple
  base de datos, hasta integrar pilas completas de servicios que
permitan desplegar, por ejemplo, una aplicación <code>node.js</code> o
  Django.

<h3 name='REST'>REST</h3>

<a href='http://es.wikipedia.org/wiki/Representational_State_Transfer'>REST</a>
significa transferencia de estado que representa algo (por no traducir
representacional, que suena fatal). Es una convención para el diseño
de <a href='#API'>API</a>s que consiste en usar los verbos del protocolo <a href='#HTTP'>HTTP</a> y su
significado estricto para llevar a cabo todas las operaciones de un
programa. 

<h3 name='RESTful'>RESTful</h3>

<a href='#API'>API</a> diseñada siguiendo las convenciones <a href='#REST'>REST</a>. 

<h2>Licencia</h2>

<a rel="license" href="http://creativecommons.org/licenses/by-sa/4.0/"><img alt="Licencia Creative Commons" style="border-width:0" src="http://i.creativecommons.org/l/by-sa/4.0/88x31.png" /></a><br /><span xmlns:dct="http://purl.org/dc/terms/" href="http://purl.org/dc/dcmitype/Text" property="dct:title" rel="dct:type">Introducción a JavaScript</span> por <a xmlns:cc="http://creativecommons.org/ns#" href="http://amzn.to/1gzEaMD" property="cc:attributionName" rel="cc:attributionURL">JJ Merelo</a> se distribuye bajo una <a rel="license" href="http://creativecommons.org/licenses/by-sa/4.0/">Licencia Creative Commons Atribución-CompartirIgual 4.0 Internacional</a>.<br />Basada en una obra en <a xmlns:dct="http://purl.org/dc/terms/" href="http://github.com/JJ/curso-js" rel="dct:source">http://github.com/JJ/curso-js</a>.

  </body>
</html>




